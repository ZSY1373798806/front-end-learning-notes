## å“åº”å¼æ¡†æ¶åŸºæœ¬åŸç†

> ç›´è§‚ä¸Šï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸å†éœ€è¦å¼€å‘è€…æ‰‹åŠ¨æ›´æ–°è§†å›¾ï¼Œè€Œè§†å›¾ä¼šæ ¹æ®å˜åŒ–çš„æ•°æ®è‡ªåŠ¨è¿›è¡Œæ›´æ–°ã€‚

### æ­¥éª¤

1. #### ä¾èµ–æ”¶é›†

2. #### æ•°æ®åŠ«æŒä¸ä»£ç†

3. #### å‘å¸ƒè®¢é˜…æ¨¡å¼

### å®ç°

### æ•°æ®åŠ«æŒä¸ä»£ç†

```javascript
const data = {
  stage: 'gitChat',
  course: {
    title: 'å‰ç«¯å¼€å‘è¿›é˜¶',
    author: 'å¼ ä¸‰',
    publishTime: '2020-08-05',
    keywords: ['js', 'æ•°æ®ç»“æ„']
  }
}
```

#### Object.defineProperty()

```javascript
const observe = data => {
  if (!data || typeof data !== 'object') {
    return
  }
  Object.keys(data).forEach(key => {
    let currentValue = data[key]
    Object.defineProperty(data, key, {
      enumerable: true,
      configurable: false,
      get() {
        console.log(`getting ${key} value now, getting value is: `,currentValue)
        return currentValue
      },
      set(newValue) {
        currentValue = newValue
        console.log(`setting ${key} value now, setting value is: `,currentValue)
      }
    })
    // é€’å½’éå†ï¼Œå®ç°æ·±å±‚æ•°æ®æ‹¦æˆª
    observe(currentValue)
  })
}
observe(data)
```

```javascript
data.stage
// getting stage value now, getting value is:  gitChat
```

```javascript
data.stage = 'github'
// setting stage value now, setting value is:  github
```

```javascript
data.course.title = 'æ•°æ®åŠ«æŒ'
// getting course value now, getting value is:  {...}
// setting title value now, setting value is:  æ•°æ®åŠ«æŒ
```

```javascript
data.course.keywords.push('ç®—æ³•')
// getting course value now, getting value is:  {...}
// getting keywords value now, getting value is:  [ [Getter/Setter], [Getter/Setter] ]
```

> æˆ‘ä»¬ç›‘å¬åˆ°äº†data.stageå’Œdata.course.titleçš„è¯»å†™ï¼Œä»¥åŠdata.course.keywordsæ•°ç»„çš„è¯»å–ï¼›
>
> è€Œæ•°ç»„çš„pushè¡Œä¸ºå¹¶æ²¡æœ‰è¢«æ‹¦æˆªï¼›
>
> è¿™æ˜¯å› ä¸ºArray.prototypeä¸ŠæŒ‚è½½çš„æ–¹æ³•ä¸èƒ½è§¦å‘data.course.keywordså±æ€§å€¼çš„setterï¼Œè¿™ä¸å±äºèµ‹å€¼æ“ä½œï¼Œè€Œæ˜¯push APIçš„è°ƒç”¨æ“ä½œã€‚

###### Vueä¹Ÿå­˜åœ¨åŒæ ·çš„é—®é¢˜

> è§£å†³æ–¹æ³•ï¼šå°†æ•°ç»„çš„å¸¸ç”¨æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œè¦†ç›–æ‰åŸç”Ÿçš„æ•°ç»„æ–¹æ³•ï¼›
>
> é‡å†™ä¹‹åçš„æ•°ç»„æ–¹æ³•éœ€è¦èƒ½å¤Ÿè¢«æ‹¦æˆªã€‚

å®ç°ï¼š

```javascript
const arrExtend = Object.create(Array.prototype)
const arrMethods = ['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse']
arrMethods.forEach(method => {
  const oldMethod = Array.prototype[method]
  const newMethod = function(...args) {
    oldMethod.apply(this, args)
    console.log(`${method} æ–¹æ³•è¢«æ‰§è¡Œäº†`)
  }
  arrExtend[method] = newMethod
})
Array.prototype = Object.assign(Array.prototype, arrExtend)
```

```javascript
let array = [1,2,3]
array.push(4)
// push æ–¹æ³•è¢«æ‰§è¡Œäº†
```

> å¯¹æ•°ç»„çš„7ä¸ªæ–¹æ³•è¿›è¡Œé‡å†™ï¼›
>
> æ ¸å¿ƒæ“ä½œè¿˜æ˜¯è°ƒç”¨åŸç”Ÿæ–¹æ³•ï¼šoldMethod.apply(this, args)ï¼›
>
> ä¹Ÿå¯ä»¥åœ¨è°ƒç”¨oldMethod.apply(this, args)å‰åæ’å…¥ä»»ä½•æˆ‘ä»¬éœ€è¦çš„ä»£ç é€»è¾‘ã€‚

#### Proxyå®ç°

```javascript
const observe = data => {
  if (!data || Object.prototype.toString.call(data) !== '[object Object]') {
    return
  }
  Object.keys(data).forEach(key => {
    let currentValue= data[key]
    if (typeof currentValue === 'object') {
      data[key] = new Proxy(currentValue, {
        set(target, property, value, receiver) {
          // æ•°ç»„çš„pushä¼šå¼•èµ·lengthå±æ€§å˜åŒ–ï¼Œpushåä¼šè§¦å‘ä¸¤æ¬¡setæ“ä½œï¼›
          // åªéœ€ä¿ç•™ä¸€æ¬¡å³å¯ï¼Œprototypeä¸ºlengthæ—¶å¿½ç•¥
          if (property !== 'length') {
            console.log(`setting ${key} value now, setting value is`, value)
          }
          return Reflect.set(target, property, value, receiver)
        }
      })
      observe(currentValue)
    } else {
      Object.defineProperty(data, key, {
        enumerable: true,
        configurable: false,
        get() {
          console.log(`getting ${key} value now, setting value is`, currentValue)
          return currentValue
        },
        set(newValue) {
          console.log(`setting ${key} value now, setting value is `, newValue)
          currentValue = newValue
        }
      })
    }
  })
}
observe(data)
```

```javascript
data.stage
// getting stage value now, setting value is gitChat
```

```javascript
data.stage = 'github'
// setting stage value now, setting value is  github
```

```javascript
data.course.title
// getting title value now, setting value is å‰ç«¯å¼€å‘è¿›é˜¶
```

```javascript
data.course.title = 'æ•°æ®åŠ«æŒ'
// setting course value now, setting value is æ•°æ®åŠ«æŒ
// setting title value now, setting value is  æ•°æ®åŠ«æŒ
```

```javascript
data.course.keywords.push('ç®—æ³•')
// setting keywords value now, setting value is ç®—æ³•
```

> ä½¿ç”¨Proxyå®ç°ä»£ç†ï¼›
>
> æ•°æ®é”®å€¼ä¸ºåŸºæœ¬ç±»å‹æ—¶ï¼Œä¾æ—§ä½¿ç”¨Object.defineProperty()ï¼›
>
> å¯¹äºé”®å€¼ä¸ºå¯¹è±¡ç±»å‹çš„ï¼Œä½¿ç”¨Proxyè¿”å›çš„æ–°å¯¹è±¡ç»™data[key]é‡æ–°èµ‹å€¼ï¼Œè¿™ä¸ªæ–°å€¼å¾—getterå’Œsetterå°†ä¼šè¢«æ·»åŠ ä»£ç†ï¼›å¹¶è¿›è¡Œé€’å½’è°ƒç”¨ã€‚

##### Object.defineProperty && Proxy

- ###### Object.defineProperty

  - ä¸èƒ½ç›‘å¬æ•°ç»„çš„å˜åŒ–ï¼Œéœ€è¦è¿›è¡Œæ•°ç»„æ–¹æ³•çš„é‡å†™ï¼›
  - å¿…é¡»éå†å¯¹è±¡çš„æ¯ä¸ªå±æ€§ï¼Œä¸”å¯¹äºåµŒå¥—ç»“æ„éœ€è¦æ·±å±‚éå†ï¼›
  - ä¸å†æ˜¯ä¼˜åŒ–é‡ç‚¹ã€‚

- ###### Proxy

  - ä»£ç†æ˜¯é’ˆå¯¹æ•´ä¸ªå¯¹è±¡çš„ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼›
  - åªéœ€è¦åšä¸€å±‚ä»£ç†å°±å¯ä»¥ç›‘å¬åŒçº§ç»“æ„ä¸‹çš„æ‰€æœ‰å±æ€§å˜åŒ–ï¼Œå¯¹äºæ·±å±‚ç»“æ„ï¼Œè¿˜æ˜¯éœ€è¦é€’å½’è¿›è¡Œï¼›
  - æ”¯æŒä»£ç†æ•°ç»„çš„å˜åŒ–
  - ç¬¬äºŒä¸ªå‚æ•°handlerå¯¹è±¡é™¤äº†getå’Œsetå¤–ï¼Œå¯ä»¥æœ‰13ç§æ‹¦æˆªæ–¹æ³•ï¼Œæ›´åŠ å¼ºå¤§ï¼›
  - æ€§èƒ½å°†ä¼šè¢«åº•å±‚æŒç»­ä¼˜åŒ–ã€‚

### æ¨¡æ¿ç¼–è¯‘å®ç°

â€‹		å®ç°

â€‹		ä½¿ç”¨æ­£åˆ™+éå†ï¼Œå¯¹#appèŠ‚ç‚¹ä¸‹çš„å†…å®¹è¿›è¡Œæ›¿æ¢ï¼Œé€šè¿‡æ­£åˆ™è¯†åˆ«å‡ºæ¨¡æ¿å˜é‡ï¼Œè·å–å¯¹åº”çš„æ•°æ®ã€‚

- æ¡ˆä¾‹1

```javascript
const data = {
  stage: 'gitChat',
  course: {
    title: 'å‰ç«¯å¼€å‘è¿›é˜¶',
    author: 'å¼ ä¸‰',
    publishTime: '2020-08-05',
    keywords: ['js', 'æ•°æ®ç»“æ„'],
  }
}
```

```html
<div id="app">
  <div>å‘å¸ƒå¹³å°ï¼š{{stage}}</div>
  <div>å‘å¸ƒè¯¾ç¨‹ï¼š{{course.title }}</div>
  <div>å‘å¸ƒäººï¼š{{ course.author}}</div>
  <div>å‘å¸ƒæ—¶é—´ï¼š{{ course.publishTime   }}</div>
  <div>å…³é”®å­—ï¼š{{ course.keywords   }}</div>
</div>
```

![image-20210416230103348](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210416230128363.png)

```javascript
function compile(el, data) {
  // åˆ›å»ºæ–‡æ¡£ç¢ç‰‡
  let fragment = document.createDocumentFragment()
  while (child = el.firstChild) {
    fragment.appendChild(child)
  }
  // å¯¹elé‡Œé¢çš„å†…å®¹è¿›è¡Œæ›¿æ¢
  function replace(fragment) {
    // éå†èŠ‚ç‚¹
    Array.from(fragment.childNodes).forEach(node => {
      let textContent = node.textContent
      // æ­£åˆ™åŒ¹é… {{ xxxx }}
      let reg = /\{\{\s*(.*?)\s*\}\}/g
      if (node.nodeType === 3 && reg.test(textContent)) {
        const nodeTextContent = node.textContent
        const replaceText = () => {
          /**
                 * str.replace(reg, (param1, param2, param3, param4) => {...})
                 * regï¼šæ­£åˆ™è¡¨è¾¾å¼ /\{\{\s*(.*?)\s*\}\}/g
                 * param1ï¼šåŒ¹é…åˆ°çš„å­—ç¬¦ä¸² "{{stage}}"
                 * param2ï¼šå¯¹åº”æ›¿æ¢çš„å­—ç¬¦ä¸² "stage"
                 * param3ï¼šæ›¿æ¢çš„ä½ç½® 5
                 * param4ï¼šæ•´ä¸ªè¦æ›¿æ¢çš„å­—ç¬¦ä¸² "å‘å¸ƒå¹³å°ï¼š{{stage}}"
                 */
          node.textContent = nodeTextContent.replace(reg, (matched, placeholder, param3, param4) => {
            const str = placeholder.split('.').reduce((prev, key) => {
              return prev[key]
            }, data)
            return str
          })
        }
        replaceText()
      }
      // å¦‚æœè¿˜æœ‰å­èŠ‚ç‚¹ï¼Œç»§ç»­é€’å½’replace
      if (node.childNodes && node.childNodes.length) {
        replace(node)
      }
    })
  }
  replace(fragment)
  el.appendChild(fragment)
  return el
}
compile(document.querySelector('#app'), data)
```

![image-20210416230152400](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210416230152400.png)

> ä½¿ç”¨fragmentå˜é‡å­˜å‚¨ç”Ÿæˆçš„çœŸå®HTMLèŠ‚ç‚¹å†…å®¹ï¼›
>
> é€šè¿‡replaceæ–¹æ³•å¯¹{{ xxx }}è¿›è¡Œæ•°æ®æ›¿æ¢ï¼ŒåŒæ—¶{{ xxx }}çš„è¡¨è¾¾å¼åªä¼šå‡ºç°åœ¨nodeTypeä¸º3çš„æ–‡æœ¬ç±»å‹èŠ‚ç‚¹ä¸­ï¼›
>
> å› æ­¤å¯¹äºnode.nodeType===3&&reg.test(textContent)æ¡ä»¶çš„æƒ…å†µï¼Œè¿›è¡Œæ•°æ®è·å–å’Œå¡«å……ï¼›
>
> å€ŸåŠ©å­—ç¬¦ä¸²replaceæ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¸€æ¬¡æ€§æ›¿æ¢ï¼›
>
> å¯¹äº{{data.course.title}}ç­‰æ·±å±‚æ•°æ®ï¼Œé€šè¿‡reduceæ–¹æ³•ï¼Œè·å–æ­£ç¡®çš„å€¼ï¼›
>
> å¯¹äºå­˜åœ¨å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨é€’å½’è¿›è¡Œreplaceæ›¿æ¢ã€‚

### åŒå‘ç»‘å®šå®ç°

```html
<input v-model="stage"/>
```

![image-20210417221030137](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210417221030137.png)

```javascript
function compile(el, data) {
  // åˆ›å»ºæ–‡æ¡£ç¢ç‰‡
  let fragment = document.createDocumentFragment()
  while (child = el.firstChild) {
    fragment.appendChild(child)
  }
  // å¯¹elé‡Œé¢çš„å†…å®¹è¿›è¡Œæ›¿æ¢
  function replace(fragment) {
    // éå†èŠ‚ç‚¹
    Array.from(fragment.childNodes).forEach(node => {
      // ...
      // node.nodeType === 1 å…ƒç´ èŠ‚ç‚¹
      if (node.nodeType === 1) {
        let attributesArray = node.attributes
        Array.from(attributesArray).forEach(attr => {
          let attributeName = attr.name
          let attributeValue = attr.value
          console.log(Array.from(attributesArray), attributeName, attributeValue)
          if (attributeName.includes('v-')) {
            node.value = data[attributeValue]
            // console.log(eval(data))
          }
          node.addEventListener('input', e => {
            let newVal = e.target.value
            data[attributeValue] = newVal
            // ...
            // æ›´æ”¹æ•°æ®æºï¼Œè§¦å‘setter
            // ...
          })
        })
      }
      // å¦‚æœè¿˜æœ‰å­èŠ‚ç‚¹ï¼Œç»§ç»­é€’å½’replace
      if (node.childNodes && node.childNodes.length) {
        replace(node)
      }
    })
  }
  replace(fragment)
  el.appendChild(fragment)
  return el
}
compile(document.querySelector('#app'), data)
```

### å‘å¸ƒè®¢é˜…æ¨¡å¼

â€‹		äº‹ä»¶é©±åŠ¨ç†å¿µå³å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ˆPub/Subæ¨¡å¼ï¼‰ï¼›

â€‹		javascriptæœ¬èº«å°±æ˜¯äº‹ä»¶é©±åŠ¨å‹è¯­è¨€ï¼Œåº”ç”¨ä¸­çš„buttonè¿›è¡Œäº‹ä»¶ç»‘å®šï¼Œç‚¹å‡»åè§¦å‘clickäº‹ä»¶ã€‚

> ä¼˜ç‚¹ï¼šé«˜å†…èšã€ä½è€¦åˆã€‚

- #### ç®€å•æ¡ˆä¾‹

```javascript
class Notify {
  constructor() {
    // è®¢é˜…åˆ—è¡¨
    this.subscribers = []
  }
  // è®¢é˜…
  add(handler) {
    this.subscribers.push(handler)
  }
  //å‘å¸ƒ
  emit() {
    this.subscribers.forEach(subscriber => subscriber())
  }
}
const notify = new Notify()
notify.add(() => {
  console.log('emit here 1')
})
notify.add(() => {
  console.log('emit here 2')
})
notify.emit()
```

## ğŸ”¹ MVVM

**æ ¸å¿ƒæ€æƒ³ï¼šæ•°æ®é©±åŠ¨è§†å›¾ï¼Œè§†å›¾å˜åŒ–ä¹Ÿèƒ½åå‘é©±åŠ¨æ•°æ®ã€‚**

### å®ç°æ­¥éª¤

1. **æ•°æ®åŠ«æŒ**
   - ä½¿ç”¨ `Object.defineProperty`ï¼ˆVue2ï¼‰æˆ– `Proxy`ï¼ˆVue3ï¼‰åŠ«æŒæ•°æ®ã€‚
   - åœ¨ `getter` ä¸­è¿›è¡Œ **ä¾èµ–æ”¶é›†**ï¼ˆæ”¶é›† Watcherï¼‰ã€‚
   - åœ¨ `setter` ä¸­ **æ´¾å‘æ›´æ–°**ï¼ˆé€šçŸ¥è®¢é˜…è€…æ›´æ–°ï¼‰ã€‚
2. **æ¨¡æ¿ç¼–è¯‘**
   - æ‰«ææ¨¡æ¿ï¼Œè§£æ `{{}}`ã€`v-model`ã€`v-on` ç­‰æŒ‡ä»¤ã€‚
   - åœ¨æ›¿æ¢ `{{}}` çš„æ—¶å€™ï¼Œä¼šè§¦å‘æ•°æ®çš„ `getter`ï¼Œä»è€Œæ”¶é›†ä¾èµ–ã€‚
3. **ä¾èµ–æ”¶é›†**
   - Vue å†…éƒ¨ç”¨ä¸€ä¸ª **Depï¼ˆä¾èµ–ç®¡ç†å™¨ï¼‰** å­˜å‚¨æ‰€æœ‰ Watcherã€‚
   - æ¯ä¸ªå“åº”å¼å±æ€§å¯¹åº”ä¸€ä¸ª Depã€‚
   - å½“æ¨¡æ¿é‡ŒæŸä¸ªå±æ€§è¢«è®¿é—®æ—¶ï¼Œå°±æŠŠå½“å‰ Watcher æ·»åŠ åˆ° Dep é‡Œã€‚
4. **æ´¾å‘æ›´æ–°**
   - å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè§¦å‘ `setter`ã€‚
   - `setter` é€šçŸ¥å¯¹åº” Depï¼ŒDep é€šçŸ¥æ‰€æœ‰ Watcher æ‰§è¡Œæ›´æ–°é€»è¾‘ã€‚
   - Watcher æ›´æ–°è§†å›¾ã€‚

### æµç¨‹æ€»ç»“

- **è¯»æ•°æ® â†’ getter â†’ ä¾èµ–æ”¶é›†**
- **æ”¹æ•°æ® â†’ setter â†’ é€šçŸ¥ Watcher â†’ æ›´æ–°è§†å›¾**

------

## ğŸ”¹ è™šæ‹Ÿ DOM

**æ ¸å¿ƒæ€æƒ³ï¼šç”¨ JS å¯¹è±¡æ¨¡æ‹ŸçœŸå® DOMï¼Œç”¨ diff ç®—æ³•è®¡ç®—æœ€å°æ›´æ–°èŒƒå›´ï¼Œå†ä¸€æ¬¡æ€§æ›´æ–°åˆ° DOMã€‚**

### ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿ DOMï¼Ÿ

- æ“ä½œ DOM **å¾ˆæ…¢**ï¼ˆæµè§ˆå™¨é‡æ’/é‡ç»˜å¼€é”€å¤§ï¼‰ã€‚
- æ“ä½œ JS **å¾ˆå¿«**ã€‚
- é€šè¿‡ diff ç®—æ³•ï¼Œå¯ä»¥åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å…¨é‡æ›´æ–°ã€‚

### ç‰¹ç‚¹

1. **è™šæ‹ŸèŠ‚ç‚¹ç»“æ„**

   ```
   {
     tag: 'div',
     props: { id: 'app', class: 'container' },
     children: [
       { tag: 'span', children: ['hello'] }
     ]
   }
   ```

2. **diff ç®—æ³•**

   - æ·±åº¦ä¼˜å…ˆéå†ï¼Œé€å±‚æ¯”è¾ƒ oldVNode å’Œ newVNodeã€‚
   - æ‰¾å‡ºæœ€å°å·®å¼‚ï¼ˆå±æ€§å˜åŒ–ã€å­èŠ‚ç‚¹å˜åŒ–ã€èŠ‚ç‚¹æ›¿æ¢/åˆ é™¤ï¼‰ã€‚
   - ç”Ÿæˆ **patches**ï¼Œå†æ‰¹é‡åº”ç”¨åˆ°çœŸå® DOMã€‚

3. **æ”¶ç›Š**

   - é¿å…é¢‘ç¹æ“ä½œçœŸå® DOMã€‚
   - ç²¾å‡†æ›´æ–°æœ€å°åŒ– DOM æ”¹åŠ¨ã€‚
   - è®©è·¨å¹³å°ï¼ˆå¦‚ React Nativeã€å°ç¨‹åºæ¸²æŸ“ï¼‰æˆä¸ºå¯èƒ½ã€‚

##### æ¡ˆä¾‹1

DOMç»“æ„

```html
<ul id="chapterList">
  <li class="chapter">chapter1</li>
  <li class="chapter">chapter2</li>
  <li class="chapter">chapter3</li>
</ul>
```

é‡‡ç”¨javascriptå¯¹è±¡ç»“æ„è¡¨ç¤º

```javascript
const chapterListVirtualDom = {
  tagName: 'ul',
  attributes: { id: 'chapterList' },
  children: [
    {
      tagName: 'li',
      attributes: { class: 'chapter' },
      children: ['chapter1']
    },
    {
      tagName: 'li',
      attributes: { class: 'chapter' },
      children: ['chapter2']
    },
    {
      tagName: 'li',
      attributes: { class: 'chapter' },
      children: ['chapter3']
    },
  ]
}
```

> tagNameè¡¨ç¤ºè™šæ‹ŸDOMå¯¹åº”çœŸå®DOMçš„æ ‡ç­¾ç±»å‹ï¼›
>
> attributesæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºDOMèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å±æ€§ï¼›
>
> childrenå¯¹åº”çœŸå®DOMçš„childNodesï¼Œå…¶ä¸­childNodesçš„æ¯ä¸€é¡¹åˆæ˜¯ç±»ä¼¼çš„ç»“æ„ã€‚

#### è™šæ‹ŸDOMç”Ÿæˆç±»çš„å®ç°

â€‹	ç”¨äºç”Ÿæˆè™šæ‹ŸDOM

```javascript
class Element {
  constructor(tagName, attributes = {}, children = []) {
    this.tagName = tagName
    this.attributes = attributes
    this.children = children
  }
}
function element(tagName, attributes, children) {
  return new Element(tagName, attributes, children)
}
```

```javascript
const chapterListVirtualDom = element('ul', { id: 'chapterList' }, [
  element('li', { class: 'chapter' }, ['chapter1']),
  element('li', { class: 'chapter' }, ['chapter2']),
  element('li', { class: 'chapter' }, ['chapter3']),
])
console.log(chapterListVirtualDom)
// {
//   tagName: 'li',
//   attributes: { id: 'chapterList' },
//   children: [
//     { tagName: 'li', attributes: { class: 'chapter' }, children: ['chapter1'] },
//     { tagName: 'li', attributes: { class: 'chapter' }, children: ['chapter2'] },
//     { tagName: 'li', attributes: { class: 'chapter' }, children: ['chapter3'] }
//   ]
// }
```

#### å®ç°setAttributeæ–¹æ³•ï¼Œå¯¹DOMèŠ‚ç‚¹è¿›è¡Œå±æ€§è®¾ç½®

```javascript
const setAttribute = (node, key, value) => {
  switch (key) {
    case 'style':
      node.style.cssText = value
      break
    case 'value':
      let tagName = node.tagName || ''
      tagName = tagName.toLowerCase()
      if (tagName === 'input' || tagName === 'textarea') {
        node.value = value
      } else {
        node.setAttribute(key, value)
      }
      break
    default:
      node.setAttribute(key, value)
      break
  }
}
```

#### å®ç°Elementç±»çš„renderåŸå‹æ–¹æ³•ï¼Œæ ¹æ®è™šæ‹ŸDOMç”ŸæˆçœŸå®çš„DOMç‰‡æ®µ

```javascript
class Element {
  // ...
  render() {
    // æ ¹æ®èŠ‚ç‚¹åç§°ï¼Œåˆ›å»ºå¯¹åº”çš„å…ƒç´ 
    let element = document.createElement(this.tagName)
    let attributes = this.attributes
    // éå†å½“å‰å±æ€§å¯¹è±¡ï¼Œå¹¶ç»™å¯¹åº”çš„å…ƒç´ è®¾ç½®å±æ€§å€¼
    for (let key in attributes) {
      setAttribute(element, key, attributes[key])
    }
    let children = this.children
    // éå†å­èŠ‚ç‚¹
    children.forEach(child => {
      // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œé€’å½’éå†ï¼›å¦åˆ™ä¸ºä¸ºæœ¬èŠ‚ç‚¹ï¼Œå¹¶ç›´æ¥åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
      let childElement = child instanceof Element 
      	? child.render() : document.createTextNode(child)
      element.appendChild(childElement)
    })
    return element
  }
}
```

#### *å°†çœŸå®DOMèŠ‚ç‚¹æ¸²æŸ“åˆ°æµè§ˆå™¨ä¸Š*

```javascript
const renderDom = (element, target) => {
  target.appendChild(element)
}
```

#### æ‰§è¡Œä»£ç 

```html
<div id="app"></div>
```

```javascript
const chapterListVirtualDom = element('ul', { id: 'chapterList' }, [
  element('li', { class: 'chapter' }, ['chapter1']),
  element('li', { class: 'chapter' }, ['chapter2']),
  element('li', { class: 'chapter' }, ['chapter3']),
])
const dom = chapterListVirtualDom.render()
const target = document.querySelector('#app')
renderDom(dom, target)
```

![image-20210419093535759](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210419093603399.png)

### è™šæ‹ŸDOM diffç®—æ³•

#### å®ç°

```javascript
const diff = (oldVirtualDom, newVirtualDom) => {
  let patches = []
  // é€’å½’æ ‘ï¼Œæ¯”è¾ƒåçš„ç»“æœæ”¾åˆ°patches
  walkToDiff(oldVirtualDom, newVirtualDom, 0, patches)
  // è¿”å›diffç»“æœ
  return patches
}
```

```javascript
let initialIndex = 0
/**
 * @param {æ—§VDOM} oldVirtualDom
 * @param {æ–°VDOM} newVirtualDom
 * @param {nodeIndex} index
 * @param {é—­åŒ…å˜é‡ï¼Œè®°å½•diffç»“æœ} patches
 */
const walkToDiff = (oldVirtualDom, newVirtualDom, index, patches) => {
  let diffResult = []
  // å¦‚æœnewVirtualDomä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹è¢«ç§»é™¤ï¼Œ
  // æˆ‘ä»¬å°†typeä¸ºREMOVEçš„å¯¹è±¡æ¨è¿›diiResultå˜é‡ï¼Œå¹¶è®°å½•index
  if(!newVirtualDom) {
    diffResult.push({
      type: 'REMOVE',
      index
    })
  }
  // æ–°æ—§èŠ‚ç‚¹éƒ½æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸ºå­—ç¬¦ä¸²
  else if (typeof oldVirtualDom === 'string' && typeof newVirtualDom === 'string') {
    // æ¯”è¾ƒæ–‡æœ¬æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™è®°å½•æ–°çš„ç»“æœ
    if (oldVirtualDom !== newVirtualDom) {
      diffResult.push({
        type: 'MODIFY_TEXT',
        data: newVirtualDom,
        index
      })
    }
  }
  // æ–°æ—§èŠ‚ç‚¹ç±»å‹ç›¸åŒ
  else if (oldVirtualDom.tagName === newVirtualDom.tagName) {
    // æ¯”è¾ƒå±æ€§æ˜¯å¦ç›¸åŒ
    let diffAttributeResult = {}
    // æ—§èŠ‚ç‚¹å±æ€§ä¸æ–°èŠ‚ç‚¹ä¸åŒ
    for (let key in oldVirtualDom) {
      if (oldVirtualDom[key] !== newVirtualDom[key]) {
        diffAttributeResult[key] = newVirtualDom[key]
      }
    }
    // æ—§èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨æ–°èŠ‚ç‚¹çš„å±æ€§
    for (let key in newVirtualDom) {
      // æ—§èŠ‚ç‚¹ä¸å­˜åœ¨çš„æ–°å±æ€§
      if (!oldVirtualDom.hasOwnProperty(key)) {
        diffAttributeResult[key] = newVirtualDom[key]
      }
    }
    if (Object.keys(diffAttributeResult).length > 0) {
      diffResult.push({
        type: 'MODIFY_ATTRIBUTES',
        diffAttributeResult
      })
    }
    // è‹¥æœå­˜åœ¨å­èŠ‚ç‚¹ï¼Œéå†å­èŠ‚ç‚¹
    oldVirtualDom.children.forEach((child, index) => {
      walkToDiff(child, newVirtualDom.children[index], ++initialIndex, patches)
    })
  }
  // èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œæ—§èŠ‚ç‚¹ç›´æ¥è¢«æ›¿æ¢ï¼›ç›´æ¥å°†æ–°çš„ç»“æœpush
  else {
    diffResult.push({
      type: 'REPLACE',
      newVirtualDom
    })
  }
  // æ—§èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç›´æ¥å°†æ–°çš„ç»“æœpush
  if (!oldVirtualDom) {
    diffResult.push({
      type: 'REPLACE',
      newVirtualDom
    })
  }
  // diffç»“æœ
  if(diffResult.length) {
    patches[index] = diffResult
  }
}
```

#### æ‰§è¡Œ

```javascript
const chapterListVirtualDom1 = element('ul', { id: 'list' }, [
  element('li', { class: 'chapter' }, ['chapter1']),
  element('li', { class: 'chapter' }, ['chapter2']),
  element('li', { class: 'chapter' }, ['chapter3'])
])
const chapterListVirtualDom2 = element('ul', { id: 'list2' }, [
  element('li', { class: 'chapter2' }, ['chapter4']),
  element('li', { class: 'chapter2' }, ['chapter5']),
  element('lo', { class: 'chapter2' }, ['chapter6'])
])
const diffDom = diff(chapterListVirtualDom1, chapterListVirtualDom2)
console.log(diffDom)
```

![image-20210419150009512](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210419151116065.png)

### å°ç»“

- é€šè¿‡Element ç±»ç”Ÿæˆè™šæ‹ŸDOMï¼›
- é€šè¿‡diffæ–¹æ³•å¯¹ä»»æ„ä¸¤ä¸ªè™šæ‹ŸDOMè¿›è¡Œå¯¹æ¯”ï¼Œå¾—åˆ°å·®å¼‚çš„æ•°æ®æ•°ç»„

### æ›´æ–°DOMèŠ‚ç‚¹ patchæ–¹æ³•

```javascript
/**
 * @param {çœŸå®çš„DOMèŠ‚ç‚¹} node
 * @param {å·®å¼‚æ•°æ®æ•°ç»„} patches
 */
const patch = (node, patches) => {
  let walker = {index: 0}
  walk(node, walker, patches)
}
const walk = (node, walker, patches) => {
  let currentPatch = patches[walker.index]
  let childNodes = node.childNodes
  // é€’å½’è°ƒç”¨
  childNodes.forEach(child => {
    walker.index ++
    walk(child, walker, patches)
  })
  // è°ƒç”¨doPatchæ–¹æ³•è¿›è¡Œæ›´æ–°
  if (currentPatch) {
    doPatch(node, currentPatch)
  }
}
const doPatch = (node, patches) => {
  patches.forEach(patch => {
    switch (patch.type) {
      // ä¿®æ”¹èŠ‚ç‚¹å±æ€§
      case 'MODIFY_ATTRIBUTES':
        const attributes = patch.diffAttributeResult.attributes
        for (let key in attributes) {
          // ä¸ä¸ºå…ƒç´ èŠ‚ç‚¹
          if (node.nodeType !== 1) {
            return
          }
          const value = attributes[key]
          if (value) {
            setAttribute(node, key, value)
          } else {
            node.removeAttribute(key)
          }
        }
        break
      // ä¿®æ”¹èŠ‚ç‚¹æ–‡æœ¬
      case 'MODIFY_TEXT':
        node.textContent = patch.data
        break
      // æ›¿æ¢ä¸ºæ–°èŠ‚ç‚¹
      case 'REPLACE':
        let newNode = (patch.newVirtualDom instanceof Element) 
        	? patch.newVirtualDom.render() : document.createTextNode(patch.newVirtualDom)
        node.parentNode.replaceChild(newNode, node)
        break
      // åˆ é™¤æ—§èŠ‚ç‚¹
      case 'REMOVE':
        node.parentNode.removeChild(node)
        break
      default:
        break
    }
  })
}
```

### æ‰§è¡Œç»“æœ

```html
<div id="app"></div>
```

```javascript
const chapterListVirtualDom = element('ul', { id: 'chapterList' }, [
  element('li', { class: 'chapter' }, ['chapter1']),
  element('li', { class: 'chapter' }, ['chapter2']),
  element('li', { class: 'chapter' }, ['chapter3']),
])

const dom = chapterListVirtualDom.render()
const target = document.querySelector('#app')
renderDom(dom, target)
```

![image-20210419165644206](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210419165644206.png)

```javascript
const chapterListVirtualDom2 = element('ul', { id: 'chapterList1' }, [
  element('li', { class: 'chapter' }, ['chapter1']),
  element('li', { class: 'chapter' }, ['chapter5']),
  element('h3', { class: 'chapter2', style: 'color: #f00' }, ['chapter6']),
])
const diffDom = diff(chapterListVirtualDom, chapterListVirtualDom2)
patch(dom, diffDom)
```

![image-20210419165716740](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210419165716740.png)