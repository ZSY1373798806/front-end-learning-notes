# **Webpack æ·±åº¦è§£æ**

## 1. Webpack å®šä¹‰

- Webpack æ˜¯ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨ï¼ˆbundlerï¼‰ï¼Œèƒ½å°†é¡¹ç›®æ•´ä½“æ‰“åŒ…ã€ä¼˜åŒ–è¾“å‡ºã€‚
- é»˜è®¤åªèƒ½å¤„ç† JS æ–‡ä»¶ï¼Œå…¶ä»–èµ„æºä¾èµ– **Loader** æœºåˆ¶ã€‚

## 2. Webpack æ„å»ºæµç¨‹ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰

1. **åˆå§‹åŒ–å‚æ•°**
   - è§£æwebpacké…ç½®å‚æ•°ï¼Œåˆå¹¶ shell å‚æ•°ä¸ `webpack.config.js` é…ç½®ï¼Œç”Ÿæˆæœ€ç»ˆé…ç½®ã€‚
2. **å¼€å§‹ç¼–è¯‘**
   - æ ¹æ®å¾—åˆ°çš„å‚æ•°ï¼Œåˆå§‹åŒ– `compiler` å¯¹è±¡ã€‚
   - æ³¨å†Œæ’ä»¶ï¼Œæ’ä»¶ç›‘å¬ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚
   - è°ƒç”¨ `compiler.run()` å¼€å§‹ç¼–è¯‘ã€‚
3. **ç¡®å®šå…¥å£**
   - ä» `entry` å…¥å£è§£ææ–‡ä»¶ï¼Œç”Ÿæˆ ASTã€‚
   - æŸ¥æ‰¾ä¾èµ–ï¼Œé€’å½’æ„å»ºä¾èµ–å›¾ã€‚
4. **ç¼–è¯‘æ¨¡å—**
   - æ ¹æ®æ–‡ä»¶ç±»å‹å’Œ Loader è½¬æ¢æ–‡ä»¶ã€‚
   - å†é€’å½’å¤„ç†æ¨¡å—ä¾èµ–ã€‚
   - ç›´åˆ°æ‰€æœ‰æ¨¡å—ç¼–è¯‘å®Œæˆã€‚
5. **å®Œæˆæ¨¡å—ç¼–è¯‘å¹¶è¾“å‡º**
   - æ„å»ºæ¨¡å—ä¾èµ–å…³ç³»ï¼Œç”Ÿæˆ chunkã€‚
6. **è¾“å‡ºæ–‡ä»¶**
   - å°† chunk è¾“å‡ºåˆ°æ–‡ä»¶ç³»ç»Ÿã€‚

## 3. Hash ç±»å‹

| ç±»å‹          | è¯´æ˜                                       |
| ------------- | ------------------------------------------ |
| `hash`        | æ•´ä¸ªç¼–è¯‘ç”Ÿæˆç›¸åŒ hash                      |
| `chunkhash`   | åŸºäºå…¥å£æ–‡ä»¶å’Œ chunkï¼Œæ”¹åŠ¨åªå½±å“å…³è” chunk |
| `contenthash` | æ–‡ä»¶å†…å®¹å˜åŒ–æ‰å˜åŒ–ï¼Œé€‚åˆé™æ€èµ„æºç¼“å­˜       |

### 4.æ ¸å¿ƒä¾èµ–
- @babel/parserï¼šç”¨äºå°†æºç ç”ŸæˆAST
- @babel/traverseï¼šå¯¹ASTèŠ‚ç‚¹è¿›è¡Œé€’å½’éå†
- @babel/preset-envï¼šå°†è·å¾—çš„ES6çš„ASTè½¬åŒ–æˆES5
## 5. å¸¸ç”¨é’©å­ï¼ˆHooksï¼‰

| é˜¶æ®µ       | é’©å­                       | æè¿°                       |
| ---------- | -------------------------- | -------------------------- |
| åˆ›å»ºç¼–è¯‘å™¨ | `environment`/`initialize` | è¯»å–ç¯å¢ƒ & åˆå§‹åŒ– compiler |
| ç¼–è¯‘å‰     | `run`/`compile`            | ç¼–è¯‘å™¨è¿è¡Œï¼Œå¤„ç†ç¼“å­˜       |
| ç¼–è¯‘ä¸­     | `make`                     | æ ¸å¿ƒç¼–è¯‘æµç¨‹               |
| è¾“å‡ºå‰     | `emit`                     | è¾“å‡ºèµ„æº                   |
| ç¼–è¯‘å®Œæˆ   | `done`                     | æ‰€æœ‰æµç¨‹ç»“æŸ               |

### pluginç”Ÿå‘½å‘¨æœŸ

## **1. Compiler ç”Ÿå‘½å‘¨æœŸ**

`Compiler` æ˜¯æ•´ä¸ª Webpack æ„å»ºçš„æ ¸å¿ƒå¯¹è±¡ï¼Œè´Ÿè´£ç®¡ç†å…¨å±€çš„ç”Ÿå‘½å‘¨æœŸå’Œå…¥å£é…ç½®ã€‚æ’ä»¶å¯ä»¥æŒ‚è½½åœ¨ `compiler.hooks` ä¸Šã€‚

### **ä¸»è¦é’©å­ï¼ˆæŒ‰æ‰§è¡Œé¡ºåºï¼‰**

| é’©å­               | é˜¶æ®µ       | è¯´æ˜                                              |
| ------------------ | ---------- | ------------------------------------------------- |
| `environment`      | åˆå§‹åŒ–     | åˆ›å»º `compiler` æ—¶è¯»å–ç¯å¢ƒä¿¡æ¯                    |
| `afterEnvironment` | åˆå§‹åŒ–     | environment åæ‰§è¡Œï¼Œå·²å‡†å¤‡å¥½æ’ä»¶æ³¨å†Œ              |
| `initialize`       | åˆå§‹åŒ–     | åˆå§‹åŒ– compiler å¯¹è±¡                              |
| `beforeRun`        | ç¼–è¯‘å‰     | compiler.run å‰è§¦å‘                               |
| `run`              | ç¼–è¯‘å‰     | å¼€å§‹æ‰§è¡Œ runï¼Œå‡†å¤‡ç¼–è¯‘                            |
| `watchRun`         | watch æ¨¡å¼ | æ¯æ¬¡ watch ç¼–è¯‘å‰è§¦å‘                             |
| `beforeCompile`    | ç¼–è¯‘å‰     | ç¼–è¯‘å¼€å§‹å‰å¤„ç†ä¸€äº›ä»»åŠ¡                            |
| `compile`          | ç¼–è¯‘ä¸­     | åˆ›å»º compilation å¯¹è±¡å‰                           |
| `thisCompilation`  | ç¼–è¯‘ä¸­     | compilation å¯¹è±¡åˆ›å»ºæ—¶è§¦å‘                        |
| `compilation`      | ç¼–è¯‘ä¸­     | compilation åˆ›å»ºå®Œæˆï¼Œå¯è®¿é—® moduleã€chunk ç­‰ä¿¡æ¯ |
| `afterCompile`     | ç¼–è¯‘ä¸­     | compilation ç¼–è¯‘å®Œæˆï¼Œå‡†å¤‡è¾“å‡º                    |

------

## **2. Compilation ç”Ÿå‘½å‘¨æœŸ**

`Compilation` å¯¹è±¡è¡¨ç¤º**ä¸€æ¬¡å®Œæ•´çš„æ¨¡å—ç¼–è¯‘è¿‡ç¨‹**ï¼Œæ’ä»¶å¯ä»¥æŒ‚è½½åœ¨ `compilation.hooks` ä¸Šåšç»†ç²’åº¦æ“ä½œã€‚

### **ä¸»è¦é’©å­**

| é’©å­                  | é˜¶æ®µ     | è¯´æ˜                           |
| --------------------- | -------- | ------------------------------ |
| `buildModule`         | æ„å»ºæ¨¡å— | æ¨¡å—æ„å»ºæ—¶è§¦å‘ï¼Œå¯ä¿®æ”¹æ¨¡å—æºç  |
| `succeedModule`       | æ„å»ºæ¨¡å— | æ¨¡å—æ„å»ºæˆåŠŸå                 |
| `failedModule`        | æ„å»ºæ¨¡å— | æ¨¡å—æ„å»ºå¤±è´¥                   |
| `seal`                | å°è£…     | å‡†å¤‡ç”Ÿæˆ chunk å’Œèµ„æº          |
| `optimize`            | ä¼˜åŒ–     | æ‰€æœ‰æ¨¡å—æ‰“åŒ…å‰ä¼˜åŒ–é˜¶æ®µ         |
| `optimizeModules`     | ä¼˜åŒ–     | ä¼˜åŒ– module é›†åˆ               |
| `optimizeChunks`      | ä¼˜åŒ–     | ä¼˜åŒ– chunk é›†åˆ                |
| `optimizeAssets`      | ä¼˜åŒ–     | ä¼˜åŒ–èµ„æºæ–‡ä»¶ï¼Œå¦‚å‹ç¼©ã€ä¿®æ”¹     |
| `afterOptimizeAssets` | ä¼˜åŒ–     | èµ„æºä¼˜åŒ–å®Œæˆ                   |
| `afterSeal`           | å°è£…     | æ‰€æœ‰ä¼˜åŒ–å®Œæˆï¼Œå‡†å¤‡è¾“å‡º         |
| `emit`                | è¾“å‡º     | è¾“å‡ºèµ„æºåˆ° output ç›®å½•         |
| `afterEmit`           | è¾“å‡º     | è¾“å‡ºå®Œæˆï¼Œå¯åšæ¸…ç†æˆ–ç»Ÿè®¡       |

------

## **3. æ€»ç»“æ‰§è¡Œé¡ºåº**

```
Compiler Hooks:
environment â†’ afterEnvironment â†’ initialize â†’ beforeRun â†’ run â†’ beforeCompile â†’ compile
  â†“
  Compilation Hooks:
  thisCompilation â†’ compilation â†’ buildModule â†’ succeedModule â†’ optimize â†’ optimizeModules
  â†’ optimizeChunks â†’ optimizeAssets â†’ afterOptimizeAssets â†’ afterSeal â†’ emit â†’ afterEmit
Compiler Hooks continue:
done
```

- **Compiler** â†’ ç®¡ç†å…¨å±€ç”Ÿå‘½å‘¨æœŸ
- **Compilation** â†’ ç®¡ç†æ¯æ¬¡ç¼–è¯‘ç»†èŠ‚
- **emit** é’©å­ â†’ è¾“å‡ºèµ„æºé˜¶æ®µï¼Œæ’ä»¶æœ€å¸¸ç”¨
- **done** é’©å­ â†’ ç¼–è¯‘å®Œå…¨ç»“æŸï¼Œå¯åšæ—¥å¿—ç»Ÿè®¡

### pluginé‡è¦API

- #### compilerå¯¹è±¡ï¼š å…¨å±€ç”Ÿå‘½å‘¨æœŸé’©å­

  - compiler.hooksï¼šæä¾›äº†ä¸€ç³»åˆ—çš„é’©å­ï¼Œç”¨äºæ’ä»¶æŒ‚è½½åˆ°webpackçš„æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹ï¼›é’©å­åŒ…æ‹¬ï¼š
    - compileã€compilationï¼šå…è®¸åœ¨ç¼–è¯‘å™¨å¼€å§‹ç¼–è¯‘ä»¥åŠåˆ›å»ºæ–°çš„ç¼–è¯‘å¯¹è±¡æ—¶æŒ‚è½½åŠŸèƒ½
    - emitã€doneï¼šè¿™äº›é˜¶æ®µæ›´é€‚åˆäºç”Ÿæˆèµ„æºã€ä¿®æ”¹è¾“å‡ºå’Œè®°å½•çŠ¶æ€

- #### compilationå¯¹è±¡ï¼šæ¨¡å—çº§ç”Ÿå‘½å‘¨æœŸé’©å­

  - æä¾›ä¹™çƒ¯ç±»é’©å­ï¼Œä»¥æ›´ç»†ç²’åº¦æ§åˆ¶ç¼–è¯‘é˜¶æ®µï¼›æ¯”å¦‚ï¼š
    - optimizeã€optimizeModuleï¼šç”¨äºä¼˜åŒ–é˜¶æ®µ
    - buildModuleï¼šåœ¨æ„å»ºæ¨¡å—æ—¶è§¦å‘
    - moduleAssetsï¼šå¤„ç†æ¨¡å—äº§å‡ºçš„èµ„æº

- #### tapableï¼š å®ç°é’©å­ç³»ç»Ÿ

  - webpackä¾èµ–äºtapableåº“æ¥å®ç°é’©å­ç³»ç»Ÿ
  - ä½¿ç”¨tap()æˆ–tapAsync()æ–¹æ³•æ¥æŒ‚è½½è¿™äº›é’©å­ï¼›è¿™äº›æ–¹æ³•é€šå¸¸æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šæ’ä»¶åç§°å’Œä¸€ä¸ªå›è°ƒå‡½æ•°

Plugin æ ¸å¿ƒæ–¹æ³•

Plugin æ˜¯**Webpack ç”Ÿå‘½å‘¨æœŸé’©å­æœºåˆ¶çš„æ‰©å±•å™¨**ï¼Œç”¨äºå¢å¼ºæ‰“åŒ…åŠŸèƒ½ï¼Œä¸ç›´æ¥å¤„ç†æ–‡ä»¶å†…å®¹ï¼Œè€Œæ˜¯ç›‘å¬ compiler/compilation ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

| æ ¸å¿ƒå¯¹è±¡               | æ–¹æ³•/å±æ€§           | ä½œç”¨                                 | ç¤ºä¾‹/è¯´æ˜                                                    |
| ---------------------- | ------------------- | ------------------------------------ | ------------------------------------------------------------ |
| `compiler`             | `compiler.hooks`    | æ³¨å†Œå…¨å±€ç”Ÿå‘½å‘¨æœŸé’©å­                 | `js compiler.hooks.emit.tap('PluginName', compilation => {...});` |
| `compilation`          | `compilation.hooks` | æ³¨å†Œæ¨¡å—çº§ç”Ÿå‘½å‘¨æœŸé’©å­               | `js compilation.hooks.optimizeAssets.tap('PluginName', assets => {...});` |
| `tap(name, fn)`        | æ–¹æ³•                | æ³¨å†ŒåŒæ­¥é’©å­                         | `js hook.tap('MyPlugin', () => {...});`                      |
| `tapAsync(name, fn)`   | æ–¹æ³•                | æ³¨å†Œå¼‚æ­¥é’©å­ï¼Œå›è°ƒå®Œæˆåé€šçŸ¥ webpack | `js hook.tapAsync('MyPlugin', (compilation, callback) => { callback(); });` |
| `tapPromise(name, fn)` | æ–¹æ³•                | æ³¨å†Œå¼‚æ­¥é’©å­ï¼Œè¿”å› Promise           | `js hook.tapPromise('MyPlugin', async (compilation) => {...});` |

#### ç¤ºä¾‹

- ä½¿ç”¨å¼‚æ­¥é’©å­

  ```js
  class MyWebpackPlugin {
    apply(compiler) {
      // ç›‘å¬ emit é’©å­
      compiler.hooks.emit.tapAsync("MyWebpackPlugin", (compilation, callback) => {
        // åœ¨è¿™é‡Œå¯ä»¥å¤„ç† compilation ä¸­çš„èµ„æºã€æ¨¡å—ç­‰
        console.log("This is an example webpack plugin!");
        // å®Œæˆæ’ä»¶å¤„ç†åè°ƒç”¨ callback é€šçŸ¥ webpack
        callback();
      });
    }
  }
  ```

- ç»Ÿè®¡æºç é‡Œé¢çš„ console.log è°ƒç”¨æ•°é‡ä¸è°ƒç”¨è·¯å¾„

  - å®šä¹‰æ’ä»¶ç±»

    å®šä¹‰ä¸€ä¸ªJavaScriptç±»ï¼›åœ¨ç±»çš„applyæ–¹æ³•ä¸­ï¼Œç›‘å¬webpackçš„compilationé’©å­æ¥è®¿é—®å¤„ç†æ¨¡å—çš„æºä»£ç 

  - ç›‘å¬é€‚å½“çš„webpacké’©å­

    é’ˆå¯¹æºä»£ç çš„å¤„ç†ï¼Œé€‰æ‹©ç›‘å¬compilationé˜¶æ®µçš„optimizeModuleé’©å­ï¼›åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ¨¡å—çš„æºä»£ç å¯ä»¥è¢«è®¿é—®å’Œä¿®æ”¹

  - å¤„ç†æºä»£ç 

    å¤„ç†æ¯ä¸ªæ¨¡å—çš„æºä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼æ¥è¯†åˆ«console.logçš„è°ƒç”¨

  ```js
  class ConsoleLogStatsPlugin {
    constructor(options = {}) {
      this.options = {
        showAll: false, // æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—ï¼ˆåŒ…æ‹¬æ²¡æœ‰ console.log çš„ï¼‰
        threshold: 0,  // åªæ˜¾ç¤ºè¶…è¿‡æ­¤æ•°é‡çš„æ¨¡å—
        ...options
      };
      this.stats = [];
    }
    apply(compiler) {
      compiler.hooks.compilation.tap("ConsoleLogStatsPlugin", (compilation) => {
        compilation.moduleTemplates.javascript.hooks.render.tap("ConsoleLogStatsPlugin", (moduleSource, module) => {
          if (!module.resource) return moduleSource;
          const source = moduleSource.source();
          const consoleLogMatches = source.match(/console\.(log|info|warn|error)\(/g) || [];
          const count = consoleLogMatches.length;
          if (count > this.options.threshold || this.options.showAll) {
            this.stats.push({
              path: module.resource,
              count,
              warnings: consoleLogMatches.filter(c => c.includes('.warn')).length,
              errors: consoleLogMatches.filter(c => c.includes('.error')).length,
              logs: consoleLogMatches.filter(c => c.includes('.log')).length,
              infos: consoleLogMatches.filter(c => c.includes('.info')).length
            });
          }
          return moduleSource;
        });
        // åœ¨ç¼–è¯‘å®Œæˆåè¾“å‡ºç»Ÿè®¡ç»“æœ
        compilation.hooks.afterProcessAssets.tap("ConsoleLogStatsPlugin", () => {
          if (this.stats.length > 0) {
            const total = this.stats.reduce((sum, item) => sum + item.count, 0);
            console.log(`\nğŸ“Š Console Log Statistics (${total} calls in ${this.stats.length} modules):`);
            this.stats
              .sort((a, b) => b.count - a.count)
              .forEach(item => {
                const relativePath = item.path.replace(process.cwd(), '');
                const typeStats = [
                  item.logs > 0 ? `log: ${item.logs}` : '',
                  item.infos > 0 ? `info: ${item.infos}` : '',
                  item.warnings > 0 ? `warn: ${item.warnings}` : '',
                  item.errors > 0 ? `error: ${item.errors}` : ''
                ].filter(Boolean).join(', ');
                console.log(`  ${relativePath}: ${item.count} calls (${typeStats})`);
              });
          } else {
            console.log('\nâœ… No console.log calls found in any modules.');
          }
        });
      });
    }
  }
  module.exports = ConsoleLogStatsPlugin;
  ```

- è·å–ç™»å½•tokençš„webpackæ’ä»¶

  ```typescript
  import request from 'request';
  import colors from 'colors';
  import type { Compiler, Compilation, WebpackError, Stats } from 'webpack';
  import type { InnerCallback } from 'tapable';
  // å®šä¹‰å›è°ƒå‡½æ•°ç±»å‹
  type Callback<T> = (err?: null | WebpackError, result?: T) => void;
  // æ’ä»¶é…ç½®é€‰é¡¹æ¥å£
  interface Options {
    url: string;                    // ç™»å½•æ¥å£çš„ URL
    params: any;                   // ç™»å½•è¯·æ±‚çš„å‚æ•°ï¼ˆç”¨æˆ·åã€å¯†ç ç­‰ï¼‰
    tokenKeyName: string | undefined;      // å“åº”æ•°æ®ä¸­ token å­—æ®µçš„åç§°
    localStorageKey: string | undefined;   // å­˜å‚¨åˆ° localStorage çš„é”®å
    extraObj: {} | undefined;      // é¢å¤–éœ€è¦åˆå¹¶è¿› localStorage çš„å¯¹è±¡
  }
  /**
   * LoginWebpackPlugin - è‡ªåŠ¨ç™»å½•æ’ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * 1. åœ¨ webpack ç¼–è¯‘å‰è‡ªåŠ¨è°ƒç”¨ç™»å½•æ¥å£
   * 2. è·å–ç™»å½• token æˆ–å…¶ä»–è®¤è¯ä¿¡æ¯
   * 3. å°†è®¤è¯ä¿¡æ¯æ³¨å…¥åˆ° HTML é¡µé¢çš„ localStorage ä¸­
   * 4. ä¸»è¦ç”¨äºå¼€å‘ç¯å¢ƒï¼Œé¿å…æ¯æ¬¡åˆ·æ–°éƒ½éœ€è¦é‡æ–°ç™»å½•
   */
  class LoginWebpackPlugin {
    // æ’ä»¶é…ç½®é€‰é¡¹ï¼ŒåŒ…å«é»˜è®¤å€¼
    private options: Options = {
      url: "",                      // ç™»å½•æ¥å£ URL
      extraObj: undefined,          // é¢å¤–å¯¹è±¡
      params: {},                   // ç™»å½•å‚æ•°
      tokenKeyName: undefined,      // token å­—æ®µå
      localStorageKey: undefined    // localStorage é”®å
    };
    // å­˜å‚¨ç™»å½•æ¥å£è¿”å›çš„æ•°æ®
    private obj: null | {};
    /**
     * æ„é€ å‡½æ•° - åˆå§‹åŒ–æ’ä»¶é…ç½®
     * @param options ç”¨æˆ·ä¼ å…¥çš„é…ç½®é€‰é¡¹
     */
    constructor(options: Options) {
      // éªŒè¯å¿…éœ€å‚æ•°
      if (!options.url) {
        throw new Error('login-webpack-plugin: url is required');
      }
      if (!options.params) {
        throw new Error('login-webpack-plugin: params is required');
      }
      // è®¾ç½®é…ç½®é€‰é¡¹ï¼Œæä¾›é»˜è®¤å€¼
      this.options.url = options.url;
      this.options.extraObj = options.extraObj;
      this.options.tokenKeyName = options?.tokenKeyName ?? 'token';        // é»˜è®¤ token å­—æ®µåä¸º 'token'
      this.options.localStorageKey = options?.localStorageKey ?? 'token';  // é»˜è®¤ localStorage é”®åä¸º 'token'
      this.options.params = options.params;
      
      // åˆå§‹åŒ–ç™»å½•æ•°æ®ä¸º null
      this.obj = null;
    }
    /**
     * è°ƒç”¨ç™»å½•æ¥å£
     * @param cb å›è°ƒå‡½æ•°ï¼Œç”¨äºé€šçŸ¥ webpack å¼‚æ­¥æ“ä½œå®Œæˆ
     */
    callLoginApi(cb: (params: any) => void) {
      // å‘é€ HTTP POST è¯·æ±‚åˆ°ç™»å½•æ¥å£
      request({
        url: this.options.url,        // ç™»å½•æ¥å£ URL
        method: 'POST',               // ä½¿ç”¨ POST æ–¹æ³•
        headers: {
          'Content-type': 'application/json'  // è®¾ç½®è¯·æ±‚å¤´ä¸º JSON æ ¼å¼
        },
        timeout: 5000,                // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’
        json: this.options.params,    // å‘é€çš„ç™»å½•å‚æ•°ï¼ˆä¼šè‡ªåŠ¨åºåˆ—åŒ–ä¸º JSONï¼‰
      }, (err, response, body) => {
        // å¤„ç†è¯·æ±‚é”™è¯¯
        if (err) {
          console.log(colors.red.underline(err));  // çº¢è‰²ä¸‹åˆ’çº¿æ˜¾ç¤ºé”™è¯¯
          cb(err);
          return;
        }
        // æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦æˆåŠŸï¼ˆå‡è®¾ code === 0 è¡¨ç¤ºæˆåŠŸï¼‰
        if (body.code === 0) {
          // å¤„ç†ç™»å½•æˆåŠŸçš„æƒ…å†µ
          if (this.options.extraObj) {
            // å¦‚æœæœ‰é¢å¤–å¯¹è±¡éœ€è¦åˆå¹¶
            const originalObj = typeof body.data[this.options.tokenKeyName || 'token'] === 'string' 
              ? {
                  // å¦‚æœ token æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ›å»ºå¯¹è±¡åŒ…è£…å®ƒ
                  [this.options.tokenKeyName as string]: body.data[this.options.tokenKeyName || 'token']
                } 
              : body.data[this.options.tokenKeyName || 'token'];  // å¦‚æœ token å·²ç»æ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
            // åˆå¹¶åŸå§‹æ•°æ®å’Œé¢å¤–å¯¹è±¡
            this.obj = { ...originalObj, ...this.options.extraObj };
          } else {
            // ç›´æ¥ä½¿ç”¨æ¥å£è¿”å›çš„ token æ•°æ®
            this.obj = body.data[this.options.tokenKeyName || 'token'];
          }
          cb(null);  // é€šçŸ¥ webpack å¼‚æ­¥æ“ä½œæˆåŠŸå®Œæˆ
        } else {
          // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          console.log(colors.red.bold(body?.msg ?? "ç™»å½•æ¥å£é”™è¯¯"));
          cb(new Error(body?.msg ?? body?.message));
        }
      });
    }
    /**
     * apply æ–¹æ³• - webpack æ’ä»¶çš„æ ¸å¿ƒæ–¹æ³•
     * @param compiler webpack ç¼–è¯‘å™¨å®ä¾‹
     */
    apply(compiler: Compiler) {
      // è·å– HtmlWebpackPluginï¼Œç”¨äºæ“ä½œ HTML æ¨¡æ¿
      const HtmlWebpackPlugin = require('html-webpack-plugin');
      /**
       * 1. beforeCompile é’©å­ - åœ¨ç¼–è¯‘å¼€å§‹å‰æ‰§è¡Œ
       * ç›®çš„ï¼šç¡®ä¿åœ¨ç¼–è¯‘å‰å®Œæˆç™»å½•ï¼Œè·å–åˆ°è®¤è¯ä¿¡æ¯
       */
      compiler.hooks.beforeCompile.tapAsync(
        'LoginWebpackPlugin', 
        (compilation: Compilation['params'], cb: InnerCallback<Error, void>) => {
          // å¦‚æœè¿˜æ²¡æœ‰ç™»å½•æ•°æ®ï¼Œåˆ™è°ƒç”¨ç™»å½•æ¥å£ï¼›å¦åˆ™ç›´æ¥ç»§ç»­
          this.obj === null ? this.callLoginApi(cb) : cb();
        }
      );
      /**
       * 2. compilation é’©å­ - åœ¨æ¯æ¬¡ç¼–è¯‘æ—¶æ‰§è¡Œ
       * ç›®çš„ï¼šæ³¨å†Œ HTML å¤„ç†é’©å­ï¼Œå‘ HTML ä¸­æ³¨å…¥ç™»å½•ä¿¡æ¯
       */
      compiler.hooks.compilation.tap('LoginWebpackPlugin', (compilation: Compilation) => {
        // è·å– HtmlWebpackPlugin çš„é’©å­
        const hooks = HtmlWebpackPlugin.getHooks(compilation);
        /**
         * afterTemplateExecution é’©å­ - åœ¨ HTML æ¨¡æ¿æ‰§è¡Œå
         * ç›®çš„ï¼šå‘ç”Ÿæˆçš„ HTML ä¸­æ³¨å…¥ JavaScript ä»£ç ï¼Œå°†ç™»å½•ä¿¡æ¯å­˜å‚¨åˆ° localStorage
         */
        HtmlWebpackPlugin.getHooks(compilation).afterTemplateExecution.tapAsync(
          'LoginWebpackPlugin', 
          (htmlPluginData: {html: any}, callback: Callback<{html: any}>) => {
            // ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹æ³¨å…¥ç™»å½•ä¿¡æ¯
            if (process.env.NODE_ENV === 'development') {
              
              // æ ¹æ®æ•°æ®ç±»å‹ç”Ÿæˆä¸åŒçš„æ³¨å…¥è„šæœ¬
              if (typeof this.obj === 'object') {
                // å¦‚æœç™»å½•æ•°æ®æ˜¯å¯¹è±¡ç±»å‹
                htmlPluginData.html += `
                <script>
                  // å°†ç™»å½•æ•°æ®å¯¹è±¡åŒ–
                  const a = ${JSON.stringify(this.obj)};
                  // å°†æ•´ä¸ªå¯¹è±¡å­˜å‚¨åˆ° localStorage
                  window.localStorage.setItem(${JSON.stringify(this.options.localStorageKey)}, JSON.stringify(a));
                </script>`;
              } else if (typeof this.obj === 'string') {
                // å¦‚æœç™»å½•æ•°æ®æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆé€šå¸¸æ˜¯ tokenï¼‰
                htmlPluginData.html += `
                <script>
                  // è·å–å­—ç¬¦ä¸²å½¢å¼çš„ token
                  const a = ${JSON.stringify(this.obj)};
                  // ç›´æ¥å­˜å‚¨å­—ç¬¦ä¸²åˆ° localStorage
                  window.localStorage.setItem(${JSON.stringify(this.options.localStorageKey)}, a);
                </script>`;
              }
            }
            // è°ƒç”¨å›è°ƒï¼Œç»§ç»­ webpack ç¼–è¯‘æµç¨‹
            callback(null, htmlPluginData);
          }
        );
      });
      /**
       * 3. done é’©å­ - ç¼–è¯‘å®Œæˆåæ‰§è¡Œ
       * ç›®çš„ï¼šè¾“å‡ºæ’ä»¶æ‰§è¡Œç»“æœï¼Œç”¨äºè°ƒè¯•å’Œç¡®è®¤
       */
      compiler.hooks.done.tapAsync(
        'LoginWebpackPlugin', 
        (compilation: Stats, cb: InnerCallback<Error, void>) => {
          // ä»¥ç»¿è‰²ç²—ä½“æ˜¾ç¤ºè·å–åˆ°çš„ç™»å½•ä¿¡æ¯
          console.log(colors.green.bold(`\nlogin-webpack-plugin:${JSON.stringify(this.obj)}\n`));
          cb();  // é€šçŸ¥ webpack å¼‚æ­¥æ“ä½œå®Œæˆ
        }
      );
    }
  }
  // å¯¼å‡ºæ’ä»¶ç±»
  export = LoginWebpackPlugin;
  ```

  

### å¸¸ç”¨æ’ä»¶

- webpack-dev-server
- webpack-merge
	åˆå¹¶webpacké…ç½®
- html-webpack-plugin
	å¤šå…¥å£é…ç½®
- MiniCSSExtractPlugin
	æŠ½ç¦»cssæ–‡ä»¶
- transform-remove-console
  ç§»é™¤æ§åˆ¶å°æ‰“å°
-  clean-webpack-plugin
  è‡ªåŠ¨æ¸…ç†distç›®å½•
- webpack-bundle-analyzer
  æ–‡ä»¶åˆ†æå·¥å…·

### Loader

#### æ ¸å¿ƒAPI

| API åç§°               | ç±»å‹ | ä½œç”¨               | ä½¿ç”¨åœºæ™¯                 |
| :--------------------- | :--- | :----------------- | :----------------------- |
| `this.async()`         | æ–¹æ³• | å£°æ˜å¼‚æ­¥ loader    | éœ€è¦å¼‚æ­¥æ“ä½œçš„ loader    |
| `this.callback()`      | æ–¹æ³• | è¿”å›å¤šä¸ªç»“æœçš„å›è°ƒ | è¿”å› source map æˆ–å…ƒæ•°æ® |
| `this.emitFile()`      | æ–¹æ³• | ç”Ÿæˆè¾“å‡ºæ–‡ä»¶       | file-loader ç­‰èµ„æºå¤„ç†   |
| `this.getOptions()`    | æ–¹æ³• | è·å– loader é…ç½®   | å®‰å…¨è·å– loader é€‰é¡¹     |
| `this.cacheable()`     | æ–¹æ³• | æ§åˆ¶ç¼“å­˜è¡Œä¸º       | ä¼˜åŒ–æ„å»ºæ€§èƒ½             |
| `this.addDependency()` | æ–¹æ³• | æ·»åŠ æ–‡ä»¶ä¾èµ–       | ç›‘è§†æ–‡ä»¶å˜åŒ–             |
| `this.resourcePath`    | å±æ€§ | å½“å‰èµ„æºè·¯å¾„       | è·å–æ–‡ä»¶ç»å¯¹è·¯å¾„         |
| `this.resourceQuery`   | å±æ€§ | èµ„æºæŸ¥è¯¢å‚æ•°       | å¤„ç†å¸¦å‚æ•°çš„èµ„æº         |
| `this.emitError()`     | æ–¹æ³• | æŠ›å‡ºé”™è¯¯           | å¤„ç†è½¬æ¢é”™è¯¯             |
| `this.emitWarning()`   | æ–¹æ³• | å‘å‡ºè­¦å‘Š           | éå…³é”®é—®é¢˜æç¤º           |

#### è¯¦ç»†APIè§£æä¸å®ä¾‹

- this.async()

  å£°æ˜loaderä¸ºå¼‚æ­¥æ¨¡å¼ï¼Œè¿”å›ä¸€ä¸ªå›è°ƒå‡½æ•°

  ```js
  module.exports = function(source) {
    const callback = this.async();
    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    setTimeout(() => {
      const result = source.replace('World', 'Loader API');
      callback(null, result);
    }, 100);
  };
  ```

- this.callback()

  è¿”å›å¤šä¸ªç»“æœï¼ˆæºç ã€sourceMapã€å…ƒæ•°æ®ï¼‰

  ```js
  module.exports = function(source) {
    // åˆ›å»º source map
    const map = generateSourceMap(source);
    this.callback(
      null,          // é”™è¯¯å¯¹è±¡
      source,        // å¤„ç†åçš„æºç 
      map,           // source map
      { meta: 'data' } // å…ƒæ•°æ®
    );
  };
  ```

- this.emitFile()

  ç”Ÿæˆè¾“å‡ºæ–‡ä»¶ï¼ˆå¸¸ç”¨äºèµ„æºå¤„ç†ï¼‰

  ```js
  module.exports = function(content) {
    const filename = 'asset-[hash].txt';
    // ç”Ÿæˆæ–‡ä»¶
    this.emitFile(filename, content);
    // è¿”å›æ¨¡å—å¯¼å‡º
    return `export default ${JSON.stringify(filename)};`;
  };
  ```

- this.getOptions()

  å®‰å…¨è·å–loaderé…ç½®ï¼ˆæ”¯æŒJSON SchemaéªŒè¯ï¼‰

  ```js
  const { validate } = require('schema-utils');
  const schema = {
    type: 'object',
    properties: {
      prefix: { type: 'string' }
    }
  };
  module.exports = function(source) {
    const options = this.getOptions(schema) || {};
    validate(schema, options, {
      name: 'Prefix Loader',
      baseDataPath: 'options'
    });
    return options.prefix + source;
  };
  ```

- this.cacheable()

  æ§åˆ¶loaderçš„ç¼“å­˜è¡Œä¸º

  ```js
  module.exports = function(source) {
    // é»˜è®¤å¯ç”¨ç¼“å­˜
    this.cacheable();
    // å¦‚æœæœ‰åŠ¨æ€ä¾èµ–ï¼Œå¯ç¦ç”¨ç¼“å­˜
    if (hasDynamicDependencies) {
      this.cacheable(false);
    }
    return transform(source);
  };
  ```

- this.addDependency()

  æ·»åŠ æ–‡ä»¶ä¾èµ–ï¼Œwebpackä¼šç›‘å¬è¿™äº›æ–‡ä»¶çš„å˜åŒ–

  ```js
  const fs = require('fs');
  const path = require('path');
  
  module.exports = function(source) {
    const configPath = path.resolve('config.json');
    
    // æ·»åŠ æ–‡ä»¶ä¾èµ–
    this.addDependency(configPath);
    
    // è¯»å–é…ç½®æ–‡ä»¶
    const config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
    
    return applyConfig(source, config);
  };
  ```

- this.resourcePath

  è·å–å½“å‰å¤„ç†æ–‡ä»¶çš„ç»å¯¹è·¯å¾„

  ```js
  module.exports = function(source) {
    // è·å–å½“å‰æ–‡ä»¶è·¯å¾„
    const filePath = this.resourcePath;
    // æ·»åŠ æ–‡ä»¶å¤´æ³¨é‡Š
    return `/* File: ${path.basename(filePath)} */\n${source}`;
  };
  ```

- this.resourceQuery

  è·å–èµ„æºURLä¸­çš„æŸ¥è¯¢å‚æ•°

  ```js
  module.exports = function(source) {
    const query = new URLSearchParams(this.resourceQuery);
    if (query.has('minify')) {
      return minify(source);
    }
    return source;
  };
  ```

- this.emitError() & this.emitWarning()

  æŠ›å‡ºé”™è¯¯å’Œè­¦å‘Š

  ```js
  module.exports = function(source) {
    if (source.includes('deprecatedFunction')) {
      this.emitWarning('Deprecated function used');
    }
    try {
      return transform(source);
    } catch (error) {
      this.emitError(error);
      return source; // è¿”å›åŸå§‹æºç ä½œä¸ºå›é€€
    }
  };
  ```

### tree-shaking
- #### åŸç†

  - ##### é™æ€åˆ†æ

    - æ¨¡å—ä¾èµ–åˆ†æ
      - webpackæ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹é¡¹ç›®ä¸­çš„æ¨¡å—è¿›è¡Œä¾èµ–åˆ†æï¼›è§£ææ¯ä¸ªæ¨¡å—çš„å†…å®¹ï¼Œç¡®å®šæ¨¡å—ä¹‹é—´çš„å¯¼å…¥å’Œå¯¼å‡ºå…³ç³»
      - é€šè¿‡åˆ†æï¼Œå¯ä»¥æ„å»ºå‡ºä¸€ä¸ªæ¨¡å—ä¾èµ–å›¾ï¼Œå±•ç¤ºå„ä¸ªæ¨¡å—é—´çš„å¼•ç”¨å…³ç³»
    - è¯†åˆ«æœªä½¿ç”¨çš„ä»£ç 
      - åŸºäºæ¨¡å—ä¾èµ–å›¾ï¼Œç¡®å®šå“ªäº›æ¨¡å—è¢«å®é™…å¼•ç”¨ï¼Œå“ªäº›æ¨¡å—æœªè¢«ä½¿ç”¨
      - å¯¹äº JavaScript æ¨¡å—ï¼Œå®ƒå¯ä»¥è¯†åˆ«å‡ºæœªè¢«è°ƒç”¨çš„å‡½æ•°ã€æœªè¢«è®¿é—®çš„å˜é‡ç­‰ã€‚å¯¹äºå…¶ä»–èµ„æºæ–‡ä»¶ï¼Œå¦‚ CSS å’Œå›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å¼•ç”¨æƒ…å†µåˆ¤æ–­æ˜¯å¦è¢«ä½¿ç”¨

  - ##### ä»£ç ä¼˜åŒ–

    - æ¶ˆé™¤æœªä½¿ç”¨çš„ä»£ç 
      - webpackä¼šåœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­å°†æœªä½¿ç”¨çš„ä»£ç ä»æœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ä¸­ç§»é™¤
      - å¯ä»¥æ˜¾è‘—å‡å°æ‰“åŒ…æ–‡ä»¶çš„å¤§å°ï¼Œæé«˜åº”ç”¨çš„åŠ è½½é€Ÿåº¦å’Œæ€§èƒ½
    - ä½œç”¨åŸŸåˆ†æ
      - åœ¨æ¶ˆé™¤ä»£ç æ—¶ï¼Œè¿˜ä¼šè¿›è¡Œä½œç”¨åŸŸåˆ†æï¼›ç¡®ä¿åœ¨ç§»é™¤ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå½±å“åˆ°å®é™…ä½¿ç”¨çš„ä»£ç æ­£ç¡®æ€§

  - ##### å®ç°æ¡ä»¶

    - ES2015æ¨¡å—è¯­æ³•
      - Tree-Shakingä¸»è¦ä¾èµ–äºES2015æ¨¡å—è¯­æ³•ï¼ˆimportã€exportï¼‰ï¼›è¿™ç§æ¨¡å—è¯­æ³•æ˜¯é™æ€çš„ï¼Œä½¿å¾—webpackèƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶ç¡®å®šæ¨¡å—çš„å¯¼å…¥å’Œå¯¼å‡ºå…³ç³»
      - ç›¸æ¯”ä¹‹ä¸‹ï¼ŒCommonJSæ¨¡å—è¯­æ³•ï¼ˆrequireã€module.exportsï¼‰æ˜¯åŠ¨æ€ï¼Œéš¾ä»¥åœ¨ç¼–è¯‘æ—¶è¿›è¡Œå‡†ç¡®çš„åˆ†æ
    - æ”¯æŒçš„æ¨¡å—ç±»å‹
    - Webpack ä¸ä»…å¯ä»¥å¯¹ JavaScript æ¨¡å—è¿›è¡Œ Tree Shakingï¼Œè¿˜å¯ä»¥å¯¹ä¸€äº›å…¶ä»–ç±»å‹çš„æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¦‚ CSS æ¨¡å—ï¼ˆé€šè¿‡ç‰¹å®šçš„åŠ è½½å™¨å’Œæ’ä»¶ï¼‰
    - å¯¹äºä¸åŒç±»å‹çš„æ¨¡å—ï¼ŒWebpack å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„æŠ€æœ¯å’Œç­–ç•¥æ¥å®ç° Tree Shaking
    - ç¦æ­¢å°†æ¨¡å—è½¬æˆ CommonJS

  - webpack5é»˜è®¤å¼€å¯

- #### sideEffects

  - å¦‚æœæ‰€æœ‰ä»£ç éƒ½ä¸åŒ…å«å‰¯ä½œç”¨ï¼Œå¯ä»¥ç›´æ¥è®¾ä¸ºfalseï¼Œå‘ŠçŸ¥å¯å®‰å…¨çš„åˆ é™¤æœªç”¨åˆ°çš„export
```js
	{
      "name": "your-project",
      "sideEffects": false
    }
```
	- æœ‰äº›ä»£ç å­˜åœ¨å‰¯ä½œç”¨æ—¶ï¼Œè®¾ç½®ä¸ºæ•°ç»„

```js
    {
      "name": "your-project",
      "sideEffects": ["./src/some-side-effectful-file.js", "*.css"]
    }
```
- #### usedExports
```js
optimization: {
	usedExports: true
}
```
- #### sideEffects æ›´ä¸ºæœ‰æ•ˆ æ˜¯å› ä¸ºå®ƒå…è®¸è·³è¿‡æ•´ä¸ªæ¨¡å—/æ–‡ä»¶å’Œæ•´ä¸ªæ–‡ä»¶å­æ ‘ã€‚
- #### å‰æ
	
	- ä½¿ç”¨es2015æ¨¡å—è¯­æ³•ï¼ˆå³importï¼Œexportï¼‰
	- ç¡®ä¿ç¼–è¯‘å™¨æ²¡æœ‰æŠŠes2015æ¨¡å—è½¬æ¢æˆcommonjs
### é€šè¿‡ webpack æŒ‰éœ€åŠ è½½ä»£ç ï¼Œæå–ç¬¬ä¸‰åº“ä»£ç ï¼ˆsplitChunkï¼‰
- å®ç° æå–ç¬¬ä¸‰æ–¹åº“ (webpack4çš„splitChunk)
	ç”±äºå¼•å…¥çš„ç¬¬ä¸‰æ–¹åº“ä¸€èˆ¬éƒ½æ¯”è¾ƒç¨³å®šï¼Œä¸ä¼šç»å¸¸æ”¹å˜ã€‚æ‰€ä»¥å°†å®ƒä»¬å•ç‹¬æå–å‡ºæ¥ï¼Œä½œä¸ºé•¿æœŸç¼“å­˜æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚
	è¿™é‡Œéœ€è¦ä½¿ç”¨ webpack4 çš„ splitChunk æ’ä»¶ cacheGroups é€‰é¡¹ã€‚
```js
optimization: {
      runtimeChunk: {
        name: 'manifest' // å°†webpackçš„runtimeä»£ç æ‹†åˆ†ä¸ºä¸€ä¸ªå•ç‹¬çš„ chunkã€‚
    },
    splitChunks: {
        cacheGroups: {
            vendor: {
                name: 'chunk-vendors',
                test: /[\\/]node_modules[\\/]/,
                priority: -10,
                chunks: 'initial', // (allï¼Œasync å’Œ initial)
            },
            common: {
                name: 'chunk-common',
                minChunks: 2,
                priority: -20,
                chunks: 'initial',
                reuseExistingChunk: true
            }
        },
    }
},
```
	test: ç”¨äºæ§åˆ¶å“ªäº›æ¨¡å—è¢«è¿™ä¸ªç¼“å­˜ç»„åŒ¹é…åˆ°ã€‚åŸå°ä¸åŠ¨ä¼ é€’å‡ºå»çš„è¯ï¼Œå®ƒé»˜è®¤ä¼šé€‰æ‹©æ‰€æœ‰çš„æ¨¡å—ã€‚å¯ä»¥ä¼ é€’çš„å€¼ç±»å‹ï¼šRegExpã€Stringå’ŒFunction;
	priorityï¼šè¡¨ç¤ºæŠ½å–æƒé‡ï¼Œæ•°å­—è¶Šå¤§è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚å› ä¸ºä¸€ä¸ª module å¯èƒ½ä¼šæ»¡è¶³å¤šä¸ª cacheGroups çš„æ¡ä»¶ï¼Œé‚£ä¹ˆæŠ½å–åˆ°å“ªä¸ªå°±ç”±æƒé‡æœ€é«˜çš„è¯´äº†ç®—ï¼›
	reuseExistingChunkï¼šè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨å·²æœ‰çš„ chunkï¼Œå¦‚æœä¸º true åˆ™è¡¨ç¤ºå¦‚æœå½“å‰çš„ chunk åŒ…å«çš„æ¨¡å—å·²ç»è¢«æŠ½å–å‡ºå»äº†ï¼Œé‚£ä¹ˆå°†ä¸ä¼šé‡æ–°ç”Ÿæˆæ–°çš„ã€‚
	minChunksï¼ˆé»˜è®¤æ˜¯1ï¼‰ï¼šåœ¨åˆ†å‰²ä¹‹å‰ï¼Œè¿™ä¸ªä»£ç å—æœ€å°åº”è¯¥è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆè¯‘æ³¨ï¼šä¿è¯ä»£ç å—å¤ç”¨æ€§ï¼Œé»˜è®¤é…ç½®çš„ç­–ç•¥æ˜¯ä¸éœ€è¦å¤šæ¬¡å¼•ç”¨ä¹Ÿå¯ä»¥è¢«åˆ†å‰²ï¼‰
	chunks (é»˜è®¤æ˜¯async) ï¼šinitialã€asyncå’Œall
	name(æ‰“åŒ…çš„chunksçš„åå­—)ï¼šå­—ç¬¦ä¸²æˆ–è€…å‡½æ•°(å‡½æ•°å¯ä»¥æ ¹æ®æ¡ä»¶è‡ªå®šä¹‰åå­—)
### webpackæ‰§è¡Œé¡ºåº
![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220212144013.png)
### é¢è¯•é¢˜
- å°†å›¾ç‰‡æ’å…¥åˆ°é¡µé¢ä¸­
	- è§£å†³æ–¹æ¡ˆ
		module ä¸‹é…ç½® rules
        module: {
            rules: [
                {
                    test:/\.(png|jpg)$/,
                    loader: 'file-loader'
                }
            ]
        }
- æŠ½ç¦»css
- æŠ½ç¦»å…¬å…±ä»£ç 

# **Babel æ·±åº¦è§£æ**

## 1. å®šä¹‰

- Babel æ˜¯ JS ç¼–è¯‘å™¨ï¼ˆå·¥å…·é“¾ï¼‰ï¼Œç”¨äº ES6+ â†’ å‘åå…¼å®¹ JSã€‚
- æœ¬è´¨å°±æ˜¯åœ¨æ“ä½œASTæ¥å®Œæˆä»£ç çš„ç¼–è¯‘ï¼›

## 2. æ ¸å¿ƒæµç¨‹

1. **è§£æ Parse**ï¼ˆ@babel/parserï¼‰
   - æºç  â†’ ASTï¼ˆhttps://astexplorer.net/ï¼‰
2. **è½¬æ¢ Transform**
   - ä½¿ç”¨æ’ä»¶ä¿®æ”¹ AST
   - ES6 â†’ ES5 æˆ–ä¼˜åŒ– AST
3. **ç”Ÿæˆ Generate**ï¼ˆ@babel/generatorï¼‰
   - AST â†’ JS å­—ç¬¦ä¸² + SourceMap

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220209103500.png)
![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220209103521.png)

## 3. æ ¸å¿ƒåº“

| åº“               | ä½œç”¨               |
| ---------------- | ------------------ |
| babel-core       | æ ¸å¿ƒ API           |
| babel-parser     | ç”Ÿæˆ AST           |
| babel-traverse   | éå† AST           |
| babel-generator  | AST â†’ JS           |
| babel-types      | èŠ‚ç‚¹æ„å»º/æ ¡éªŒ      |
| babel-template   | å­—ç¬¦ä¸² â†’ AST       |
| babel-runtime    | Polyfill / runtime |
| babel-plugin-xxx | è½¬æ¢æ’ä»¶           |
| babel-preset-xxx | æ’ä»¶é›†åˆ           |

## 4. Babel è½¬ ES6 â†’ ES5

- Loader é…ç½®ï¼š

```
{
  test: /\.js$/,
  exclude: /node_modules/,
  use: {
    loader: 'babel-loader',
    options: {
      presets: ['@babel/preset-env'],
      plugins: ['@babel/plugin-transform-runtime']
    }
  }
}
```

- Polyfill â†’ `core-js` + `regenerator-runtime`

> webpackæœ¬èº«æ˜¯ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨ï¼ˆbundlerï¼‰ï¼Œå¹¶ä¸ç›´æ¥è´Ÿè´£å°†ES6ä»£ç ç¼–è¯‘ä¸ºES5ï¼›webpackä¸»è¦åŠŸèƒ½æ˜¯å°†é¡¹ç›®ä¸­çš„æ‰€æœ‰æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªæˆ–å¤šä¸ªbundleï¼Œä»¥ä¾›æµè§ˆå™¨åŠ è½½
>
> webpackå¯ä»¥é€šè¿‡loaderå’Œpluginæ‰©å±•åŠŸèƒ½ï¼Œå®ç°ä»£ç çš„è½¬æ¢å’Œç¼–è¯‘

#### æ­¥éª¤

- babelè½¬æ¢

- loaderé…ç½®

- babelé¢„è®¾

  Babel ä½¿ç”¨é¢„è®¾ï¼ˆpresetsï¼‰æ¥å®šä¹‰è½¬æ¢è§„åˆ™ã€‚`@babel/preset-env` æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„é¢„è®¾ï¼Œå®ƒä¼šè‡ªåŠ¨é…ç½® Babel ä»¥å…¼å®¹ç›®æ ‡æµè§ˆå™¨çš„ç‰ˆæœ¬

- polyfills

  â€‹	ä¸ºäº†æ”¯æŒæ—§æµè§ˆå™¨ï¼ŒBabel è¿˜å¯ä»¥å¼•å…¥ polyfillsï¼Œè¿™äº›æ˜¯æä¾›ç°ä»£ JavaScript ç‰¹æ€§çš„ç¬¬ä¸‰æ–¹ä»£ç ç‰‡æ®µã€‚ä¾‹å¦‚ï¼Œ`core-js` å’Œ `regenerator-runtime` æ˜¯ä¸¤ä¸ªå¸¸ç”¨çš„ polyfill åº“

- è½¬æ¢è¿‡ç¨‹

  - è§£æ
  - è½¬æ¢
  - ç”Ÿæˆ

- Tree Shaking

- ä»£ç åˆ†å‰²

- ä¼˜åŒ–

### webpack-dev-server

webpack-dev-server æ˜¯ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå¿«é€Ÿå¼€å‘çš„ç¯å¢ƒï¼Œå¹¶ä¸”é…åˆWebpackä½¿ç”¨

- #### ä½œç”¨

  - è‡ªåŠ¨ç¼–è¯‘å’Œæ‰“åŒ…
    - ç›‘å¬æºæ–‡ä»¶çš„å˜åŒ–ï¼Œå½“æ–‡ä»¶å‘ç”Ÿæ”¹åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œæ‰“åŒ…
  - çƒ­æ¨¡å—æ›¿æ¢
  - ä»£ç†å’Œåå‘ä»£ç†
    - é…ç½®ä»£ç†Proxyï¼Œè§£å†³å¼€å‘ç¯å¢ƒè·¨åŸŸé—®é¢˜
  - è·¯ç”±å¤„ç†
  - é™æ€æ–‡ä»¶æœåŠ¡

# ğŸ”‘ Loader & Plugin åŒºåˆ«

## 1. **Loaderï¼ˆåŠ è½½å™¨ï¼‰**

### å®šä¹‰

- Loader æ˜¯ä¸€ä¸ª **è½¬æ¢å™¨**ï¼Œå®ƒå‘Šè¯‰ Webpack **å¦‚ä½•å¤„ç†æŸç±»æ–‡ä»¶**ã€‚
- æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥æºæ–‡ä»¶å†…å®¹ï¼Œè¾“å‡ºå¤„ç†åçš„å†…å®¹ã€‚

### ä½¿ç”¨åœºæ™¯

- è½¬æ¢é JS æ–‡ä»¶ï¼Œè®© Webpack èƒ½ç†è§£å®ƒä»¬ï¼š
  - `babel-loader` â†’ æŠŠ ES6+ è½¬æˆ ES5
  - `css-loader` â†’ å¤„ç† CSS ä¸­çš„ `@import` å’Œ `url()`
  - `file-loader / url-loader` â†’ å¤„ç†å›¾ç‰‡ã€å­—ä½“ç­‰èµ„æº
  - `ts-loader` â†’ å¤„ç† TypeScript

### ç‰¹ç‚¹

- **é’ˆå¯¹æŸä¸€ç±»æ–‡ä»¶**
- **ä½œç”¨äºæ–‡ä»¶çº§åˆ«**ï¼ˆåœ¨æ¨¡å—åŠ è½½æ—¶å¤„ç†æºä»£ç ï¼‰
- **æ˜¯ä¸€ä¸ªè½¬æ¢å‡½æ•°** `(source) => transformedSource`

### ç®€å•ç¤ºä¾‹

```
// my-loader.js
module.exports = function (source) {
  return source.replace('hello', 'hi');
};
```

Webpack é…ç½®ï¼š

```
module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/, 
        use: './my-loader.js'
      }
    ]
  }
}
```

------

## 2. **Pluginï¼ˆæ’ä»¶ï¼‰**

### å®šä¹‰

- Plugin æ˜¯ä¸€ä¸ª **æ‰©å±•å™¨**ï¼Œå®ƒåŸºäº Webpack çš„ **äº‹ä»¶æµæœºåˆ¶**ï¼Œå¯ä»¥åœ¨ç¼–è¯‘çš„ä¸åŒé˜¶æ®µæ³¨å…¥é€»è¾‘ã€‚
- æœ¬è´¨æ˜¯ä¸€ä¸ªåŒ…å« `apply(compiler)` æ–¹æ³•çš„å¯¹è±¡ã€‚

### ä½¿ç”¨åœºæ™¯

- æ›´åº•å±‚ã€æ›´å¹¿æ³›çš„åŠŸèƒ½æ‰©å±•ï¼š
  - ä¼˜åŒ–è¾“å‡ºï¼ˆ`TerserWebpackPlugin` å‹ç¼© JSï¼‰
  - æ³¨å…¥å˜é‡ï¼ˆ`DefinePlugin`ï¼‰
  - è‡ªåŠ¨ç”Ÿæˆ HTMLï¼ˆ`HtmlWebpackPlugin`ï¼‰
  - æ‹·è´é™æ€èµ„æºï¼ˆ`CopyWebpackPlugin`ï¼‰
  - è‡ªå®šä¹‰æ—¥å¿—ã€æ‰“åŒ…å®Œæˆé€šçŸ¥ç­‰

### ç‰¹ç‚¹

- **ä½œç”¨èŒƒå›´æ›´å¹¿**ï¼ˆæ•´ä¸ªç¼–è¯‘å‘¨æœŸéƒ½èƒ½ä»‹å…¥ï¼‰
- **é€šè¿‡ compiler / compilation çš„ hooks ä¸ Webpack äº¤äº’**
- **ä¸æ˜¯å¤„ç†æ–‡ä»¶å†…å®¹ï¼Œè€Œæ˜¯å¹²é¢„æ„å»ºæµç¨‹**

### ç®€å•ç¤ºä¾‹

```
// my-plugin.js
class MyPlugin {
  apply(compiler) {
    compiler.hooks.done.tap('MyPlugin', (stats) => {
      console.log('ğŸ‰ Build finished!');
    });
  }
}

module.exports = MyPlugin;
```

Webpack é…ç½®ï¼š

```
const MyPlugin = require('./my-plugin.js');

module.exports = {
  plugins: [
    new MyPlugin()
  ]
}
```

------

## 3. å¯¹æ¯”æ€»ç»“è¡¨

| å¯¹æ¯”é¡¹       | Loader                            | Plugin                                      |
| ------------ | --------------------------------- | ------------------------------------------- |
| **æœ¬è´¨**     | æ–‡ä»¶è½¬æ¢å™¨ï¼ˆå‡½æ•°ï¼‰                | æ„å»ºæµç¨‹æ‰©å±•å™¨ï¼ˆç±» / å¯¹è±¡ï¼Œå« apply æ–¹æ³•ï¼‰  |
| **ä½œç”¨æ—¶æœº** | æ¨¡å—åŠ è½½é˜¶æ®µï¼ˆæ‰“åŒ…å‰ï¼‰            | æ•´ä¸ªç¼–è¯‘ç”Ÿå‘½å‘¨æœŸ                            |
| **ä½œç”¨èŒƒå›´** | å•ä¸ªæ–‡ä»¶ç±»å‹                      | å…¨å±€æ„å»ºè¿‡ç¨‹                                |
| **è¾“å…¥è¾“å‡º** | è¾“å…¥ï¼šæºæ–‡ä»¶ â†’ è¾“å‡ºï¼šè½¬æ¢åä»£ç    | é€šè¿‡ hooks æ“ä½œ compiler / compilation å¯¹è±¡ |
| **å…¸å‹ç”¨é€”** | è½¬æ¢æ–‡ä»¶å†…å®¹ï¼ˆJSã€CSSã€å›¾ç‰‡ã€TSï¼‰ | ä¼˜åŒ–ã€æ³¨å…¥å˜é‡ã€ç”Ÿæˆæ–‡ä»¶ã€å‹ç¼©ã€æ—¥å¿—        |
| **ç¤ºä¾‹**     | babel-loaderã€css-loader          | HtmlWebpackPluginã€DefinePlugin             |

------

## 4. ä¸€ä¸ªç±»æ¯”å¸®åŠ©ç†è§£

- **Loader** åƒâ€œç¿»è¯‘å‘˜â€ â†’ æŠŠæºç ä» A è¯­è¨€ç¿»è¯‘æˆ JS è¯­è¨€ï¼ŒWebpack æ‰èƒ½ç†è§£ã€‚
- **Plugin** åƒâ€œå¯¼æ¼”â€ â†’ æ§åˆ¶æ•´ä¸ªæ‰“åŒ…æµç¨‹çš„ä¸åŒé˜¶æ®µï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™å¼€æœºã€åŠ ç‰¹æ•ˆã€å¯¼å‡ºç»“æœã€‚

------

ğŸ‘‰ æ€»ç»“ä¸€å¥è¯ï¼š
 **Loader è§£å†³â€œæ–‡ä»¶æ€ä¹ˆå¤„ç†â€ï¼ŒPlugin è§£å†³â€œæ„å»ºæµç¨‹æ€ä¹ˆæ‰©å±•â€ã€‚**
