# webpack5模块联邦的实践和应用

## 什么是联邦模块（Module Federation）

>联邦模块是webpack5提供的一个新特性，它是通过webpack原生提供的 `ModuleFederationPlugin` 插件来实现的。
>联邦模块主要是用来解决多个应用之间代码共享的问题，可以让我们的更加优雅的实现跨应用的代码共享

webpack官方解释： 多个独立的构建可以组成一个应用程序，这些独立的构建之间不应该存在依赖关系，因此可以单独开发和部署它们。

### 由来动机

- 模块联邦的动机是为了不同开发小组间开发一个或者多个应用。

- 应用将被划分为更小的应用块，一个应用块，例如头部导航或者侧边栏的前端组件。

- 每个应用块由不同的小组开发。

- 应用块需要共享给其他应用块或者容器。

## 概念

- remote：一个暴露模块供其它webpack应用消费的webpack应用

- host：一个消费其它remote模块的webpack应用

  一个webpack应用既可以是remote提供方，也可以是host服务消费方，也可同时扮演两种角色

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218215657.png)

## 底层分析

模块联邦区分本地模块和远程模块。本地模块即为普通模块，是当前构建的一部分。远程模块不属于当前构建，并在运行时从所谓的容器加载。

加载远程模块是一种异步操作。当使用远程模块时，这些异步操作将被放置在远程模块和入口之间的下一个 chunk 的加载操作中。如果没有 chunk 加载操作，就不能使用远程模块。

>注：
> chunk就是打包后的代码块。
>
>chunk是webpack打包过程中，一堆module的集合，我们知道webpack的打包是从一个入口文件开始，也可以说是入口模块，入口模块引用这其他模块，模块再引用模，webpack通过引用关系逐个打包模块，这些module就形成了一个chunk。
>
>如果我们有多个入口文件，可能会产出多条打包路径，一条路径就会形成一个Chunk。出了入口entry会产生Chunk。

chunk 的加载操作通常是通过调用 `import()` 实现的，这一点在后面的实战中会遇到。

## 项目配置

### remote应用

- 暴露远程模块

  ```javascript
  module.exports = {
    devServer: {
      port: '3001',
    },
    plugins: [
      new ModuleFederationPlugin({
        name: 'app1', // 该名称必须与入口名称相匹配 模块联邦名字，提供给其他模块使用
        filename: 'remoteEntry.js', // 提供给外部访问的资源入口
        exposes: { // 暴露的模块
            "./RmButton1": "./src/components/button.vue",
            "./RmUtils": "./src/utils/index.js"
        },
      }),
    ],
  };
  ```

### host应用

- 配置远程remote地址

  - 方法1 使用url配置

  ```javascript
  module.exports = {
    plugins: [
      new ModuleFederationPlugin({
        name: 'host',
        remotes: {
          app1: 'app1@http://localhost:3001/remoteEntry.js',
        },
      }),
    ],
  };
  ```

  - 方法2 向remote传递一个promise

    使用该方法，也可以在webpack4中调用远程的remote模块。

    ```javascript
    module.exports = {
      plugins: [
        new ModuleFederationPlugin({
          name: 'host',
          remotes: {
            app1: `promise new Promise(resolve => {
          const script = document.createElement('script')
          script.src = 'http://localhost:3001/remoteEntry.js'
          script.onload = () => {
            const proxy = {
              get: (request) => window.app1.get(request),
              init: (arg) => {
                try {
                  return window.app1.init(arg)
                } catch(e) {
                  console.log('remote container already initialized')
                }
              }
            }
            resolve(proxy)
          }
          document.head.appendChild(script);
        })
        `,
          }
        }),
      ],
    };
    ```

    

### 动态 Public Path

remote应用需要配置对应的publicPath，指向当前的地址

```
module.exports = {
	publicPath: 'http://localhost:3001'
}
```



## 项目实战

创建一个react项目，它的header和sidebar分别来自远程的react和vue模块，

实现react in react ，react in vue，vue in react的跨框架应用。

todo

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231219084431.png)



## 应用场景和解决的问题

### npm依赖包升级

当我们一个公共的模块组件被多个项目使用时，一般会打包成npm依赖包，通过发包的方式进行组件的方法和复用；

当npm包升级的时候，对于多个使用到该模块的项目，我们都需要一一升级和发布，造成效率低下。

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218220823.png)



而对于模块联邦，我们只需要升级对应的remote应用，发布一次，其它项目便会引用到最新的模块。

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218221518.png)

### 技术过时，开发体验差，维护成本高

每个公司多会有个别远古时期的项目，结合了jsp，jQuery，vue多种框架结合。如下图，每个发布代码都会造成一些困扰，也可能造成文件丢失问题；产品bug难于排查。

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218223143.png)

### 系统庞大，构建部署慢

一个重量级项目打包构建很慢，可以使用模块联邦，将项目分成几部分，独立打包独立部署。

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218225436.png)

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218225456.png)



## 应用成果

### 三明门户工作台改造

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218223809.png)

### 微前端登录模块

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218223739.png)

### AI助手弹窗

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218223708.png)

### 浏览器兼容提示

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20231218223640.png)