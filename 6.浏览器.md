## 浏览器
## **1️⃣ URL、URI、URN 区别**

| 名称    | 全称                        | 功能                                     | 举例                                         |
| ------- | --------------------------- | ---------------------------------------- | -------------------------------------------- |
| **URI** | Uniform Resource Identifier | 统一资源标识符，可唯一标识资源           | `https://example.com:8080/path?query=1#hash` |
| **URL** | Uniform Resource Locator    | 统一资源定位符，包含资源位置和访问方式   | `https://example.com/index.html`             |
| **URN** | Uniform Resource Name       | 统一资源名称，只标识资源名称，不包含位置 | `urn:isbn:0451450523`                        |

> 🔹 URL 是 URI 的子集；URN 只标识资源名称，不关心位置。

## **2️⃣ 浏览器存储机制**

| 类型           | 容量 | 生命周期                                   | 是否发送到服务器 |
| -------------- | ---- | ------------------------------------------ | ---------------- |
| Cookie         | ~4KB | 过期时间之前有效；未设置则随浏览器关闭消失 | ✅ 自动发送       |
| localStorage   | 5MB  | 永久保存，需手动删除                       | ❌ 不发送         |
| sessionStorage | 5MB  | 当前窗口关闭即失效                         | ❌ 不发送         |

> 🔹 Cookie 与 local/sessionStorage 最大差异：是否会自动随 HTTP 请求发送。

### 3️⃣ 浏览器输入 URL 的加载流程
![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220212124956.png)
- 输入URL

- 查找缓存
	- 浏览器先查看浏览器缓存-系统缓存-路由缓存中是否有该页面地址（缓存DNS）；
	
- DNS域名解析
	- 浏览向DNS服务器发起请求，解析域名对应的IP地址；（DNS服务器基于UDP）；
	
- 建立TCP连接
	- （三次握手）
	
- 发起HTTP请求
	- 请求报文作为TCP三次握手的第三次数据发送给服务器；
	
- 服务器响应请求并返回结果（html文件，和对应的资源文件）

- 关闭TCP连接
	- （四次挥手）
	
- 浏览器渲染（解析html内容并渲染）
	- 解析HTML，构建成DOM树
	- 解析CSS，构建CSS规则树
	- 构建render树：浏览器将DOM树和CSSOM结合，构建出渲染树（render tree）
	- 布局Layout：计算每个节点在屏幕中的位置
	- 绘制Painting：遍历render树，使用UI后端层绘制每个节点
	![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220212130000.png)

	![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100339.png)
	
- 处理JS交互 & 事件监听
  
  - js加载和执行，绑定事件监听
  - 页面动态更新（DOM操作，异步操作等）
  
- 触发异步请求（ajax，fetch）

- 浏览器缓存 & 断开连接
  - 浏览器缓存静态资源（css，js，图片等），加快下次访问速度
  - TCP四次挥手，关闭连接，释放资源

### 浏览器整体架构与进程模型

## **4️⃣ 浏览器进程模型**

| 进程                 | 数量           | 职责                                       |
| -------------------- | -------------- | ------------------------------------------ |
| 浏览器主进程         | 唯一           | UI、进程管理、下载、IPC(进程间通信)、权限  |
| 渲染进程             | 每个标签页独立 | HTML/CSS解析、JS执行、布局、绘制、事件循环 |
| GPU(图形处理器) 进程 | 全局唯一       | 图形加速（CSS动画、WebGL、视频）           |
| 网络进程             | 独立           | DNS解析、HTTP通信、缓存管理                |

🔹 渲染进程线程：

- GUI(图形用户界面)线程：绘制渲染
- JS引擎线程：执行 JS（单线程）
- 事件线程：事件队列管理
- 定时器线程：setTimeout/setInterval
- 异步 HTTP 线程：AJAX/fetch

> 💡 进程间通信通过**Mojo框架**或**IPC模块**实现，确保安全隔离

<img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100411.png" style="zoom:67%;" />

### DNS

- DNS解析流程

  - 浏览器缓存检查
    - 浏览器会先检查 【本地缓存】是否已存储该域名的IP地址，若有，则直接使用
  - 操作系统缓存检查
    - 若浏览器无缓存，则检查【操作系统（如Windows 的hosts文件）】，是否已经解析过该域名
  - 递归查询DNS缓存
    - 若本地无缓存，则系统向【本地DNS服务器（ISP提供）】请求解析
    - 若本地DNS服务器也找不到，向【跟DNS服务器】递归查询，依次向【顶级域名服务器（TLD，如*.com）、权威DNS服务器】继续查询，直到找到IP地址
  - 返回IP地址，访问网址
    - 获取IP地址后，DNS服务器将结果返回给浏览器，浏览器再向该IP发送请求，最终加载网页

- DNS解析优化

  - DNS预解析（DNS Prefetch）

    ```js
    <link rel="dns-prefetch" href="//cdn.example.com" >
    ```

  - CDN加速

  - 减少DNS查询次数（合并域名，避免多次查询）

### 缓存

浏览器缓存是为了提高页面加载速度和降低服务器压力，对资源（HTML、CSS、JS、图片等）在本地进行临时存储的机制。

通过缓存，浏览器可以在下一次请求相同资源时，直接使用本地存储的数据，而不是再次向服务器发起请求。

| **缓存类型** | **工作原理**                                   | **通信机制**                        | **存储位置**        | **更新时机**             |
| :----------- | :--------------------------------------------- | :---------------------------------- | :------------------ | :----------------------- |
| **强缓存**   | 浏览器直接使用本地缓存资源，不发送请求到服务器 | 无网络请求                          | 内存缓存/磁盘缓存   | 缓存过期时间到达         |
| **协商缓存** | 浏览器发送请求到服务器验证资源是否更新         | 每次发送请求，服务器返回304或新资源 | 内存缓存/磁盘缓存   | 资源内容发生变化         |
| **离线缓存** | Service Worker拦截请求并返回自定义缓存         | Service Worker控制                  | Cache API/IndexedDB | 开发者主动更新或策略触发 |

#### 强缓存

- ##### Expires（格式：Expires: \<HTTP-date>）

  - HTTP/1.0标准，绝对时间（如`Expires: Wed, 21 Oct 2025 07:28:00 GMT`）（资源失效的时间）

  <img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100440.png" style="zoom:67%;" />
  
- ##### Cache-Control（格式：Cache-Control: \<directive>）

  ## Cache-Control 详解

  ### 核心指令解析

  | **指令** | **值** | **说明**                                                     | **示例**               |
  | :------- | :----- | :----------------------------------------------------------- | :--------------------- |
  | max-age  | 秒数   | 资源有效期（从请求开始计算）                                 | `max-age=3600` (1小时) |
  | public   | -      | 允许任何缓存存储响应                                         | `public`               |
  | private  | -      | 仅允许客户端缓存响应                                         | `private`              |
  | no-store | -      | 禁止任何缓存                                                 | `no-store`             |
  | no-cache | -      | 可缓存但必须验证（使用`If-Modified-Since`或`If-None-Match`头部验证） | `no-cache`             |

  - HTTP/1.1标准，优先级更高（如`max-age=31536000`）（资源的有效期是 31536000 秒）

    <img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100502.png" style="zoom:67%;" />

```bash
HTTP/1.1 200 OK
Cache-Control: public, max-age=31536000
Expires: Wed, 21 Oct 2025 07:28:00 GMT
```

#### 协商缓存

第一次请求响应头带上Last-Modified 或Etag；后续请求带上对应的If-Modified-Since或If-None-Match；若第一次没有，第二次也没有

最终由服务器决定是否使用缓存，即客户端与服务端之间存在一次通信；由服务器来确定缓存资源是否可用。

- ##### Last-Modified + If-Modified-Since（基于修改时间）

  - **响应头：Last-Modified**

    - Last-Modified: Tue, 15 Nov 2022 12:45:26 GMT（服务器上资源的最后修改时间）

  - **请求头：If-Modified-Since**

    - If-Modified-Since: Tue, 15 Nov 2022 12:45:26 GMT（浏览器将上次收到的Last-Modified的值发送给服务器）

  - ##### 适用场景

    - 静态文件（图片、CSS、JS）
    - 修改频率较低的资源
    - 不需要精确到毫秒级的缓存验证

  - ##### 局限性

    - 时间精度只有1秒
    - 文件修改时间变化但内容未变时失效
    - 服务器时间不同步导致问题

    <img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100524.png" style="zoom:67%;" />
  
- ##### ETag + If-None-Match （基于内存哈希（更可靠））

  - ##### ETag（格式：ETag: [weak/]<etag_value>）

    - 强ETag: `ETag: "686897696a7c876b7e"` / 弱ETag: `ETag: W/"686897696a7c876b7e"`
    - 服务器生成的资源唯一标识符（通常是内容哈希值）
    - **强验证**：要求字节完全一致
    - **弱验证**：语义相同即可（如只改变空格）

  - ##### If-None-Match（格式：If-None-Match: <etag_value> | *）

    - 单个ETag: `If-None-Match: "686897696a7c876b7e"`
    - 多个ETag: `If-None-Match: "etag1", "etag2", W/"weak-etag"`
    - 任意ETag: `If-None-Match: *`
    - 浏览器将上次收到的ETag值发送给服务器
    - `*` 表示匹配任意ETag（用于检查资源是否存在）

<img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100545.png" style="zoom:67%;" />

#### 优先级

| **缓存类型**        | **优先级** | **触发条件**                                                 | **存储位置** | **更新机制**   |
| :------------------ | :--------- | :----------------------------------------------------------- | :----------- | :------------- |
| Service Worker 缓存 | 最高       | 请求被 Service Worker 拦截                                   | Cache API    | 开发者主动更新 |
| 内存缓存            | 高         | 会话期内高频访问资源                                         | RAM          | 页面关闭即清除 |
| 强缓存              | 中高       | Cache-Control/Expires 有效（优先级：Cache-Control > Expires） | 磁盘         | 过期时间到达   |
| 协商缓存            | 中低       | 强缓存失效，ETag/Last-Modified 有效（优先级：ETag > Last-Modified） | 磁盘         | 资源内容变化   |
| 网络请求            | 最低       | 所有缓存均未命中                                             | -            | 每次请求       |

<img src="https://i-coder.oss-cn-beijing.aliyuncs.com/files/20250824100611.png" style="zoom:67%;" />

## **7️⃣ 跨域处理**

- **同源策略**：协议、域名、端口都相同才算同源
- **解决方式**：
  - JSONP（动态 script 标签，仅支持 GET）
  - CORS（服务器配置 Access-Control-Allow-Origin）
  - Nginx 代理 / Node 转发
  - Document.domain + iframe
  - **WebSocket** 不受同源限制

## **8️⃣ 资源预加载**

| 类型     | 特点                                               | 使用场景               |
| -------- | -------------------------------------------------- | ---------------------- |
| prefetch | 低优先级，浏览器空闲时下载，缓存未来可能访问的资源 | 跨页面静态资源         |
| preload  | 高优先级，当前页面提前加载指定资源                 | 页面关键 CSS/JS/字体等 |

