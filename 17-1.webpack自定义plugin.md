### ç»Ÿè®¡æºç é‡Œé¢çš„ console.log è°ƒç”¨æ•°é‡ä¸è°ƒç”¨è·¯å¾„

- å®šä¹‰æ’ä»¶ç±»

  å®šä¹‰ä¸€ä¸ªJavaScriptç±»ï¼›åœ¨ç±»çš„applyæ–¹æ³•ä¸­ï¼Œç›‘å¬webpackçš„compilationé’©å­æ¥è®¿é—®å¤„ç†æ¨¡å—çš„æºä»£ç 

- ç›‘å¬é€‚å½“çš„webpacké’©å­

  é’ˆå¯¹æºä»£ç çš„å¤„ç†ï¼Œé€‰æ‹©ç›‘å¬compilationé˜¶æ®µçš„optimizeModuleé’©å­ï¼›åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ¨¡å—çš„æºä»£ç å¯ä»¥è¢«è®¿é—®å’Œä¿®æ”¹

- å¤„ç†æºä»£ç 

  å¤„ç†æ¯ä¸ªæ¨¡å—çš„æºä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼æ¥è¯†åˆ«console.logçš„è°ƒç”¨

```js
class ConsoleLogStatsPlugin {
  constructor(options = {}) {
    this.options = {
      showAll: false, // æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—ï¼ˆåŒ…æ‹¬æ²¡æœ‰ console.log çš„ï¼‰
      threshold: 0,  // åªæ˜¾ç¤ºè¶…è¿‡æ­¤æ•°é‡çš„æ¨¡å—
      ...options
    };
    this.stats = [];
  }
  apply(compiler) {
    compiler.hooks.compilation.tap("ConsoleLogStatsPlugin", (compilation) => {
      compilation.moduleTemplates.javascript.hooks.render.tap("ConsoleLogStatsPlugin", (moduleSource, module) => {
        if (!module.resource) return moduleSource;
        const source = moduleSource.source();
        const consoleLogMatches = source.match(/console\.(log|info|warn|error)\(/g) || [];
        const count = consoleLogMatches.length;
        if (count > this.options.threshold || this.options.showAll) {
          this.stats.push({
            path: module.resource,
            count,
            warnings: consoleLogMatches.filter(c => c.includes('.warn')).length,
            errors: consoleLogMatches.filter(c => c.includes('.error')).length,
            logs: consoleLogMatches.filter(c => c.includes('.log')).length,
            infos: consoleLogMatches.filter(c => c.includes('.info')).length
          });
        }
        return moduleSource;
      });
      // åœ¨ç¼–è¯‘å®Œæˆåè¾“å‡ºç»Ÿè®¡ç»“æœ
      compilation.hooks.afterProcessAssets.tap("ConsoleLogStatsPlugin", () => {
        if (this.stats.length > 0) {
          const total = this.stats.reduce((sum, item) => sum + item.count, 0);
          console.log(`\nğŸ“Š Console Log Statistics (${total} calls in ${this.stats.length} modules):`);
          this.stats
            .sort((a, b) => b.count - a.count)
            .forEach(item => {
              const relativePath = item.path.replace(process.cwd(), '');
              const typeStats = [
                item.logs > 0 ? `log: ${item.logs}` : '',
                item.infos > 0 ? `info: ${item.infos}` : '',
                item.warnings > 0 ? `warn: ${item.warnings}` : '',
                item.errors > 0 ? `error: ${item.errors}` : ''
              ].filter(Boolean).join(', ');
              console.log(`  ${relativePath}: ${item.count} calls (${typeStats})`);
            });
        } else {
          console.log('\nâœ… No console.log calls found in any modules.');
        }
      });
    });
  }
}
module.exports = ConsoleLogStatsPlugin;
```



### è·å–ç™»å½•tokençš„webpackæ’ä»¶

```js
import request from 'request';
import colors from 'colors';
import type { Compiler, Compilation, WebpackError, Stats } from 'webpack';
import type { InnerCallback } from 'tapable';
// å®šä¹‰å›è°ƒå‡½æ•°ç±»å‹
type Callback<T> = (err?: null | WebpackError, result?: T) => void;
// æ’ä»¶é…ç½®é€‰é¡¹æ¥å£
interface Options {
  url: string;                    // ç™»å½•æ¥å£çš„ URL
  params: any;                   // ç™»å½•è¯·æ±‚çš„å‚æ•°ï¼ˆç”¨æˆ·åã€å¯†ç ç­‰ï¼‰
  tokenKeyName: string | undefined;      // å“åº”æ•°æ®ä¸­ token å­—æ®µçš„åç§°
  localStorageKey: string | undefined;   // å­˜å‚¨åˆ° localStorage çš„é”®å
  extraObj: {} | undefined;      // é¢å¤–éœ€è¦åˆå¹¶è¿› localStorage çš„å¯¹è±¡
}
/**
 * LoginWebpackPlugin - è‡ªåŠ¨ç™»å½•æ’ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * 1. åœ¨ webpack ç¼–è¯‘å‰è‡ªåŠ¨è°ƒç”¨ç™»å½•æ¥å£
 * 2. è·å–ç™»å½• token æˆ–å…¶ä»–è®¤è¯ä¿¡æ¯
 * 3. å°†è®¤è¯ä¿¡æ¯æ³¨å…¥åˆ° HTML é¡µé¢çš„ localStorage ä¸­
 * 4. ä¸»è¦ç”¨äºå¼€å‘ç¯å¢ƒï¼Œé¿å…æ¯æ¬¡åˆ·æ–°éƒ½éœ€è¦é‡æ–°ç™»å½•
 */
class LoginWebpackPlugin {
  // æ’ä»¶é…ç½®é€‰é¡¹ï¼ŒåŒ…å«é»˜è®¤å€¼
  private options: Options = {
    url: "",                      // ç™»å½•æ¥å£ URL
    extraObj: undefined,          // é¢å¤–å¯¹è±¡
    params: {},                   // ç™»å½•å‚æ•°
    tokenKeyName: undefined,      // token å­—æ®µå
    localStorageKey: undefined    // localStorage é”®å
  };
  // å­˜å‚¨ç™»å½•æ¥å£è¿”å›çš„æ•°æ®
  private obj: null | {};
  /**
   * æ„é€ å‡½æ•° - åˆå§‹åŒ–æ’ä»¶é…ç½®
   * @param options ç”¨æˆ·ä¼ å…¥çš„é…ç½®é€‰é¡¹
   */
  constructor(options: Options) {
    // éªŒè¯å¿…éœ€å‚æ•°
    if (!options.url) {
      throw new Error('login-webpack-plugin: url is required');
    }
    if (!options.params) {
      throw new Error('login-webpack-plugin: params is required');
    }
    // è®¾ç½®é…ç½®é€‰é¡¹ï¼Œæä¾›é»˜è®¤å€¼
    this.options.url = options.url;
    this.options.extraObj = options.extraObj;
    this.options.tokenKeyName = options?.tokenKeyName ?? 'token';        // é»˜è®¤ token å­—æ®µåä¸º 'token'
    this.options.localStorageKey = options?.localStorageKey ?? 'token';  // é»˜è®¤ localStorage é”®åä¸º 'token'
    this.options.params = options.params;
    
    // åˆå§‹åŒ–ç™»å½•æ•°æ®ä¸º null
    this.obj = null;
  }
  /**
   * è°ƒç”¨ç™»å½•æ¥å£
   * @param cb å›è°ƒå‡½æ•°ï¼Œç”¨äºé€šçŸ¥ webpack å¼‚æ­¥æ“ä½œå®Œæˆ
   */
  callLoginApi(cb: (params: any) => void) {
    // å‘é€ HTTP POST è¯·æ±‚åˆ°ç™»å½•æ¥å£
    request({
      url: this.options.url,        // ç™»å½•æ¥å£ URL
      method: 'POST',               // ä½¿ç”¨ POST æ–¹æ³•
      headers: {
        'Content-type': 'application/json'  // è®¾ç½®è¯·æ±‚å¤´ä¸º JSON æ ¼å¼
      },
      timeout: 5000,                // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’
      json: this.options.params,    // å‘é€çš„ç™»å½•å‚æ•°ï¼ˆä¼šè‡ªåŠ¨åºåˆ—åŒ–ä¸º JSONï¼‰
    }, (err, response, body) => {
      // å¤„ç†è¯·æ±‚é”™è¯¯
      if (err) {
        console.log(colors.red.underline(err));  // çº¢è‰²ä¸‹åˆ’çº¿æ˜¾ç¤ºé”™è¯¯
        cb(err);
        return;
      }
      // æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦æˆåŠŸï¼ˆå‡è®¾ code === 0 è¡¨ç¤ºæˆåŠŸï¼‰
      if (body.code === 0) {
        // å¤„ç†ç™»å½•æˆåŠŸçš„æƒ…å†µ
        if (this.options.extraObj) {
          // å¦‚æœæœ‰é¢å¤–å¯¹è±¡éœ€è¦åˆå¹¶
          const originalObj = typeof body.data[this.options.tokenKeyName || 'token'] === 'string' 
            ? {
                // å¦‚æœ token æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ›å»ºå¯¹è±¡åŒ…è£…å®ƒ
                [this.options.tokenKeyName as string]: body.data[this.options.tokenKeyName || 'token']
              } 
            : body.data[this.options.tokenKeyName || 'token'];  // å¦‚æœ token å·²ç»æ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
          // åˆå¹¶åŸå§‹æ•°æ®å’Œé¢å¤–å¯¹è±¡
          this.obj = { ...originalObj, ...this.options.extraObj };
        } else {
          // ç›´æ¥ä½¿ç”¨æ¥å£è¿”å›çš„ token æ•°æ®
          this.obj = body.data[this.options.tokenKeyName || 'token'];
        }
        cb(null);  // é€šçŸ¥ webpack å¼‚æ­¥æ“ä½œæˆåŠŸå®Œæˆ
      } else {
        // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        console.log(colors.red.bold(body?.msg ?? "ç™»å½•æ¥å£é”™è¯¯"));
        cb(new Error(body?.msg ?? body?.message));
      }
    });
  }
  /**
   * apply æ–¹æ³• - webpack æ’ä»¶çš„æ ¸å¿ƒæ–¹æ³•
   * @param compiler webpack ç¼–è¯‘å™¨å®ä¾‹
   */
  apply(compiler: Compiler) {
    // è·å– HtmlWebpackPluginï¼Œç”¨äºæ“ä½œ HTML æ¨¡æ¿
    const HtmlWebpackPlugin = require('html-webpack-plugin');
    /**
     * 1. beforeCompile é’©å­ - åœ¨ç¼–è¯‘å¼€å§‹å‰æ‰§è¡Œ
     * ç›®çš„ï¼šç¡®ä¿åœ¨ç¼–è¯‘å‰å®Œæˆç™»å½•ï¼Œè·å–åˆ°è®¤è¯ä¿¡æ¯
     */
    compiler.hooks.beforeCompile.tapAsync(
      'LoginWebpackPlugin', 
      (compilation: Compilation['params'], cb: InnerCallback<Error, void>) => {
        // å¦‚æœè¿˜æ²¡æœ‰ç™»å½•æ•°æ®ï¼Œåˆ™è°ƒç”¨ç™»å½•æ¥å£ï¼›å¦åˆ™ç›´æ¥ç»§ç»­
        this.obj === null ? this.callLoginApi(cb) : cb();
      }
    );
    /**
     * 2. compilation é’©å­ - åœ¨æ¯æ¬¡ç¼–è¯‘æ—¶æ‰§è¡Œ
     * ç›®çš„ï¼šæ³¨å†Œ HTML å¤„ç†é’©å­ï¼Œå‘ HTML ä¸­æ³¨å…¥ç™»å½•ä¿¡æ¯
     */
    compiler.hooks.compilation.tap('LoginWebpackPlugin', (compilation: Compilation) => {
      // è·å– HtmlWebpackPlugin çš„é’©å­
      const hooks = HtmlWebpackPlugin.getHooks(compilation);
      /**
       * afterTemplateExecution é’©å­ - åœ¨ HTML æ¨¡æ¿æ‰§è¡Œå
       * ç›®çš„ï¼šå‘ç”Ÿæˆçš„ HTML ä¸­æ³¨å…¥ JavaScript ä»£ç ï¼Œå°†ç™»å½•ä¿¡æ¯å­˜å‚¨åˆ° localStorage
       */
      HtmlWebpackPlugin.getHooks(compilation).afterTemplateExecution.tapAsync(
        'LoginWebpackPlugin', 
        (htmlPluginData: {html: any}, callback: Callback<{html: any}>) => {
          // ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹æ³¨å…¥ç™»å½•ä¿¡æ¯
          if (process.env.NODE_ENV === 'development') {
            
            // æ ¹æ®æ•°æ®ç±»å‹ç”Ÿæˆä¸åŒçš„æ³¨å…¥è„šæœ¬
            if (typeof this.obj === 'object') {
              // å¦‚æœç™»å½•æ•°æ®æ˜¯å¯¹è±¡ç±»å‹
              htmlPluginData.html += `
              <script>
                // å°†ç™»å½•æ•°æ®å¯¹è±¡åŒ–
                const a = ${JSON.stringify(this.obj)};
                // å°†æ•´ä¸ªå¯¹è±¡å­˜å‚¨åˆ° localStorage
                window.localStorage.setItem(${JSON.stringify(this.options.localStorageKey)}, JSON.stringify(a));
              </script>`;
            } else if (typeof this.obj === 'string') {
              // å¦‚æœç™»å½•æ•°æ®æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆé€šå¸¸æ˜¯ tokenï¼‰
              htmlPluginData.html += `
              <script>
                // è·å–å­—ç¬¦ä¸²å½¢å¼çš„ token
                const a = ${JSON.stringify(this.obj)};
                // ç›´æ¥å­˜å‚¨å­—ç¬¦ä¸²åˆ° localStorage
                window.localStorage.setItem(${JSON.stringify(this.options.localStorageKey)}, a);
              </script>`;
            }
          }
          // è°ƒç”¨å›è°ƒï¼Œç»§ç»­ webpack ç¼–è¯‘æµç¨‹
          callback(null, htmlPluginData);
        }
      );
    });
    /**
     * 3. done é’©å­ - ç¼–è¯‘å®Œæˆåæ‰§è¡Œ
     * ç›®çš„ï¼šè¾“å‡ºæ’ä»¶æ‰§è¡Œç»“æœï¼Œç”¨äºè°ƒè¯•å’Œç¡®è®¤
     */
    compiler.hooks.done.tapAsync(
      'LoginWebpackPlugin', 
      (compilation: Stats, cb: InnerCallback<Error, void>) => {
        // ä»¥ç»¿è‰²ç²—ä½“æ˜¾ç¤ºè·å–åˆ°çš„ç™»å½•ä¿¡æ¯
        console.log(colors.green.bold(`\nlogin-webpack-plugin:${JSON.stringify(this.obj)}\n`));
        cb();  // é€šçŸ¥ webpack å¼‚æ­¥æ“ä½œå®Œæˆ
      }
    );
  }
}
// å¯¼å‡ºæ’ä»¶ç±»
export = LoginWebpackPlugin;
```

