# **Web Worker & Service Worker å…¨é¢è§£æ**

------

## **ä¸€ã€Web Worker**

### **1. åŸºæœ¬æ¦‚å¿µ**

- **å®šä¹‰**
   Web Worker æ˜¯æµè§ˆå™¨æä¾›çš„ JavaScript å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œå¯åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚

  > ä¸èƒ½ç›´æ¥æ“ä½œ DOMï¼Œä¸ä¸»çº¿ç¨‹é€šè¿‡ `postMessage` é€šä¿¡ã€‚

- **ä¸ºä»€ä¹ˆéœ€è¦**

  - é¿å…å¤æ‚è®¡ç®—é˜»å¡ UI æ¸²æŸ“
  - æå‡åº”ç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦
  - æµè§ˆå™¨ä¸»çº¿ç¨‹ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼ˆä»»åŠ¡æŒ‰é˜Ÿåˆ—æ‰§è¡Œï¼‰
  - **é•¿ä»»åŠ¡é—®é¢˜**ï¼šå½“ä»»åŠ¡ > 50msï¼Œç”¨æˆ·äº¤äº’ã€æ¸²æŸ“ä¼šè¢«å»¶è¿Ÿï¼Œå¯¼è‡´ï¼š
    - é«˜äº¤äº’å»¶è¿Ÿï¼ˆHigh/variable input latencyï¼‰
    - äº‹ä»¶å›è°ƒå»¶è¿Ÿ
    - åŠ¨ç”»å’Œæ»šåŠ¨å¡é¡¿ï¼ˆJanky animationsï¼‰

- **ç±»å‹**

  | ç±»å‹                         | ç‰¹ç‚¹                              |
  | ---------------------------- | --------------------------------- |
  | ä¸“ç”¨ Worker (Dedicated)      | åªè¢«åˆ›å»ºå®ƒçš„é¡µé¢ä½¿ç”¨              |
  | å…±äº« Worker (Shared)         | å¯è¢«åŒæºå¤šä¸ªé¡µé¢å…±äº«              |
  | æœåŠ¡ Worker (Service Worker) | ç”¨äºç¦»çº¿ç¼“å­˜ã€æ¶ˆæ¯æ¨é€ç­‰ PWA åŠŸèƒ½ |

#### ç”Ÿå‘½å‘¨æœŸ

```mermaid
graph LR
A[ä¸»çº¿ç¨‹åˆ›å»ºWorker] --> B[Workeråˆå§‹åŒ–]
B --> C[æ¶ˆæ¯ä¼ é€’]
C --> D[ä»»åŠ¡å¤„ç†]
D --> E[å‘é€ç»“æœ]
E --> F[é”€æ¯Worker]
```

#### å…³é”®ç‰¹æ€§ä¸é™åˆ¶

- æ”¯æŒçš„åŠŸèƒ½
  - setTimeoutã€setInterval
  - XMLHttpRequestã€fetch
  - WebSocket
  - IndexedDB
  - importScripts()ï¼ˆåŠ è½½å¤–éƒ¨è„šæœ¬ï¼‰
  - Navigatorï¼ˆå¯¹è±¡éƒ¨åˆ†å±æ€§ï¼‰
- é™åˆ¶
  - æ— æ³•ç›´æ¥è®¿é—®DOM
  - æ— æ³•ä½¿ç”¨windowã€documentã€parentå¯¹è±¡
  - æ— æ³•è®¿é—®ä¸»çº¿ç¨‹ä½œç”¨åŸŸå˜é‡
  - åŒæºç­–ç•¥é™åˆ¶

#### æ ¸å¿ƒAPI

```js
// ä¸»çº¿ç¨‹ä»£ç 
const worker = new Worker('worker.js');
// å‘é€æ¶ˆæ¯ç»™ Worker
worker.postMessage({ type: 'CALCULATE', data: 100 });
// æ¥æ”¶ Worker æ¶ˆæ¯
worker.onmessage = (event) => {
  console.log('Result:', event.data);
};
// é”™è¯¯å¤„ç†
worker.onerror = (error) => {
  console.error('Worker error:', error);
};
// ç»ˆæ­¢ Worker
worker.terminate();
```

```js
// worker.js
self.onmessage = (event) => {
  if (event.data.type === 'CALCULATE') {
    const result = heavyCalculation(event.data.data);
    self.postMessage(result);
  }
};
function heavyCalculation(n) {
  // å¤æ‚è®¡ç®—é€»è¾‘
  let sum = 0;
  for (let i = 0; i <= n; i++) {
    sum += i;
  }
  return sum;
}


// ç»ˆæ­¢ Worker
self.close();
```

### ç¤ºä¾‹

- é¢„åŠ è½½èµ„æºæ–‡ä»¶

  ä¸»è¿›ç¨‹

  ```js
  // èµ„æºåˆ—è¡¨
  const resources = [
      { id: 'css1', type: 'css', name: 'Bootstrap CSS', url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' },
      { id: 'img1', type: 'image', name: 'Large Image 1', url: 'https://picsum.photos/1200/800?random=1' },
      { id: 'img2', type: 'image', name: 'Large Image 2', url: 'https://picsum.photos/1200/800?random=2' },
      { id: 'js1', type: 'script', name: 'Utility Library', url: 'https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js' },
      { id: 'font1', type: 'font', name: 'Google Font', url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;' },
      { id: 'css2', type: 'css', name: 'Icons CSS', url: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css' },
      { id: 'img3', type: 'image', name: 'Large Image 3', url: 'https://picsum.photos/1200/800?random=3' }
  ];
  // åˆå§‹åŒ– Web Worker
  function initWorker () {
      if (worker) {
          return;
      }
      try {
          worker = new Worker('preload-file-worker.js');
          worker.onmessage = (e) => {
              const { id, type } = e.data;
              if (e.data.error) {
                  updateResourceStatus(id, 'error');
                  updateStatus(`åŠ è½½å¤±è´¥: ${id} - ${e.data.error}`, 'error');
              } else {
                  updateResourceStatus(id, 'loaded');
                  updateStatus(`å·²åŠ è½½: ${id}`, 'success');
                  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥å¤„ç†åŠ è½½çš„èµ„æº 
                  // ä½¿ç”¨é¢„åŠ è½½èµ„æºæ–¹æ³•
              }
          };
          updateStatus('Web Worker å·²åˆå§‹åŒ–', 'success');
      } catch (error) {
          updateStatus(`åˆ›å»ºWorkerå¤±è´¥: ${error.message}`, 'error');
      }
  }
  // å¼€å§‹é¢„åŠ è½½èµ„æº
  function startPreloading () {
      if (!worker) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–Worker', 'error');
          return;
      }
      // å¼€å§‹é€šè¿‡WorkeråŠ è½½
      resources.forEach(resource => {
          updateResourceStatus(resource.id, 'loading');
          worker.postMessage({
              id: resource.id,
              type: resource.type,
              url: resource.url
          });
      });
      updateStatus('å¼€å§‹åœ¨Workerä¸­é¢„åŠ è½½èµ„æº...', 'info');
  }
  // ç»ˆæ­¢ Worker
  function terminateWorker () {
      if (worker) {
          worker.terminate();
          worker = null;
          updateStatus('Web Worker å·²ç»ˆæ­¢', 'info');
      }
  }
  ```

  preload-file-worker.js

  ```js
  self.onmessage = async (e) => {
    const { type, url, id } = e.data;
    try {
      switch (type) {
        case 'css':
          const cssResponse = await fetch(url);
          const cssText = await cssResponse.text();
          self.postMessage({ id, type, content: cssText });
          break;
        case 'image':
          const imgResponse = await fetch(url);
          const blob = await imgResponse.blob();
          const imageBitmap = await createImageBitmap(blob);
          self.postMessage({ id, type, imageBitmap }, [imageBitmap]);
          break;
        case 'script':
          // ä½¿ç”¨importScriptsåŒæ­¥åŠ è½½
          importScripts(url);
          self.postMessage({ id, type, status: 'loaded' });
          break;
        case 'font':
          const fontResponse = await fetch(url);
          const fontBuffer = await fontResponse.arrayBuffer();
          const base64Font = arrayBufferToBase64(fontBuffer);
          self.postMessage({ id, type, fontData: base64Font });
          break;
      }
    } catch (error) {
      self.postMessage({ id, type, error: error.message });
    }
  };
  function arrayBufferToBase64 (buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }
  ```

  ä½¿ç”¨é¢„åŠ è½½èµ„æº

  ```js
  function useCss() {
      // åˆ›å»ºæ–°çš„styleæ ‡ç­¾å¹¶æ·»åŠ CSSå†…å®¹
      const style = document.createElement('style');
      style.textContent = xxx;
      document.head.appendChild(style);
  }
  function useImages() {
      imageIds.forEach(id => {
          const blob = xxx;
          // åˆ›å»ºå¯ç”¨çš„å›¾ç‰‡URL
          const url = URL.createObjectURL(blob);
          const img = document.createElement('img');
          img.src = url;
          document.body.appendChild(img);
      });
  }
  function useScript() {
      // åˆ›å»ºæ–°çš„scriptæ ‡ç­¾å¹¶æ·»åŠ è„šæœ¬å†…å®¹
      const script = document.createElement('script');
      script.textContent = 'xxx';
      document.body.appendChild(script);
      
      // æ£€æŸ¥è„šæœ¬æ˜¯å¦å¯ç”¨
      setTimeout(() => {
          if (xxx) {
              console.log('Lodashå·²åŠ è½½');
          }
      }, 100);
  }
  ```

### Service Worker

#### æ˜¯ä»€ä¹ˆ

è¿è¡Œåœ¨æµè§ˆå™¨ç‹¬ç«‹çº¿ç¨‹é‡Œçš„è„šæœ¬ï¼Œèƒ½æ‹¦æˆªç½‘ç»œè¯·æ±‚ã€ç®¡ç†ç¼“å­˜ï¼Œä»è€Œå®ç°ç¦»çº¿èƒ½åŠ›ã€è¯·æ±‚åŠ é€Ÿã€ç‰ˆæœ¬æ›´æ–°æ§åˆ¶ã€æ¶ˆæ¯æ¨é€ç­‰ï¼›å®ƒæœ‰è‡ªå·±ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆinstall â†’ activate â†’ running â†’ updateï¼‰ã€‚

#### ç”Ÿå‘½å‘¨æœŸ

1. **æ³¨å†Œ**ï¼ˆé¡µé¢ä¾§ï¼‰
    `navigator.serviceWorker.register('/service-worker.js', { scope: '/' })`

2. **å®‰è£…**ï¼ˆSW å†…ï¼‰

   - äº‹ä»¶ï¼š`install`

   - å¸¸åšï¼šé¢„ç¼“å­˜ï¼ˆ`caches.open().addAll()` / Workbox precacheï¼‰

   - ç»“æŸäº `installed`ï¼Œé€šå¸¸å¤„äº **waiting**ï¼ˆç­‰å¾…æ¥ç®¡ï¼‰

3. **æ¿€æ´»**ï¼ˆSW å†…ï¼‰

   - äº‹ä»¶ï¼š`activate`

   - å¸¸åšï¼šæ¸…æ—§ç¼“å­˜ã€`clients.claim()`ï¼ˆæ¿€æ´»åç«‹å³æ¥ç®¡é¡µé¢ï¼‰

4. **è¿è¡ŒæœŸ**

   - äº‹ä»¶ï¼š`fetch`ï¼ˆæ‹¦æˆªè¯·æ±‚å¹¶è‡ªå®šä¹‰å“åº”ï¼‰

   - å…¶ä»–ï¼š`message`ã€`push`ã€`sync`ã€`periodicsync`ã€`notificationclick` ç­‰

   - SW ç©ºé—²ä¼šè¢«æ€æ‰ï¼Œæœ‰äº‹ä»¶å†å”¤é†’

5. **æ›´æ–°**

   - æµè§ˆå™¨åœ¨å¯¼èˆªæˆ– `registration.update()` æ—¶æŠ“å– `/service-worker.js`ï¼Œ**å­—èŠ‚æœ‰å˜åŒ–**å°±è®¤ä¸ºâ€œæœ‰æ–°ç‰ˆæœ¬â€

   - æ–° SW è¿›å…¥ `installing â†’ installed(waiting)`ï¼Œé»˜è®¤ç­‰å¾…æ—§ SW æ§åˆ¶çš„é¡µé¢å…¨éƒ¨å…³é—­ï¼Œéšå `activate`ï¼›æ—§ SW è¿›å…¥ `redundant`

   - å¯ç”¨ `skipWaiting()` è®©æ–° SW ç«‹åˆ»è·³è¿‡ç­‰å¾…

**é¡µé¢ä¾§è¾…åŠ©äº‹ä»¶**

- `registration.onupdatefound`ï¼šå‘ç°æ–° SW
- `navigator.serviceWorker.oncontrollerchange`ï¼šæ§åˆ¶ SW æ›´æ¢ï¼ˆæ–° SW æ¥ç®¡é¡µé¢ï¼‰

#### â€œæœ‰æ›´æ–°â€çš„åˆ¤å®šä¸åº”ç”¨ï¼ˆå’Œäº¤äº’çš„å…³ç³»ï¼‰

##### 	ä½•æ—¶è¢«åˆ¤å®šæœ‰æ›´æ–°ï¼Ÿ

- åªè¦ `/service-worker.js` **å­—èŠ‚çº§æœ‰å˜åŒ–**ï¼ˆé€šå¸¸å› ä¸º Workbox çš„ precache manifest æ”¹äº†ï¼‰ï¼Œæµè§ˆå™¨å°±ä¼šåœ¨ç”¨æˆ·è®¿é—®/åˆ·æ–°æ—¶æ£€æµ‹åˆ° â†’ è§¦å‘ `updatefound`ã€‚

##### 	é¦–æ¬¡å®‰è£… vs çœŸæ­£æ›´æ–°

- é¦–æ¬¡å®‰è£…æ—¶ `navigator.serviceWorker.controller === null`ï¼Œä¸è¦å¼¹â€œæœ‰æ–°ç‰ˆæœ¬â€
- åªæœ‰å½“ `controller` éç©ºï¼ˆå·²æœ‰æ—§ SW æ§åˆ¶é¡µé¢ï¼‰ä¸”æ–° SW `installed` æ—¶ï¼Œæ‰æ˜¯â€œæ£€æµ‹åˆ°æ›´æ–°â€

##### 	å¦‚ä½•è®©æ–°ç‰ˆæœ¬ç”Ÿæ•ˆï¼Ÿä¸¤ç§æ¨¡å¼

- **æ¸©å’Œæ¨¡å¼ï¼ˆæ¨èï¼‰**ï¼šæç¤ºç”¨æˆ· â†’ ç”¨æˆ·ç‚¹å‡»
  - é¡µé¢å‘ waiting worker å‘é€ `{type:'SKIP_WAITING'}`
  - SW å†… `self.skipWaiting()` â†’ è§¦å‘ `controllerchange` â†’ åˆ·æ–°
- **æ¿€è¿›æ¨¡å¼**ï¼š`skipWaiting: true` + `clientsClaim: true`ï¼Œæ–° SW ç›´æ¥æ¥ç®¡ï¼ˆå¯èƒ½æ‰“æ–­ç”¨æˆ·æµç¨‹ï¼‰

##### 	å¸¸ç”¨ä»£ç è¦ç‚¹

- æ›´æ–°æ£€æµ‹ï¼š`registration.onupdatefound` + `newWorker.state === 'installed'` + `controller` åˆ¤æ–­
- åº”ç”¨æ›´æ–°ï¼š`waiting.postMessage({ type:'SKIP_WAITING' })`ï¼›é¡µé¢ç›‘å¬ `statechange` æˆ– `controllerchange` å `location.reload()`

#### å¸¸è§é—®é¢˜

- service-worker.jsï¼šä¸èƒ½è®¾ç½®ç¼“å­˜ï¼Œå¦åˆ™ä¸æ›´æ–°
  - Cache-Control: no-cache, no-store, must-revalidate
- HTMLï¼šä¸è¦æŠŠindex.htmlè®¾ç½®å¼ºç¼“å­˜
- HTTPSï¼šåªæœ‰localhostå’Œhttpsæ‰æœ‰æ•ˆæœ

#### åŠŸèƒ½

- ##### ç¼“å­˜ç­–ç•¥

- ##### ç¦»çº¿è®¿é—®PWAï¼ˆæ¸è¿›å¼Webåº”ç”¨ï¼‰

- ##### é¡¹ç›®éƒ¨ç½²æ¨é€é€šçŸ¥ç”¨æˆ·åˆ·æ–°

  - ä¸€ã€é…ç½®è¯´æ˜ï¼ˆRsbuild + Workboxï¼‰
  
    ```js
    // rsbuild.config.ts
    import { defineConfig } from '@rsbuild/core';
    import { pluginReact } from '@rsbuild/plugin-react';
    import { GenerateSW } from 'workbox-webpack-plugin';
    export default defineConfig({
      plugins: [pluginReact()],
      tools: {
        rspack(config) {
          config.plugins.push(
            new GenerateSW({
              swDest: 'service-worker.js', // è¾“å‡ºæ–‡ä»¶å
              clientsClaim: true, // æ–° SW æ¿€æ´»åç«‹åˆ»æ¥ç®¡é¡µé¢
              skipWaiting: false, // éœ€è¦æ‰‹åŠ¨è°ƒç”¨ skipWaiting
              cleanupOutdatedCaches: true, // è‡ªåŠ¨æ¸…ç†æ—§ç¼“å­˜
              runtimeCaching: [
                {
                  // ç¼“å­˜é™æ€èµ„æº
                  urlPattern: ({ request }) =>
                    request.destination === 'script' ||
                    request.destination === 'style',
                  handler: 'StaleWhileRevalidate', // æ–°æ—§å¹¶å­˜ï¼Œåå°æ›´æ–°
                },
              ],
            }),
          );
        },
      },
    });
    ```
  
  - äºŒã€å‰ç«¯å…¥å£æ³¨å†Œ Service Worker
  
    ```js
    // index.tsx
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    import App from './App';
    const rootEl = document.getElementById('root');
    if (rootEl) {
      ReactDOM.createRoot(rootEl).render(<App />);
    }
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/service-worker.js')
          .then((registration) => {
            console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
            // æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬
            registration.onupdatefound = () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.onstatechange = () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // å‘ React æ´¾å‘äº‹ä»¶
                    window.dispatchEvent(
                      new CustomEvent('sw-update', { detail: registration.waiting }),
                    );
                  }
                };
              }
            };
          })
          .catch((err) => {
            console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', err);
          });
      });
    }
    
    ```
  
  - ä¸‰ã€React é‡Œç›‘å¬å¹¶æç¤ºç”¨æˆ·æ›´æ–°
  
    ```js
    import { useEffect, useState } from 'react';
    const App = () => {
      const [updateAvailable, setUpdateAvailable] = useState(false);
      const [waitingWorker, setWaitingWorker] = useState<ServiceWorker | null>(null);
      const [isReloading, setIsReloading] = useState(false);
      useEffect(() => {
        const handler = (e: Event) => {
          const custom = e as CustomEvent<ServiceWorker>;
          console.log('[SW] æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬');
          setUpdateAvailable(true);
          setWaitingWorker(custom.detail);
        };
        window.addEventListener('sw-update', handler);
        return () => window.removeEventListener('sw-update', handler);
      }, []);
      const reloadApp = () => {
        if (!waitingWorker) return;
        setIsReloading(true);
        // é€šçŸ¥ SW è·³è¿‡ç­‰å¾…é˜¶æ®µï¼Œç«‹åˆ»æ¿€æ´»
        waitingWorker.postMessage({ type: 'SKIP_WAITING' });
        waitingWorker.addEventListener('statechange', (e) => {
          if ((e.target as ServiceWorker).state === 'activated') {
            window.location.reload();
          }
        });
      };
      return (
        <div>
          <h1>ğŸš€ Rsbuild with React 18</h1>
          {updateAvailable && (
            <div style={{ position: 'fixed', bottom: 20, right: 20, background: '#333', color: '#fff', padding: '10px' }}>
              <span>å‘ç°æ–°ç‰ˆæœ¬ï¼</span>
              <button onClick={reloadApp} disabled={isReloading}>
                {isReloading ? 'æ›´æ–°ä¸­...' : 'ç«‹å³æ›´æ–°'}
              </button>
            </div>
          )}
        </div>
      );
    };
    export default App;
    ```
  
    

### **Web Worker** & **Service Worker**

#### âš™ï¸ **ä¸€ã€æ ¸å¿ƒå®šä¹‰ä¸è®¾è®¡ç›®æ ‡**

1. **Web Worker**
   - **å®šä¹‰**ï¼šåœ¨åå°ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬ï¼Œç”¨äºå¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚å¤æ‚ç®—æ³•ã€å¤§æ•°æ®å¤„ç†ï¼‰ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹çš„ UI æ¸²æŸ“
   - **ç±»å‹**ï¼š
     - **ä¸“ç”¨ Workerï¼ˆDedicated Workerï¼‰**ï¼šä»…æœåŠ¡äºåˆ›å»ºå®ƒçš„é¡µé¢
     - **å…±äº« Workerï¼ˆShared Workerï¼‰**ï¼šå¯è¢«åŒæºä¸‹çš„å¤šä¸ªé¡µé¢å…±äº«
2. **Service Worker**
   - **å®šä¹‰**ï¼šä½œä¸ºç½‘ç»œä»£ç†ï¼Œæ‹¦æˆªå’Œå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå®ç°ç¦»çº¿ç¼“å­˜ã€æ¨é€é€šçŸ¥ç­‰ PWAï¼ˆæ¸è¿›å¼ Web åº”ç”¨ï¼‰åŠŸèƒ½ã€‚ç‹¬ç«‹äºé¡µé¢è¿è¡Œï¼Œç”Ÿå‘½å‘¨æœŸæ›´é•¿
   - **æ ¸å¿ƒèƒ½åŠ›**ï¼šç¼“å­˜æ§åˆ¶ã€åå°åŒæ­¥ã€æ¨é€æ¶ˆæ¯

#### ğŸ§© **äºŒã€å…³é”®æŠ€æœ¯ç‰¹æ€§å¯¹æ¯”**

| **ç‰¹æ€§**         | **Web Worker**                      | **Service Worker**                         |
| :--------------- | :---------------------------------- | :----------------------------------------- |
| **ç”Ÿå‘½å‘¨æœŸ**     | éšé¡µé¢å…³é—­ç»ˆæ­¢                      | ç‹¬ç«‹äºé¡µé¢ï¼Œå¯é•¿æœŸè¿è¡Œï¼ˆç›´åˆ°æµè§ˆå™¨å›æ”¶ï¼‰16 |
| **DOM è®¿é—®**     | âŒ ä¸å¯è®¿é—®                          | âŒ ä¸å¯è®¿é—®                                 |
| **ç½‘ç»œè¯·æ±‚æ§åˆ¶** | ä»…èƒ½å‘èµ·è¯·æ±‚ï¼Œæ— æ³•æ‹¦æˆª              | âœ… å¯æ‹¦æˆªå¹¶ä¿®æ”¹è¯·æ±‚ï¼ˆé€šè¿‡ `fetch` äº‹ä»¶ï¼‰    |
| **å­˜å‚¨èƒ½åŠ›**     | æ”¯æŒ IndexedDBï¼ˆå¼‚æ­¥ APIï¼‰          | æ”¯æŒ Cache APIã€IndexedDB                  |
| **ä½œç”¨èŒƒå›´**     | å•é¡µé¢æˆ–åŒæºå¤šé¡µé¢ï¼ˆShared Workerï¼‰ | æ§åˆ¶ä½œç”¨åŸŸå†…æ‰€æœ‰é¡µé¢ï¼ˆå¦‚æ•´ä¸ªåŸŸåï¼‰         |
| **é€šä¿¡æœºåˆ¶**     | `postMessage` ä¸ä¸»çº¿ç¨‹é€šä¿¡          | `postMessage`ã€`BroadcastChannel`          |
| **å®‰å…¨è¦æ±‚**     | æ”¯æŒ HTTP/HTTPS                     | å¿…é¡»é€šè¿‡ HTTPSï¼ˆæœ¬åœ°å¼€å‘é™¤å¤–ï¼‰             |

#### âš¡ï¸ **ä¸‰ã€å…¸å‹åº”ç”¨åœºæ™¯**

1. **Web Worker é€‚ç”¨åœºæ™¯**
   - **CPU å¯†é›†å‹ä»»åŠ¡**ï¼šå›¾åƒå¤„ç†ã€ç‰©ç†æ¨¡æ‹Ÿã€å¤§æ•°æ®è®¡ç®—
   - **éé˜»å¡æ“ä½œ**ï¼šé•¿æ—¶é—´è½®è¯¢ï¼ˆå¦‚ WebSocket ç®¡ç†ï¼‰
2. **Service Worker é€‚ç”¨åœºæ™¯**
   - **ç¦»çº¿ä½“éªŒ**ï¼šç¼“å­˜é™æ€èµ„æºï¼ˆHTML/CSS/JSï¼‰ï¼Œæ— ç½‘ç»œæ—¶ä»å¯è®¿é—®é¡µé¢
   - **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜ä¼˜å…ˆç­–ç•¥åŠ é€Ÿèµ„æºåŠ è½½
   - **é«˜çº§åŠŸèƒ½**ï¼šæ¨é€é€šçŸ¥ï¼ˆPush APIï¼‰ã€åå°æ•°æ®åŒæ­¥ï¼ˆBackground Syncï¼‰

#### ğŸ”„ **å››ã€ç”Ÿå‘½å‘¨æœŸä¸å·¥ä½œæµç¨‹**

- **Web Worker**ï¼š
  åˆ›å»º â†’ æ‰§è¡Œä»»åŠ¡ â†’ é¡µé¢å…³é—­æ—¶ç»ˆæ­¢
  ç¤ºä¾‹ä»£ç ï¼š

  ```js
  // ä¸»çº¿ç¨‹
  const worker = new Worker('worker.js');
  worker.postMessage('å¼€å§‹è®¡ç®—');
  worker.onmessage = (e) => console.log(e.data);
  ```

- **Service Worker**ï¼š
  **æ³¨å†Œ** â†’ **å®‰è£…**ï¼ˆç¼“å­˜èµ„æºï¼‰â†’ **æ¿€æ´»**ï¼ˆæ¸…ç†æ—§ç¼“å­˜ï¼‰â†’ **æ‹¦æˆªè¯·æ±‚**
  ç¤ºä¾‹ä»£ç ï¼š

  ```js
  // æ³¨å†Œ Service Worker
  navigator.serviceWorker.register('sw.js');
  // sw.js ä¸­ç›‘å¬äº‹ä»¶
  self.addEventListener('install', (e) => {
    e.waitUntil(caches.open('v1').then(cache => cache.addAll(['/index.html'])));
  });
  self.addEventListener('fetch', (e) => {
    e.respondWith(caches.match(e.request));
  });
  ```

#### ğŸ› ï¸ **äº”ã€æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹**

1. **Web Worker**
   - **å¤ç”¨å®ä¾‹**ï¼šé¿å…é¢‘ç¹åˆ›å»ºä»¥å‡å°‘å¼€é”€
   - **é”™è¯¯å¤„ç†**ï¼šç›‘å¬ `onerror` äº‹ä»¶æ•è·å¼‚å¸¸
2. **Service Worker**
   - **ç¼“å­˜ç­–ç•¥**ï¼šæ ¹æ®èµ„æºç±»å‹é€‰æ‹©ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚ Cache-first æˆ– Network-firstï¼‰
   - **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯æ¬¡æ›´æ–°éœ€ä¿®æ”¹ç¼“å­˜åç§°ï¼Œé¿å…å†²çª
   - **ä½œç”¨åŸŸé™åˆ¶**ï¼šç¼©å° `scope` èŒƒå›´ï¼ˆå¦‚ `/app/` ç›®å½•ï¼‰