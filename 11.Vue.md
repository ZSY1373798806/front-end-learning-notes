## Vue
## 1ï¸âƒ£ ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰

### é˜¶æ®µä¸é’©å­

| é˜¶æ®µ          | é’©å­                      | ç‰¹ç‚¹                               |
| ------------- | ------------------------- | ---------------------------------- |
| åˆ›å»º(create)  | beforeCreate â†’ created    | æ•°æ®æœªåˆå§‹åŒ– vs æ•°æ®å·²å¯ç”¨ä½†æœªæŒ‚è½½ |
| æŒ‚è½½(mount)   | beforeMount â†’ mounted     | å¯å‘è¯·æ±‚ vs å¯æ“ä½œ DOM             |
| æ›´æ–°(update)  | beforeUpdate â†’ updated    | æ•°æ®å˜åŒ–è§¦å‘                       |
| é”€æ¯(destroy) | beforeDestroy â†’ destroyed | å¯æ¸…ç†æ‰‹åŠ¨èµ„æº vs å·²é”€æ¯           |

**æ‰§è¡Œé¡ºåºæ³¨æ„ç‚¹ï¼š**

- ç»„ä»¶åˆ›å»ºæ—¶çˆ¶ä¼˜å…ˆï¼Œå­åï¼ˆçˆ¶beforeCreate â†’ å­beforeCreate â†’ â€¦ â†’ å­mounted â†’ çˆ¶mountedï¼‰
- æ›´æ–°æ—¶ï¼šçˆ¶beforeUpdate â†’ å­beforeUpdate â†’ å­updated â†’ çˆ¶updated
- é”€æ¯æ—¶ï¼šçˆ¶beforeDestroy â†’ å­beforeDestroy â†’ å­destroyed â†’ çˆ¶destroyed

> é¢è¯•å¸¸è€ƒï¼šçˆ¶å­æ‰§è¡Œé¡ºåºã€ç”Ÿå‘½å‘¨æœŸé’©å­ä½œç”¨åœºæ™¯ã€‚

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220211225838.png)

## 2ï¸âƒ£ Vue.use åŸç†

ä¸€ã€`Vue.use` çš„ä½œç”¨

- ç”¨æ¥ **å®‰è£…æ’ä»¶**ï¼ˆpluginï¼‰ï¼Œé¿å…é‡å¤å®‰è£…ã€‚
- æ’ä»¶ä¸€èˆ¬æ˜¯ç»™ Vue æ·»åŠ  **å…¨å±€åŠŸèƒ½**ï¼Œæ¯”å¦‚ï¼š
  - ç»™ `Vue.prototype` æŒ‚è½½æ–¹æ³•ï¼›
  - æ³¨å†Œå…¨å±€ç»„ä»¶ï¼›
  - æ³¨å†Œå…¨å±€æŒ‡ä»¤ï¼›
  - æ··å…¥å…¨å±€é…ç½®ã€‚

äºŒã€æºç ç®€åŒ–ç‰ˆï¼ˆVue 2.xï¼‰

```js
Vue.use = function (plugin) {
  const installedPlugins = this._installedPlugins || (this._installedPlugins = [])

  // é¿å…é‡å¤å®‰è£…
  if (installedPlugins.indexOf(plugin) > -1) {
    return this
  }

  // å–å‡ºåç»­å‚æ•°ï¼Œä¼ ç»™ install
  const args = toArray(arguments, 1)
  args.unshift(this) // æŠŠ Vue ä¼ ç»™ install

  // æ’ä»¶çš„ install æ–¹æ³•
  if (typeof plugin.install === 'function') {
    plugin.install.apply(plugin, args)
  } else if (typeof plugin === 'function') {
    plugin.apply(null, args)
  }

  installedPlugins.push(plugin)
  return this
}
```

ä¸‰ã€æ ¸å¿ƒé€»è¾‘

1. **ç»´æŠ¤å·²å®‰è£…æ’ä»¶çš„åˆ—è¡¨**
   - é€šè¿‡ `Vue._installedPlugins` æ•°ç»„ï¼Œé¿å…å¤šæ¬¡è°ƒç”¨ `Vue.use` é‡å¤å®‰è£…ã€‚
2. **å¤„ç† install æ–¹æ³•**
   - å¦‚æœæ’ä»¶å¯¹è±¡æœ‰ `install` æ–¹æ³• â†’ è°ƒç”¨ `plugin.install(Vue, ...args)`
   - å¦‚æœæ’ä»¶æœ¬èº«æ˜¯å‡½æ•° â†’ ç›´æ¥è°ƒç”¨ `plugin(Vue, ...args)`
3. **ä¼ å…¥å‚æ•°**
   - é»˜è®¤ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `Vue` æ„é€ å‡½æ•°ï¼›
   - åé¢æ˜¯ `Vue.use(plugin, options)` ä¼ å…¥çš„é¢å¤–å‚æ•°ã€‚

å››ã€æ’ä»¶ç¤ºä¾‹

```js
// å®šä¹‰ä¸€ä¸ªæ’ä»¶
const MyPlugin = {
  install(Vue, options) {
    // 1. ç»™åŸå‹æŒ‚æ–¹æ³•
    Vue.prototype.$hello = function () {
      console.log('Hello from plugin!')
    }

    // 2. æ³¨å†Œå…¨å±€ç»„ä»¶
    Vue.component('my-component', {
      template: '<div>æˆ‘æ˜¯å…¨å±€ç»„ä»¶</div>'
    })
  }
}

// ä½¿ç”¨æ’ä»¶
Vue.use(MyPlugin, { someOption: true })

// ä½¿ç”¨æ•ˆæœ
new Vue({
  created() {
    this.$hello() // Hello from plugin!
  }
})
```

------

âœ… æ€»ç»“ä¸€å¥ï¼š
 `Vue.use` å°±æ˜¯ä¸€ä¸ª **æ’ä»¶æ³¨å†Œå™¨**ï¼Œç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”ç»™æ’ä»¶ä¼ å…¥ `Vue` å®ä¾‹å’Œå‚æ•°ã€‚æ’ä»¶æœ¬è´¨å°±æ˜¯é€šè¿‡ **æ‰©å±• Vue åŸå‹ / å…¨å±€æ³¨å†Œ** æ¥å¢å¼º Vue åŠŸèƒ½ã€‚

## 3ï¸âƒ£ nextTick åŸç†

- **ä½œç”¨**ï¼šä¿è¯åœ¨ DOM æ›´æ–°åæ‰§è¡Œå›è°ƒã€‚

   - **DOM æ›´æ–°æ˜¯åœ¨ flushSchedulerQueue é‡Œå®Œæˆçš„**

   - **nextTick çš„å›è°ƒæ˜¯åœ¨ DOM æ›´æ–°å®Œæˆä¹‹åæ‰ä¼šè§¦å‘çš„**

     ```js
     æ•°æ®å˜æ›´
        â†“
     dep.notify() â†’ watcher.update()
        â†“
     queueWatcher(watcher)   // åŠ å…¥æ›´æ–°é˜Ÿåˆ—
        â†“
     nextTick(flushSchedulerQueue)   // å¼‚æ­¥ç­‰å¾…
        â†“
     flushSchedulerQueue()   // æ‰¹é‡æ‰§è¡Œ watcher.run() â†’ è§¦å‘ patch â†’ æ›´æ–° DOM
        â†“
     DOM å·²ç»æ›´æ–°å®Œæˆ
        â†“
     flushCallbacks()   // æ‰§è¡Œæ‰€æœ‰ nextTick å›è°ƒ
     ```

     

- **ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ‹¿åˆ° DOMï¼Ÿ**
   Vue æ˜¯å¼‚æ­¥æ¸²æŸ“ï¼Œæ•°æ®ä¿®æ”¹åŒæ­¥æ‰§è¡Œï¼ŒDOM æ›´æ–°å¼‚æ­¥ã€‚

- **æ ¸å¿ƒåŸç†**ï¼šå¾®ä»»åŠ¡ + å®ä»»åŠ¡é˜Ÿåˆ—

| æ–¹æ³•             | ä¼˜å…ˆçº§ | è¯´æ˜              |
| ---------------- | ------ | ----------------- |
| Promise          | é«˜     | å¾®ä»»åŠ¡ï¼Œæ€§èƒ½æœ€ä¼˜  |
| MutationObserver | æ¬¡é«˜   | ç›‘å¬ DOM å˜åŠ¨è§¦å‘ |
| setImmediate     | ä¸­     | IE ä¸“å±           |
| setTimeout       | ä½     | å®ä»»åŠ¡ï¼Œå…œåº•      |

- #### åŸç†

  - åˆ©ç”¨äº‹ä»¶å¾ªç¯
    - Vueçš„nextTickå®ç°åˆ©ç”¨äº†JavaScriptçš„äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼›åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼ŒJavaScriptæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œäº‹ä»¶å¾ªç¯è´Ÿè´£ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº
    - Vueå°†nextTickçš„å›è°ƒå‡½æ•°æ”¾å…¥å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡é˜Ÿåˆ—
    - å½“å½“å‰æ‰§è¡Œæ ˆä¸ºç©ºæ—¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œï¼›å¦‚æœå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡ï¼Œä¼šå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œç„¶ååœ¨æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›è¿™æ ·å¯ä»¥ç¡®ä¿nextTickçš„å›è°ƒå‡½æ•°åœ¨DOMæ›´æ–°ä¹‹åæ‰§è¡Œ
  - å†…éƒ¨å®ç°
    - Vueå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨nextTickçš„å›è°ƒå‡½æ•°ï¼›å½“è°ƒç”¨nextTickæ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­
    - Vueåœ¨æ›´æ–°DOMä¹‹åï¼Œä¼šæ£€æŸ¥è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼›å¦‚æœä¸ä¸ºç©ºï¼Œä¼šå–å‡ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ
    - è¿™æ ·å°±ä¿è¯äº†åœ¨DOMæ›´æ–°å®Œæˆä¹‹åï¼ŒnextTickçš„å›è°ƒå‡½æ•°èƒ½å¤ŸæŒ‰ç…§è°ƒç”¨çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ

  ![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220219161533.png)

- **æµç¨‹**ï¼š

  - å›è°ƒåŠ å…¥ `callbacks` é˜Ÿåˆ—
  - `timerFunc()` æ”¾å…¥å¾®/å®ä»»åŠ¡
  - æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ›´æ–° DOM åå›è°ƒè§¦å‘

> é¢è¯•é—®æ³•ï¼š`nextTick` ä¸ `setTimeout(fn,0)` çš„åŒºåˆ« â†’ nextTick ä¼˜å…ˆå¾®ä»»åŠ¡ï¼Œæ€§èƒ½æ›´é«˜ï¼Œæ¸²æŸ“æ›´ç²¾å‡†ã€‚

> DOMæ›´æ–°æ˜¯åŒæ­¥çš„ï¼›UIæ¸²æŸ“æ˜¯åœ¨æ‰€æœ‰å¾®ä»»åŠ¡å®Œæˆä¹‹åï¼Œæ˜¯å¼‚æ­¥çš„ï¼›æˆ‘ä»¬åœ¨nextTické‡Œæ‹¿åˆ°çš„æ•°æ®ï¼Œæ˜¯æ›´æ–°åçš„DOMï¼Œå› ä¸ºdiffç®—æ³•å’Œpatchè¡¥ä¸å·²ç»ç®—å‡ºæ¥äº†ï¼Œå¹¶ä½œç”¨åœ¨DOMä¸Š

```js
// Vue æºç èŠ‚é€‰ï¼ˆnext-tick.jsï¼‰
if (typeof Promise !== 'undefined') {
  // ä¼˜å…ˆä½¿ç”¨ Promise
  const p = Promise.resolve()
  timerFunc = () => p.then(flushCallbacks)
} else if (typeof MutationObserver !== 'undefined') {
  // é™çº§æ–¹æ¡ˆ 1ï¼šMutationObserver
  const observer = new MutationObserver(flushCallbacks)
  // ç›‘å¬ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹å†…å®¹è§¦å‘å›è°ƒ
} else if (typeof setImmediate !== 'undefined') {
  // é™çº§æ–¹æ¡ˆ 2ï¼šsetImmediateï¼ˆIEï¼‰
  timerFunc = () => setImmediate(flushCallbacks)
} else {
  // æœ€ç»ˆé™çº§ï¼šsetTimeout
  timerFunc = () => setTimeout(flushCallbacks, 0)
}

/**
 * åšäº†3ä»¶äº‹
 * 1ã€å°†pendingç½®ä¸ºfalse
 * 2ã€æ¸…ç©ºcallbacksæ•°ç»„
 * 3ã€æ‰§è¡Œcallbacksæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°ï¼ˆæ¯”å¦‚flushSchedulerQueueã€ç”¨æˆ·è°ƒç”¨nextTickä¼ é€’çš„å›è°ƒå‡½æ•°ï¼‰
 */
function flushCallbacks () {
  pending = false
  const copies = callbacks.slice(0)
  callbacks.length = 0
  /* éå†callbacksæ•°ç»„ï¼Œæ‰§è¡Œå…¶ä¸­å­˜å‚¨çš„æ¯ä¸ªflushSchedulerQueueå‡½æ•° */
  for (let i = 0; i < copies.length; i++) {
    copies[i]()
  }
}

/**
 * å®Œæˆä¸¤ä»¶äº‹
 * 1ã€ç”¨try catchåŒ…è£…flushSchedulerQueueå‡½æ•°ï¼Œç„¶åå°†å…¶æ”¾å…¥callbacksæ•°ç»„
 * 2ã€å¦‚æœpendingä¸ºfalseï¼Œè¡¨ç¤ºç°åœ¨æµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰flushCallbackså‡½æ•°ï¼›
 *  å¦‚æœpendingä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­å·²ç»è¢«æ”¾å…¥äº†flushCallbackså‡½æ•°ï¼›
 *  å¾…æ‰§è¡ŒflushCallbackså‡½æ•°æ—¶ï¼Œpendingä¼šè¢«å†æ¬¡ç½®ä¸ºfalseï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªflushCallbackså‡½æ•°å¯ä»¥è¿›å…¥æµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—äº†
 * pendingï¼šä¿è¯åœ¨åŒä¸€æ—¶åˆ»ï¼Œæµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—åªæœ‰ä¸€ä¸ªflushCallbackså‡½æ•°
 * @param {*} cb æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•° => flushSchedulerQueue
 * @param {*} ctx ä¸Šä¸‹æ–‡
 * @returns 
 */
/**
 * æµç¨‹ï¼š
 *  1ã€æŠŠå›è°ƒå‡½æ•°æ”¾å…¥callbacksç­‰å¾…æ‰§è¡Œ
 *  2ã€å°†æ‰§è¡Œçš„å‡½æ•°æ”¾åˆ°å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ä¸­
 *  3ã€äº‹ä»¶å¾ªç¯åˆ°äº†å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ï¼Œæ‰§è¡Œå‡½æ•°ä¾æ¬¡æ‰§è¡Œcallbacksä¸­çš„å›è°ƒ
 * 
 * DOMæ›´æ–°æ˜¯åŒæ­¥çš„ï¼›
 * UIæ¸²æŸ“æ˜¯åœ¨æ‰€æœ‰å¾®ä»»åŠ¡å®Œæˆä¹‹åï¼Œæ˜¯å¼‚æ­¥çš„ï¼›
 * æˆ‘ä»¬åœ¨nextTické‡Œæ‹¿åˆ°çš„æ•°æ®ï¼Œæ˜¯æ›´æ–°åçš„DOMï¼Œå› ä¸ºdiffç®—æ³•å’Œpatchè¡¥ä¸å·²ç»ç®—å‡ºæ¥çš„ï¼Œå¹¶ä½œç”¨åœ¨DOMä¸Š
 */
export function nextTick (cb?: Function, ctx?: Object) {
  let _resolve
  /* ç”¨callbacksæ•°ç»„å­˜å‚¨ç»è¿‡åŒ…è£…çš„cbå‡½æ•° */
  callbacks.push(() => {
    if (cb) {
      /* ç”¨try catchåŒ…è£…å›è°ƒå‡½æ•°ï¼Œä¾¿äºé”™è¯¯æ•è· */
      try {
        cb.call(ctx)
      } catch (e) {
        handleError(e, ctx, 'nextTick')
      }
    } else if (_resolve) {
      _resolve(ctx)
    }
  })
  if (!pending) {
    pending = true
    /* æ‰§è¡ŒtimerFuncï¼Œåœ¨æµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ˆé¦–é€‰å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰æ”¾å…¥flushCallbackså‡½æ•° */
    timerFunc()
  }
  // $flow-disable-line
  if (!cb && typeof Promise !== 'undefined') {
    return new Promise(resolve => {
      _resolve = resolve
    })
  }
}
```

### Vueé€‰é¡¹åˆå¹¶ç­–ç•¥

## 1ï¸âƒ£ æ¦‚å¿µ

- Vue å…è®¸æˆ‘ä»¬åœ¨ **å®ä¾‹åŒ– Vue æˆ–åˆ›å»ºå­ç»„ä»¶æ—¶ä¼ å…¥é…ç½®å¯¹è±¡**ï¼Œä¾‹å¦‚ï¼š

```js
const parent = Vue.extend({
  data() { return { a: 1 } },
  methods: { foo() { console.log('parent') } }
})

const child = new parent({
  data() { return { b: 2 } },
  methods: { foo() { console.log('child') } }
})
```

- Vue å†…éƒ¨éœ€è¦æŠŠ **çˆ¶çº§é€‰é¡¹å’Œå­çº§é€‰é¡¹åˆå¹¶**ï¼Œè¿™å°±æ˜¯ **é€‰é¡¹åˆå¹¶ç­–ç•¥**ï¼ˆ`mergeOptions`ï¼‰ã€‚

------

## 2ï¸âƒ£ åˆå¹¶è§„åˆ™åˆ†ç±»

### ï¼ˆ1ï¼‰å¯¹è±¡ç±»å‹ï¼ˆdata, methods, computed, watchï¼‰

- **è§„åˆ™**ï¼šå­å¯¹è±¡è¦†ç›–çˆ¶å¯¹è±¡çš„åŒåå±æ€§ï¼›å¦‚æœçˆ¶å­éƒ½å­˜åœ¨ä¸åŒå±æ€§ï¼Œåˆå¹¶ä¿ç•™å…¨éƒ¨ã€‚
- **ä¸¾ä¾‹**ï¼š

```js
const parent = {
  data: { a: 1 },
  methods: { foo() { console.log('parent') } }
}

const child = {
  data: { b: 2 },
  methods: { bar() { console.log('child') } }
}

const merged = Vue.util.mergeOptions(parent, child)
/*
merged.data -> { a:1, b:2 }
merged.methods -> { foo: fn, bar: fn }
*/
```

------

### ï¼ˆ2ï¼‰ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆcreated, mounted ç­‰ï¼‰

- **è§„åˆ™**ï¼šçˆ¶å­é’©å­åˆå¹¶ä¸º **æ•°ç»„**ï¼Œä¾æ¬¡æ‰§è¡Œã€‚
- **é¡ºåº**ï¼šçˆ¶é’©å­å…ˆæ‰§è¡Œ â†’ å­é’©å­åæ‰§è¡Œ
- **ç¤ºä¾‹**ï¼š

```js
const parent = { created() { console.log('parent created') } }
const child = { created() { console.log('child created') } }

const merged = Vue.util.mergeOptions(parent, child)
merged.created.forEach(fn => fn())  
// è¾“å‡ºï¼šparent created
//       child created
```

> é¢è¯•å¸¸è€ƒç‚¹ï¼šé’©å­æ‰§è¡Œé¡ºåºçˆ¶ä¼˜å…ˆï¼Œä¸”åˆå¹¶ä¸ºæ•°ç»„ã€‚

------

### ï¼ˆ3ï¼‰æ•°ç»„ç±»å‹ï¼ˆcomponents, directives, filtersï¼‰

- **è§„åˆ™**ï¼šå­ç»„ä»¶ä¼š **è¦†ç›–çˆ¶ç»„ä»¶åŒåæ³¨å†Œ**ã€‚
- **åŸå› **ï¼šåŒåç»„ä»¶éœ€è¦è¢«å­ç»„ä»¶è¦†ç›–ä»¥å®ç°å±€éƒ¨æ³¨å†Œã€‚

```js
const parent = { components: { A: {...} } }
const child = { components: { A: {...}, B: {...} } }

const merged = Vue.util.mergeOptions(parent, child)
console.log(merged.components) // { A: child.A, B: child.B }
```

------

### ï¼ˆ4ï¼‰é»˜è®¤ç­–ç•¥

- **è§„åˆ™**ï¼šå­é€‰é¡¹ä¼˜å…ˆè¦†ç›–çˆ¶é€‰é¡¹ï¼ˆå­è¦†ç›–çˆ¶ï¼‰ã€‚
- å¸¸è§é€‚ç”¨å­—æ®µï¼š`el`, `propsData`, `name`, `template` ç­‰ã€‚

------

## 3ï¸âƒ£ Vue å†…éƒ¨å®ç°é€»è¾‘

Vue å†…éƒ¨æ ¸å¿ƒæ–¹æ³•ï¼š`mergeOptions(parent, child, vm)`

- éå† **çˆ¶é€‰é¡¹å’Œå­é€‰é¡¹**ï¼Œæ ¹æ®å­—æ®µç±»å‹è°ƒç”¨ç­–ç•¥å‡½æ•° `strats[key]`
- é’©å­ç±»å­—æ®µï¼šæ•°ç»„åˆå¹¶
- å¯¹è±¡ç±»å­—æ®µï¼šå¯¹è±¡åˆå¹¶
- é»˜è®¤ç­–ç•¥ï¼šå­è¦†ç›–çˆ¶

```js
function mergeOptions(parent, child, vm) {
  const options = {}
  for (const key in parent) mergeField(key)
  for (const key in child) if (!parent.hasOwnProperty(key)) mergeField(key)

  function mergeField(key) {
    const strat = strats[key] || defaultStrat
    options[key] = strat(parent[key], child[key], vm, key)
  }
  return options
}
```

- **strats**ï¼šå­˜å‚¨å„å­—æ®µçš„åˆå¹¶ç­–ç•¥
   ä¾‹å¦‚ï¼š

```js
strats.data = function (parentVal, childVal, vm) { ... }       // data åˆå¹¶
strats.created = mergeHook                             // ç”Ÿå‘½å‘¨æœŸåˆå¹¶
strats.components = mergeAssets                        // ç»„ä»¶/æŒ‡ä»¤/è¿‡æ»¤å™¨åˆå¹¶
```

------

## 4ï¸âƒ£ é¢è¯•é«˜é¢‘ç‚¹

1. ç”Ÿå‘½å‘¨æœŸé’©å­åˆå¹¶é¡ºåºï¼šçˆ¶ â†’ å­
2. `data` å‡½æ•°åˆå¹¶ï¼šå­ `data` è¦†ç›–çˆ¶ `data`ï¼Œæ³¨æ„ Vue 2 å¯¹å¯¹è±¡æ˜¯ **åˆå¹¶è€Œéæ›¿æ¢æ•´ä¸ªå¯¹è±¡**ï¼ˆVue 3 ä¸­ Proxy å¯ç›´æ¥è¦†ç›–ï¼‰
3. `methods`ã€`computed`ã€`watch` å¯¹è±¡åˆå¹¶ï¼šä¸åŒå±æ€§åˆå¹¶ï¼ŒåŒåè¦†ç›–
4. å…¨å±€ç»„ä»¶/æŒ‡ä»¤/è¿‡æ»¤å™¨æ³¨å†Œï¼šå­ä¼šè¦†ç›–çˆ¶åŒåæ³¨å†Œ

### åŒå‘ç»‘å®šåŸç†

### ä¸€ã€æ ¸å¿ƒæ€æƒ³

Vue 2 çš„åŒå‘ç»‘å®šæ˜¯åŸºäº **æ•°æ®åŠ«æŒ (Object.defineProperty)** + **å‘å¸ƒ-è®¢é˜…æ¨¡å¼ (Dep + Watcher)** å®ç°çš„ã€‚

ä¸€å¥è¯æ€»ç»“ï¼š
 **æ•°æ®å˜åŒ– â†’ è§¦å‘ setter â†’ é€šçŸ¥ Dep â†’ Dep é€šçŸ¥ Watcher â†’ Watcher æ‰§è¡Œæ›´æ–°å‡½æ•° â†’ è§†å›¾æ›´æ–°**
 **è§†å›¾å˜åŒ– (v-model è¾“å…¥) â†’ è§¦å‘äº‹ä»¶ â†’ ä¿®æ”¹æ•°æ® â†’ å†èµ°ä¸Šé¢è¿™å¥—æµç¨‹**

------

## äºŒã€å››å¤§æ ¸å¿ƒè§’è‰²

### 1. **Observerï¼ˆæ•°æ®ç›‘å¬å™¨ï¼‰**

- ç”¨ `Object.defineProperty` ç»™æ¯ä¸ªæ•°æ®å±æ€§åŠ ä¸Š `getter / setter`ã€‚
- ä½œç”¨ï¼šåŠ«æŒæ•°æ®çš„è¯»å†™ã€‚
- å½“è¯»å–å±æ€§æ—¶ â†’ ä¾èµ–æ”¶é›†ï¼ˆæŠŠ Watcher åŠ åˆ° Dep ä¸­ï¼‰ã€‚
- å½“ä¿®æ”¹å±æ€§æ—¶ â†’ é€šçŸ¥ Dep æ´¾å‘æ›´æ–°ã€‚

------

### 2. **Depï¼ˆä¾èµ–æ”¶é›†å™¨ï¼‰**

- ä¸€ä¸ªä¸­é—´è°ƒåº¦ä¸­å¿ƒï¼Œç»´æŠ¤ç€ä¸€ç»„ Watcherã€‚
- æ¯ä¸ªå“åº”å¼å±æ€§éƒ½ä¼šæœ‰ä¸€ä¸ª `Dep` å®ä¾‹ã€‚
- æä¾› `depend()`ï¼ˆæ”¶é›†ä¾èµ–ï¼‰å’Œ `notify()`ï¼ˆæ´¾å‘æ›´æ–°ï¼‰ã€‚

------

### 3. **Watcherï¼ˆè®¢é˜…è€…ï¼‰**

- è®¢é˜…æ•°æ®å˜åŒ–ï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œæ‰§è¡Œå›è°ƒæ›´æ–°è§†å›¾ã€‚
- åœ¨å®ä¾‹åŒ–æ—¶ï¼Œä¼šè¯»å–ä¸€æ¬¡æ•°æ®ï¼Œè§¦å‘ getterï¼ŒæŠŠè‡ªå·±åŠ åˆ° Dep ä¸­ã€‚
- å†…éƒ¨æœ‰ `update()` æ–¹æ³•ï¼Œå½“è¢«é€šçŸ¥æ—¶è°ƒç”¨ â†’ è§¦å‘è§†å›¾æ›´æ–°ã€‚

------

### 4. **Compilerï¼ˆæ¨¡æ¿ç¼–è¯‘å™¨ï¼‰**

- è§£ææ¨¡æ¿ä¸­çš„æŒ‡ä»¤ï¼ˆå¦‚ `v-model`ã€`v-text`ã€`{{ }}` è¡¨è¾¾å¼ï¼‰ã€‚
- ä¸ºæ¯ä¸ªç»‘å®šçš„èŠ‚ç‚¹ç”Ÿæˆæ›´æ–°å‡½æ•°ï¼Œå¹¶ä¸”åˆ›å»ºå¯¹åº”çš„ Watcherã€‚
- å½“æ•°æ®å˜åŒ–æ—¶ï¼ŒWatcher é€šçŸ¥è¿™äº›æ›´æ–°å‡½æ•°å»æ›´æ–° DOMã€‚

------

## ä¸‰ã€è¿è¡Œæµç¨‹

1. **åˆå§‹åŒ–æ—¶**

   - `Observer` åŠ«æŒæ•°æ®ï¼Œä¸ºå±æ€§è®¾ç½® getter/setterã€‚
   - `Compiler` è§£ææ¨¡æ¿ï¼ŒæŠŠå˜é‡æ›¿æ¢æˆæ•°æ®ï¼Œå¹¶ä¸ºå˜é‡åˆ›å»º `Watcher`ã€‚
   - `Watcher` åœ¨åˆ›å»ºæ—¶ä¼šè¯»å–ä¸€æ¬¡æ•°æ®ï¼ˆè§¦å‘ getterï¼‰ï¼Œä»è€Œè¢« `Dep` æ”¶é›†ã€‚

2. **æ•°æ®å˜åŒ–æ—¶**

   - ä¿®æ”¹æ•°æ®å±æ€§ â†’ è§¦å‘ `setter` â†’ è°ƒç”¨ `dep.notify()`ã€‚
   - `Dep` é€šçŸ¥æ‰€æœ‰ Watcher â†’ è°ƒç”¨ `update()` â†’ æ‰§è¡Œå¯¹åº”çš„ DOM æ›´æ–°å‡½æ•°ã€‚

3. **è§†å›¾å˜åŒ–æ—¶**

   - ç”¨æˆ·è¾“å…¥ï¼ˆä¾‹å¦‚ `v-model` ç»‘å®šçš„ inputï¼‰è§¦å‘ `input` äº‹ä»¶ã€‚
   - äº‹ä»¶å›è°ƒé‡Œæ›´æ–°æ•°æ® â†’ æ•°æ®å˜åŒ–å†èµ° Observer â†’ Dep â†’ Watcher â†’ è§†å›¾æ›´æ–°ã€‚

   ![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220212103055.png)

## å››ã€æ€»ç»“ä¸€å¥

Vue 2 çš„åŒå‘ç»‘å®šå°±æ˜¯ï¼š

- **Observer** åŠ«æŒæ•°æ®å±æ€§ï¼›
- **Dep** æ”¶é›†å’Œæ´¾å‘æ›´æ–°ï¼›
- **Watcher** è®¢é˜…æ•°æ®å˜åŒ–ï¼Œæ‰§è¡Œæ›´æ–°å‡½æ•°ï¼›
- **Compiler** è´Ÿè´£è§£ææ¨¡æ¿ï¼ŒæŠŠæ•°æ®å’Œ DOM ç»‘å®šèµ·æ¥ã€‚

## äº”ã€ç®€åŒ–ç‰ˆä»£ç ç¤ºä¾‹

```js
// Dep: ä¾èµ–æ”¶é›†å™¨
class Dep {
  constructor() {
    this.subs = []
  }
  addSub(sub) {
    this.subs.push(sub)
  }
  notify() {
    this.subs.forEach(sub => sub.update())
  }
}
// Watcher: è®¢é˜…è€…
class Watcher {
  constructor(obj, key, cb) {
    this.obj = obj
    this.key = key
    this.cb = cb
    Dep.target = this
    this.value = obj[key] // è§¦å‘ getter æ”¶é›†ä¾èµ–
    Dep.target = null
  }
  update() {
    const newVal = this.obj[this.key]
    if (newVal !== this.value) {
      this.value = newVal
      this.cb(newVal)
    }
  }
}
// Observer: æ•°æ®åŠ«æŒ
function observe(obj) {
  Object.keys(obj).forEach(key => {
    let val = obj[key]
    const dep = new Dep()
    Object.defineProperty(obj, key, {
      get() {
        if (Dep.target) dep.addSub(Dep.target)
        return val
      },
      set(newVal) {
        val = newVal
        dep.notify()
      }
    })
  })
}
// ä½¿ç”¨
const data = { msg: 'hello' }
observe(data)
// ç»‘å®šä¸€ä¸ª watcher
new Watcher(data, 'msg', val => {
  console.log('è§†å›¾æ›´æ–°:', val)
})
data.msg = 'world' // setter â†’ dep.notify â†’ watcher.update â†’ è¾“å‡º "è§†å›¾æ›´æ–°: world"
```

```js
//åˆ›å»ºè®¢é˜…å‘å¸ƒè€…
//1.ç®¡ç†è®¢é˜…
//2.é›†ä½“é€šçŸ¥
class Dep {
  constructor() {
    this.subs = [];
  }
  //æ·»åŠ è®¢é˜…
  addSub(sub) {//å…¶å®å°±æ˜¯watcherå¯¹è±¡
    this.subs.push(sub)
  }
  //é›†ä½“é€šçŸ¥
  notify() {
    this.subs.forEach((sub) => {
      sub.update()
    })
  }
}
```
### æ•°ç»„å“åº”å¼é‡å†™
- å®ç°
```js
const arrExtend = Object.create(Array.prototype)
// const arrExtend = {}
// arrExtend._proto_=Array.prototype
const arrMethods = ['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse']
arrMethods.forEach(method => {
  const oldMethod = Array.prototype[method]
  const newMethod = function(...args) {
    oldMethod.apply(this, args)
    console.log(`${method} æ–¹æ³•è¢«æ‰§è¡Œäº†`)
  }
  arrExtend[method] = newMethod
})
```

### åŒå‘ç»‘å®šçš„ä¼˜ç‚¹

åŒå‘ç»‘å®šçš„ä¼˜ç‚¹æ˜¯ **ç®€åŒ–ä»£ç ã€æå‡å¼€å‘æ•ˆç‡ã€è‡ªåŠ¨åŒæ­¥æ•°æ®å’Œè§†å›¾**ï¼Œå°¤å…¶é€‚åˆè¡¨å•å’Œæ•°æ®é¢‘ç¹äº¤äº’çš„åœºæ™¯ã€‚

### templateåŸç†å’Œå®ç°
![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220209123317.png)

### è™šæ‹Ÿdom
## 1. è™šæ‹Ÿ DOM æ¦‚å¿µ

- **å®šä¹‰**ï¼šè™šæ‹Ÿ DOM æ˜¯ç”¨ **JavaScript å¯¹è±¡** è¡¨ç¤ºçœŸå® DOM çš„ä¸€ç§æŠ½è±¡ã€‚
- **ç›®çš„**ï¼šè§£å†³ç›´æ¥æ“ä½œ DOM çš„æ€§èƒ½ä½å’Œå¤æ‚é—®é¢˜ï¼Œå®ç° **é«˜æ•ˆçš„è§†å›¾æ›´æ–°**ã€‚
- **æ›´æ–°æµç¨‹**ï¼š

```
æ•°æ®æ”¹å˜ â†’ ç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOM â†’ è®¡ç®—å·®å¼‚ (diff) â†’ æœ€å°åŒ–æ›´æ–°çœŸå® DOM â†’ è§†å›¾æ›´æ–°
```

------

## 2. è™šæ‹Ÿ DOM æ ¼å¼ï¼ˆVNodeï¼‰

æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª JS å¯¹è±¡ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š

```
{
  tag: 'div',           // æ ‡ç­¾å
  data: {               // èŠ‚ç‚¹å±æ€§ã€æ ·å¼ã€äº‹ä»¶ç­‰
    class: 'box',
    style: { color: 'red' },
    attrs: { id: 'app' },
    on: { click: handleClick }
  },
  children: [/* å­èŠ‚ç‚¹ VNode */],
  text: 'Hello',        // æ–‡æœ¬èŠ‚ç‚¹å†…å®¹
  elm: null,            // å¯¹åº”çœŸå® DOM èŠ‚ç‚¹
  key: 'uniqueKey'      // æé«˜ diff ç®—æ³•æ•ˆç‡ï¼Œå¸®åŠ©å¤ç”¨ DOM
}
```

------

## 3. è™šæ‹Ÿ DOM çš„ä¼˜åŠ¿

1. **æ— éœ€æ‰‹åŠ¨æ“ä½œ DOM**
   - é€»è¾‘å±‚åªå…³æ³¨æ•°æ®å˜åŒ–ï¼ŒVue è‡ªåŠ¨è®¡ç®—æœ€å°æ›´æ–°ã€‚
2. **æé«˜æ€§èƒ½**
   - æ¯”ç›´æ¥æ“ä½œ DOM æ›´é«˜æ•ˆï¼Œå› ä¸ºå‡å°‘äº†é‡æ’ï¼ˆreflowï¼‰å’Œé‡ç»˜ï¼ˆrepaintï¼‰ã€‚
3. **å¯è·¨å¹³å°**
   - æŠ½è±¡ DOM ç»“æ„ï¼Œå¯åœ¨ä¸åŒå¹³å°ï¼ˆæµè§ˆå™¨ã€Nativeã€Weexï¼‰æ¸²æŸ“ã€‚
4. **ç®€åŒ–å¼€å‘**
   - å¼€å‘è€…åªéœ€å…³æ³¨æ•°æ®å’Œæ¨¡æ¿ï¼Œä¸å¿…å…³å¿ƒ DOM æ“ä½œç»†èŠ‚ã€‚

------

## 4. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹Ÿ DOM

- åŸç”Ÿ DOM æ“ä½œæ•ˆç‡ä½ï¼Œå°¤å…¶æ˜¯é¢‘ç¹å¢åˆ èŠ‚ç‚¹æˆ–ä¿®æ”¹æ ·å¼æ—¶ã€‚
- jQuery/åŸç”Ÿæ“ä½œéœ€è¦è‡ªå·±æ‰‹åŠ¨ä¼˜åŒ– DOM æ›´æ–°ã€‚
- è™šæ‹Ÿ DOM å¯ä»¥ï¼š
  - æ‰¹é‡è®¡ç®—å·®å¼‚ï¼ˆdiffï¼‰ï¼Œæœ€å°åŒ–æ“ä½œï¼›
  - ä¿æŒå£°æ˜å¼ç¼–ç¨‹é£æ ¼ï¼›
  - è‡ªåŠ¨å¤„ç†å¤æ‚æ›´æ–°é€»è¾‘ã€‚

------

## 5. DOM éå†ä¸ Diff ç®—æ³•

### (1) Diff ç®—æ³•

- Vue é€šè¿‡ **åŒç«¯æ¯”è¾ƒ + key ä¼˜åŒ–** æ¥åˆ¤æ–­å“ªäº›èŠ‚ç‚¹éœ€è¦æ›´æ–°ã€‚
- æ ¸å¿ƒæ€æƒ³ï¼š
  1. å…ˆæ¯”è¾ƒåŒå±‚èŠ‚ç‚¹ï¼›
  2. æ ¹æ® key åŒ¹é…å¤ç”¨èŠ‚ç‚¹ï¼›
  3. ä¸åŒåˆ™åˆ›å»ºæ–°èŠ‚ç‚¹æˆ–åˆ é™¤æ—§èŠ‚ç‚¹ã€‚

### (2) DOM éå†æ–¹å¼

- **æ·±åº¦ä¼˜å…ˆ**ï¼ˆDFSï¼‰ï¼šéå†æ•´ä¸ªè™šæ‹Ÿ DOM æ ‘ï¼Œé€å±‚æ¯”è¾ƒã€‚
- **å¹¿åº¦ä¼˜å…ˆ**ï¼ˆBFSï¼‰ï¼šä¸å¸¸ç”¨ï¼Œä½†æœ‰äº›ä¼˜åŒ–åœºæ™¯å¯ä»¥ç”¨ã€‚

------

## 6. è™šæ‹Ÿ DOM å®ç°åŸç†

1. **JS å¯¹è±¡æ¨¡æ‹ŸçœŸå® DOM**
   - æ¯ä¸ª VNode å¯¹è±¡éƒ½å¯¹åº”çœŸå® DOM çš„èŠ‚ç‚¹ç»“æ„ã€‚
2. **diff ç®—æ³•**
   - æ¯”è¾ƒæ–°æ—§è™šæ‹Ÿ DOM æ ‘ï¼Œæ‰¾å‡ºèŠ‚ç‚¹å·®å¼‚ã€‚
3. **patch ç®—æ³•**
   - æ ¹æ® diff ç»“æœï¼ŒæŠŠæœ€å°å·®å¼‚æ›´æ–°åˆ°çœŸå® DOMã€‚

ç®€åŒ–ç‰ˆæµç¨‹ï¼š

```
æ•°æ®å˜åŒ–
  â†“
æ–° VNode = render()  // ç”Ÿæˆæ–°è™šæ‹Ÿ DOM
  â†“
diff(æ—§ VNode, æ–° VNode) // æ¯”è¾ƒå·®å¼‚
  â†“
patch(å·®å¼‚)  // æ›´æ–°çœŸå® DOM
```

------

## 7. ä¸¾ä¾‹å¯¹æ¯”

| æ–¹å¼           | ä¼˜ç‚¹                      | ç¼ºç‚¹                         |
| -------------- | ------------------------- | ---------------------------- |
| jQuery / åŸç”Ÿ  | ç›´æ¥æ“ä½œ DOMï¼Œç«‹å³ç”Ÿæ•ˆ    | é¢‘ç¹æ“ä½œæ€§èƒ½å·®ï¼Œé€»è¾‘å¤æ‚     |
| Vue + è™šæ‹Ÿ DOM | æ•°æ®é©±åŠ¨ï¼Œæœ€å°åŒ– DOM æ›´æ–° | åˆæ¬¡æ¸²æŸ“ç¨æ…¢ï¼Œæœ‰é¢å¤–å†…å­˜å¼€é”€ |

------

âœ… **ä¸€å¥è¯æ€»ç»“**ï¼š
 è™šæ‹Ÿ DOM æ˜¯ **å¯¹çœŸå® DOM çš„ JS æŠ½è±¡**ï¼Œé€šè¿‡ diff + patch ç®—æ³•å®ç° **é«˜æ•ˆã€å£°æ˜å¼ã€å¯å¤ç”¨çš„ DOM æ›´æ–°**ï¼Œå¤§å¹…æå‡å‰ç«¯å¼€å‘æ•ˆç‡å’Œæ€§èƒ½ã€‚

## 1. Diff ç®—æ³•æ¦‚å¿µ

- **ä½œç”¨**ï¼šæ¯”è¾ƒ **ä¸¤æ£µè™šæ‹Ÿ DOM æ ‘** çš„å·®å¼‚ï¼Œæ‰¾å‡ºæœ€å°çš„æ›´æ–°æ“ä½œã€‚
- **æ ¸å¿ƒåŸåˆ™**ï¼š
  1. åªæ¯”è¾ƒ **åŒå±‚çº§èŠ‚ç‚¹**ï¼›
  2. æ ‡ç­¾åä¸åŒ â†’ **ç›´æ¥æ›¿æ¢**ï¼›
  3. æ ‡ç­¾å + key ç›¸åŒ â†’ **å±€éƒ¨æ›´æ–°**ï¼›
  4. ä½¿ç”¨ **æ·±åº¦ä¼˜å…ˆéå†**ï¼Œä¼˜å…ˆæ›´æ–°å­èŠ‚ç‚¹ï¼ˆé€’å½’è°ƒç”¨ `updateChildren`ï¼‰ã€‚

## 2. Diff éå†ç­–ç•¥

- **æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDFSï¼‰**ï¼š
  1. å…ˆå¯¹å­èŠ‚ç‚¹é€’å½’å¤„ç†ï¼›
  2. å†å¤„ç†ç›¸é‚»èŠ‚ç‚¹ã€‚
- **å­èŠ‚ç‚¹ diff**ï¼š
  - å¦‚æœå­èŠ‚ç‚¹å­˜åœ¨å·®å¼‚ â†’ å±€éƒ¨æ›´æ–°ï¼›
  - å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨ â†’ æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹ã€‚

------

## 3. Patch å‡½æ•°ï¼ˆæ ¸å¿ƒå…¥å£ï¼‰

`patch(oldVnode, vnode)` ä½œç”¨ï¼š

1. **oldVnode ä¸å­˜åœ¨** â†’ ç›´æ¥åˆ›å»ºæ–°èŠ‚ç‚¹ã€‚
2. **oldVnode å­˜åœ¨** â†’ è°ƒç”¨ `patchVNode(oldVnode, vnode)`ï¼š
   - è°ƒç”¨ `sameVNode(oldVnode, vnode)` åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼š
     - å¦‚æœ **ç›¸åŒ** â†’ å±€éƒ¨ diffï¼›
     - å¦‚æœ **ä¸åŒ** â†’ æ›¿æ¢èŠ‚ç‚¹ï¼Œåˆ é™¤è€èŠ‚ç‚¹ã€‚

- 4. patchVNode æ–¹æ³•ï¼ˆå±€éƒ¨æ›´æ–°ï¼‰

    `patchVNode(oldVnode, vnode)` æ­¥éª¤ï¼š

    1. **æ–‡æœ¬èŠ‚ç‚¹æ›´æ–°**
       - å¦‚æœ `oldVnode.text !== vnode.text` â†’ æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹ã€‚
    2. **å­èŠ‚ç‚¹æ›´æ–°**
       - å¦‚æœ vnode æ²¡æœ‰æ–‡æœ¬èŠ‚ç‚¹ â†’ è¿›å…¥å­èŠ‚ç‚¹ diffã€‚
       - å¦‚æœ oldCh å’Œ ch éƒ½å­˜åœ¨ â†’ è°ƒç”¨ `updateChildren(oldCh, ch, parentElm)`ã€‚
       - å¦‚æœ oldCh ä¸å­˜åœ¨ï¼Œch å­˜åœ¨ â†’ æ¸…ç©ºæ–‡æœ¬å¹¶æ·»åŠ æ–°èŠ‚ç‚¹ã€‚
       - å¦‚æœ oldCh å­˜åœ¨ï¼Œch ä¸å­˜åœ¨ â†’ åˆ é™¤æ—§èŠ‚ç‚¹ã€‚
    3. **æ–‡æœ¬èŠ‚ç‚¹æ¸…ç†**
       - oldVnode æœ‰æ–‡æœ¬ï¼Œè€Œ vnode æ²¡æœ‰ â†’ æ¸…ç©ºæ–‡æœ¬ã€‚

    ------

    ## 5. updateChildren æ–¹æ³•ï¼ˆå­èŠ‚ç‚¹ diff æ ¸å¿ƒï¼‰

    - æ ¸å¿ƒæ€æƒ³ï¼šé€šè¿‡ **åŒç«¯ç´¢å¼• + key æ˜ å°„** æœ€å°åŒ– DOM æ“ä½œã€‚
    - æ­¥éª¤ï¼š
      1. ç»™ `oldCh` å’Œ `ch` åˆ†åˆ«åˆ†é… `startIndex` å’Œ `endIndex`ã€‚
      2. éå† oldCh å’Œ chï¼š
         - æ¯”è¾ƒå¤´å°¾èŠ‚ç‚¹ (`startVnode` / `endVnode`) æ˜¯å¦ç›¸åŒï¼›
         - ç›¸åŒ â†’ `patchVNode` é€’å½’æ›´æ–°ï¼›
         - ä¸åŒ â†’ æŸ¥æ‰¾ key æ˜¯å¦å­˜åœ¨ â†’ èŠ‚ç‚¹ç§»åŠ¨æˆ–åˆ›å»ºï¼›
      3. å½“ä»»æ„ä¸€ç«¯éå†ç»“æŸ â†’ åœæ­¢ diff è¿‡ç¨‹ï¼›
      4. å‰©ä½™èŠ‚ç‚¹ï¼š
         - oldCh å‰©ä½™ â†’ åˆ é™¤èŠ‚ç‚¹ï¼›
         - ch å‰©ä½™ â†’ åˆ›å»ºèŠ‚ç‚¹ã€‚

    ------

    ## 6. Diff ç®—æ³•ä¼˜åŒ–ç‚¹

    - **key çš„ä½œç”¨**ï¼š
      - å¸®åŠ© Vue å¿«é€Ÿæ‰¾åˆ°èŠ‚ç‚¹å¯¹åº”å…³ç³»ï¼Œé¿å…å¤§é‡ DOM é‡å»ºã€‚
    - **åŒå±‚æ¯”è¾ƒ**ï¼š
      - Diff åªåœ¨åŒå±‚èŠ‚ç‚¹è¿›è¡Œï¼Œä¸ä¼šè·¨å±‚æ¯”è¾ƒï¼Œé™ä½ç®—æ³•å¤æ‚åº¦ï¼ˆO(n)ï¼‰ã€‚
    - **åŒç«¯æ¯”è¾ƒ**ï¼š
      - ä»å¤´å’Œå°¾åŒæ—¶å¼€å§‹åŒ¹é…ï¼Œå‡å°‘ç§»åŠ¨å’ŒæŸ¥æ‰¾å¼€é”€ã€‚
    - **æœ€å°åŒ– DOM æ“ä½œ**ï¼š
      - é€šè¿‡ patch + updateChildren åªä¿®æ”¹å¿…è¦èŠ‚ç‚¹ã€‚

    ------

    ## 7. é¢è¯•å¸¸è€ƒç‚¹æ€»ç»“

    | è€ƒç‚¹                    | è¯´æ˜                                   |
    | ----------------------- | -------------------------------------- |
    | diff åªæ¯”è¾ƒåŒå±‚èŠ‚ç‚¹     | è·¨å±‚èŠ‚ç‚¹ä¸æ¯”è¾ƒï¼Œå‡å°‘å¤æ‚åº¦             |
    | key çš„ä½œç”¨              | å”¯ä¸€æ ‡è¯†èŠ‚ç‚¹ï¼Œå¸®åŠ©å¤ç”¨å’Œç§»åŠ¨èŠ‚ç‚¹       |
    | patchVNode é€»è¾‘         | æ–‡æœ¬æ›´æ–° â†’ å­èŠ‚ç‚¹ diff â†’ æ·»åŠ /åˆ é™¤èŠ‚ç‚¹ |
    | updateChildren æ ¸å¿ƒæµç¨‹ | åŒç«¯ç´¢å¼• + key æ˜ å°„ + å‰©ä½™èŠ‚ç‚¹å¤„ç†     |

    ------

    âœ… **ä¸€å¥è¯æ€»ç»“**ï¼š
     Vue çš„ diff ç®—æ³•é€šè¿‡ **åŒå±‚æ¯”è¾ƒ + key ä¼˜åŒ– + æ·±åº¦ä¼˜å…ˆéå†**ï¼Œåœ¨ `patchVNode` å’Œ `updateChildren` ä¸­ç²¾ç¡®è®¡ç®—èŠ‚ç‚¹å·®å¼‚ï¼Œä»è€Œå®ç° **æœ€å°åŒ– DOM æ›´æ–°**ã€‚

- ![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220209204451.png)

### åˆå§‹åŒ–Vueåˆ°æœ€ç»ˆæ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹

## 1ï¸âƒ£ Vue å®ä¾‹åˆå§‹åŒ–ï¼ˆ`new Vue()`ï¼‰

1. **åˆå§‹åŒ–é…ç½®**

   - Vue æ„é€ å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ `init` æ–¹æ³•ï¼š

     ```
     this._init(options)
     ```

   - `_init` ä¸»è¦åšçš„äº‹æƒ…ï¼š

     - åˆå¹¶ç”¨æˆ·é…ç½®ï¼ˆ`options`ï¼‰å’Œé»˜è®¤é…ç½®ã€‚
     - åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼ˆ`_lifecycle`ï¼‰ã€äº‹ä»¶ç³»ç»Ÿï¼ˆ`_events`ï¼‰ã€å“åº”å¼æ•°æ®ï¼ˆ`_data`ï¼‰ç­‰ã€‚
     - åˆå§‹åŒ– `props`ã€`methods`ã€`computed`ã€`watch` ç­‰ã€‚

2. **æŒ‚è½½å‰é’©å­**

   - `beforeCreate` â†’ `created` ç”Ÿå‘½å‘¨æœŸé’©å­æ‰§è¡Œã€‚

------

## 2ï¸âƒ£ å“åº”å¼æ•°æ®åˆå§‹åŒ–ï¼ˆObserver + Depï¼‰

1. Vue ä¼šå¯¹ `data` åš **æ•°æ®åŠ«æŒï¼ˆObject.definePropertyï¼‰**
   - æ¯ä¸ªæ•°æ®å±æ€§ä¼šè¢« `Observer` åŒ…è£…ã€‚
   - æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘å¯¹åº”çš„ **ä¾èµ–æ”¶é›†ï¼ˆDepï¼‰**ï¼Œæ›´æ–°è§†å›¾ã€‚
2. **è®¡ç®—å±æ€§ï¼ˆcomputedï¼‰å’Œ watch**
   - computed ä¼šç”Ÿæˆä¸€ä¸ª **Watcher**ï¼Œæ‡’æ‰§è¡Œå¹¶ç¼“å­˜å€¼ã€‚
   - watch ä¹Ÿæ˜¯ä¸€ä¸ª Watcherï¼Œç›‘å¬æ•°æ®å˜åŒ–ã€‚

------

## 3ï¸âƒ£ æ¨¡æ¿ç¼–è¯‘ï¼ˆTemplate â†’ Render Functionï¼‰

1. **ç¼–è¯‘æµç¨‹**ï¼š
   - `template` â†’ `ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰` â†’ `Render å‡½æ•°` â†’ `VNodeï¼ˆè™šæ‹Ÿ DOMï¼‰`ã€‚
   - Vue 2 çš„ç¼–è¯‘å™¨æŠŠæ¨¡æ¿ç¼–è¯‘æˆ `render` æ–¹æ³•ï¼Œè¿™æ ·æ¯æ¬¡æ¸²æŸ“éƒ½ç”Ÿæˆ VNode æ ‘ã€‚
2. **VNodeï¼ˆè™šæ‹Ÿ DOMï¼‰**
   - ç”¨ JS å¯¹è±¡è¡¨ç¤º DOM ç»“æ„ã€‚
   - åŒ…å«æ ‡ç­¾ã€å±æ€§ã€å­èŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚

------

## 4ï¸âƒ£ Mountï¼ˆæŒ‚è½½åˆ° DOMï¼‰

1. è°ƒç”¨ `$mount(el)`ï¼š
   - å¦‚æœ `el` å­˜åœ¨ï¼ŒVue ä¼šæŠŠ VNode æ¸²æŸ“åˆ°çœŸå® DOM ä¸Šã€‚
   - åˆ›å»º **æ ¹ Watcher**ï¼ˆæ¸²æŸ“ Watcherï¼‰ï¼š
     - Watcher ä¼šè°ƒç”¨ `render` ç”Ÿæˆ VNodeã€‚
     - ç„¶åé€šè¿‡ `patch` æ–¹æ³•æŠŠ VNode è½¬æ¢æˆçœŸå® DOMã€‚

------

## 5ï¸âƒ£ Virtual DOM Diff ä¸ Patch

1. **åˆæ¬¡æ¸²æŸ“**
   - VNode â†’ DOMï¼Œç›´æ¥æŒ‚è½½åˆ°é¡µé¢ã€‚
2. **æ•°æ®å˜åŒ–æ›´æ–°**
   - æ•°æ®å˜åŒ–è§¦å‘å¯¹åº” Watcherã€‚
   - Watcher è°ƒç”¨ `render` ç”Ÿæˆæ–°çš„ VNodeã€‚
   - æ–°æ—§ VNode é€šè¿‡ **diff ç®—æ³•** æ¯”è¾ƒå·®å¼‚ã€‚
   - åªæ›´æ–°æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œå‡å°‘ DOM æ“ä½œã€‚

------

## 6ï¸âƒ£ æœ€ç»ˆæ¸²æŸ“å®Œæˆ

- é¡µé¢æ˜¾ç¤ºä¸ºæœ€ç»ˆçš„çœŸå® DOMã€‚
- åç»­æ•°æ®å˜åŒ–ï¼Œä¼šè§¦å‘ Watcher â†’ é‡æ–°æ¸²æŸ“ â†’ diff â†’ patch â†’ DOM æ›´æ–°ã€‚

------

### ğŸ”‘ æ€»ç»“æµç¨‹

```js
new Vue()
  â””â”€ _init() åˆå§‹åŒ–
      â”œâ”€ ç”Ÿå‘½å‘¨æœŸé’©å­ beforeCreate/created
      â”œâ”€ åˆå§‹åŒ–å“åº”å¼ data/props/computed/watch
      â””â”€ äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ–
  â””â”€ template ç¼–è¯‘ â†’ render å‡½æ•° â†’ VNode
  â””â”€ $mount(el)
      â”œâ”€ åˆ›å»ºæ¸²æŸ“ Watcher
      â”œâ”€ render â†’ VNode
      â””â”€ patch â†’ çœŸæ­£ DOM
  â””â”€ æ•°æ®å˜åŒ–
      â””â”€ Watcher è§¦å‘æ›´æ–°
          â””â”€ æ–°æ—§ VNode diff â†’ æ›´æ–° DOM
```

![](https://i-coder.oss-cn-beijing.aliyuncs.com/files/20220215214130.png)
## 1ï¸âƒ£ MVVM & MVC

- **MVCï¼ˆModel-View-Controllerï¼‰**
  - Modelï¼šæ•°æ®
  - Viewï¼šè§†å›¾
  - Controllerï¼šæ§åˆ¶é€»è¾‘
  - æ•°æ®å˜åŒ–éœ€è¦æ‰‹åŠ¨æ›´æ–°è§†å›¾
- **MVVMï¼ˆModel-View-ViewModelï¼‰**
  - Modelï¼šæ•°æ®
  - Viewï¼šè§†å›¾
  - ViewModelï¼šæ•°æ®ç»‘å®šé€»è¾‘
  - æ•°æ®å˜åŒ–è‡ªåŠ¨é©±åŠ¨è§†å›¾æ›´æ–°ï¼ˆåŒå‘ç»‘å®šï¼‰

### Proxy & Object.defineProperty
- Proxy
	- Proxyå¯ä»¥ç›´æ¥ç›‘å¬å¯¹è±¡è€Œéå±æ€§ï¼›
	
	- å¯ä»¥ç›´æ¥ç›‘å¬æ•°ç»„çš„å˜åŒ–
	
	  ```js
	  const handler = {
	    get(target, prop) {
	      // æ‹¦æˆªæ‰€æœ‰å±æ€§è®¿é—®
	      return Reflect.get(target, prop);
	    },
	    set(target, prop, value) {
	      // æ‹¦æˆªæ‰€æœ‰å±æ€§è®¾ç½®
	      return Reflect.set(target, prop, value);
	    },
	    deleteProperty(target, prop) {
	      // æ‹¦æˆªå±æ€§åˆ é™¤
	      return Reflect.deleteProperty(target, prop);
	    }
	  };
	  
	  const proxy = new Proxy([], handler);
	  ```
	
	  ```js
	  function reactive(obj) {
	    return new Proxy(obj, {
	      get(target, key) {
	        track(target, key); // ä¾èµ–æ”¶é›†
	        return Reflect.get(target, key);
	      },
	      set(target, key, value) {
	        const oldValue = target[key];
	        const result = Reflect.set(target, key, value);
	        
	        // ç‰¹æ®Šå¤„ç†æ•°ç»„çš„ length å±æ€§
	        if (key === 'length' && Array.isArray(target)) {
	          // è§¦å‘ length ç›¸å…³æ›´æ–°
	        } else {
	          // åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹
	          if (!target.hasOwnProperty(key)) {
	            trigger(target, 'add', key);
	          } else if (oldValue !== value) {
	            trigger(target, 'set', key);
	          }
	        }
	        return result;
	      },
	      deleteProperty(target, key) {
	        const hadKey = target.hasOwnProperty(key);
	        const result = Reflect.deleteProperty(target, key);
	        if (hadKey) {
	          trigger(target, 'delete', key);
	        }
	        return result;
	      }
	    });
	  }
	  ```
	
	- Proxyå¤šè¾¾13ç§æ‹¦æˆªæ–¹æ³•ï¼›
	  getã€setã€hasã€deletePropertyã€ownKeysã€getOwnPropertyDescriptorã€
	  definePropertyã€preventExtensionsã€getPrototypeOfã€isExtensibleã€
	  setPrototypeOfã€applyã€construct
	
	- Proxyè¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæˆ‘ä»¬åªæ“ä½œæ–°å¯¹è±¡ï¼›
	
	- ProxyæŒç»­ä¼˜åŒ–ï¼›
	
	- ä¸æ”¯æŒIEï¼›
	
	- Reflect 
	
	  - 1ï¸âƒ£ Reflect çš„ä½œç”¨
	    - ä»£æ›¿ä¸€äº› `Object` çš„æ–¹æ³•ï¼Œæ›´â€œå‡½æ•°å¼â€æ“ä½œå¯¹è±¡
	    - è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸï¼Œè€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
	    - å¸¸ä¸ `Proxy` é…åˆï¼Œç”¨äºåœ¨æ‹¦æˆªå™¨é‡Œè°ƒç”¨é»˜è®¤è¡Œä¸º
	
	  - 2ï¸âƒ£ å¸¸ç”¨æ–¹æ³•
	
	| æ–¹æ³•                                               | è¯´æ˜                                                  |
	| -------------------------------------------------- | ----------------------------------------------------- |
	| `Reflect.get(target, prop, receiver)`              | è·å–å±æ€§å€¼ï¼Œç±»ä¼¼ `target[prop]`                       |
	| `Reflect.set(target, prop, value, receiver)`       | è®¾ç½®å±æ€§å€¼ï¼Œç±»ä¼¼ `target[prop] = value`ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ |
	| `Reflect.has(target, prop)`                        | æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œç±»ä¼¼ `prop in target`               |
	| `Reflect.deleteProperty(target, prop)`             | åˆ é™¤å±æ€§ï¼Œç±»ä¼¼ `delete target[prop]`                  |
	| `Reflect.ownKeys(target)`                          | è·å–å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬ Symbolï¼‰                 |
	| `Reflect.getOwnPropertyDescriptor(target, prop)`   | è·å–å±æ€§æè¿°ç¬¦                                        |
	| `Reflect.defineProperty(target, prop, descriptor)` | å®šä¹‰å±æ€§ï¼Œç±»ä¼¼ `Object.defineProperty`                |
	| `Reflect.preventExtensions(target)`                | é˜»æ­¢å¯¹è±¡æ‰©å±•ï¼Œç±»ä¼¼ `Object.preventExtensions`         |
	| `Reflect.isExtensible(target)`                     | åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯æ‰©å±•                                    |
	| `Reflect.getPrototypeOf(target)`                   | è·å–åŸå‹ï¼Œç±»ä¼¼ `Object.getPrototypeOf`                |
	| `Reflect.setPrototypeOf(target, proto)`            | è®¾ç½®åŸå‹ï¼Œç±»ä¼¼ `Object.setPrototypeOf`                |
	| `Reflect.apply(target, thisArg, args)`             | è°ƒç”¨å‡½æ•°ï¼Œç±»ä¼¼ `Function.prototype.apply`             |
	| `Reflect.construct(target, args, newTarget)`       | æ„é€ å‡½æ•°è°ƒç”¨ï¼Œç±»ä¼¼ `new target(...args)`              |
	
- Object.defineProperty
	- æ”¯æŒIE9ï¼›
	
	- åªèƒ½éå†å¯¹è±¡å±æ€§ç›´æ¥ä¿®æ”¹ï¼›
	
	- ä¸å†ä¼˜åŒ–ï¼›
	
	- ä¸èƒ½ç›‘å¬æ•°ç»„
	
	  - ä¸ºä»€ä¹ˆä¸ç›‘å¬æ•°ç»„ä¸‹æ ‡
	
	    - æ€§èƒ½é—®é¢˜
	
	      - æ•°ç»„åŒ…å«å¤§é‡å…ƒç´ ï¼Œä¸ºæ¯ä¸ªç´¢å¼•éƒ½è®¾ç½®getter/setterä¼šæ¶ˆè€—å¤§é‡å†…å­˜
	      - æ¯æ¬¡æ•°ç»„æ“ä½œéƒ½è¦éå†æ•´ä¸ªæ•°ç»„ï¼Œæ—¶é—´å¤åˆ¶åº¦ä¸ºO(n)
	
	    - ä¸‹æ ‡ä¸å¯æ§
	
	      - æ•°ç»„é•¿åº¦åŠ¨æ€å˜åŒ–ï¼Œæ— æ³•é¢„å…ˆå®šä¹‰æ‰€æœ‰ç´¢å¼•çš„å“åº”å¼
	      - æ•°ç»„æ“ä½œï¼ˆpush/pop/shift/unshiftï¼‰ä¼šæ”¹å˜ç´¢å¼•ä½ç½®
	
	    - ç›‘å¬ç›²åŒº
	
	      ```js
	      const arr = [1, 2, 3];
	      // Vue2 æ— æ³•æ£€æµ‹åˆ°è¿™ç§ç›´æ¥ç´¢å¼•èµ‹å€¼
	      arr[0] = 10; 
	      // Vue2 æ— æ³•æ£€æµ‹åˆ°æ•°ç»„é•¿åº¦å˜åŒ–
	      arr.length = 0;
	      ```
	
	    - æ— æ³•ç›‘å¬æ–°å¢ã€åˆ é™¤
	
	      ```js
	      // æ— æ³•æ£€æµ‹æ–°å¢å…ƒç´ 
	      arr[3] = 4;
	      // æ— æ³•æ£€æµ‹å…ƒç´ åˆ é™¤
	      delete arr[0];
	      ```
## å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§                    | `Object.defineProperty` | `Proxy`            |
| :---------------------- | :---------------------- | :----------------- |
| æ•°ç»„ç´¢å¼•è®¿é—®/è®¾ç½®       | âŒ æ— æ³•ç›‘å¬              | âœ… å®Œå…¨æ”¯æŒ         |
| æ•°ç»„æ–¹æ³•æ“ä½œ (push/pop) | âš ï¸ éœ€é‡å†™æ–¹æ³•            | âœ… åŸç”Ÿæ”¯æŒ         |
| æ•°ç»„é•¿åº¦å˜åŒ–            | âŒ æ— æ³•ç›‘å¬              | âœ… æ”¯æŒ length å˜æ›´ |
| æ–°å¢/åˆ é™¤å…ƒç´            | âŒ æ— æ³•ç›‘å¬              | âœ… å®Œå…¨æ”¯æŒ         |
| æ€§èƒ½è¡¨ç°                | âš ï¸ æ•°ç»„è¾ƒå¤§æ—¶æ€§èƒ½å·®      | âœ… é«˜æ•ˆ             |
| åµŒå¥—å¯¹è±¡å¤„ç†            | âš ï¸ éœ€è¦é€’å½’åˆå§‹åŒ–        | âœ… æƒ°æ€§ä»£ç†         |
| æµè§ˆå™¨å…¼å®¹æ€§            | âœ… IE9+                  | âŒ ä¸å…¼å®¹ IE        |

## 3ï¸âƒ£ æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰

- **å®šä¹‰**ï¼šåœ¨æœåŠ¡å™¨ç”Ÿæˆå®Œæ•´ HTML ç‰‡æ®µè¿”å›
- **ä¼˜ç‚¹**ï¼šSEO å¥½ï¼Œé¦–å±æ¸²æŸ“å¿«
- **ç¼ºç‚¹**ï¼šåªèƒ½æ‰§è¡Œ `beforeCreate` å’Œ `created` é’©å­ï¼›å¢åŠ æœåŠ¡å™¨è´Ÿè½½
- **å·¥å…·**ï¼šNuxt.js (`vue-server-renderer`)

### vueå¸¸ç”¨ä¿®é¥°ç¬¦
- stop
	é˜»æ­¢å†’æ³¡
- prevent
	é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼ˆå¦‚ï¼šaæ ‡ç­¾çš„è·³è½¬ï¼‰
- capture
	äº‹ä»¶é»˜è®¤æ˜¯ç”±é‡Œå¾€å¤–å†’æ³¡ï¼›captureä½œç”¨æ˜¯ç”±å¤–å¾€é‡Œæ•è·
- self
	ç‚¹å‡»äº‹ä»¶ç»‘å®šçš„æœ¬èº«æ‰ä¼šè§¦å‘äº‹ä»¶
- once
	äº‹ä»¶åªæ‰§è¡Œä¸€æ¬¡
- passive
	ç›¸å½“äºç»™onscrolläº‹ä»¶æ·»åŠ ä¸€ä¸ª.lazyä¿®é¥°ç¬¦ï¼ˆ@scroll.passive="onScroll"ï¼‰
- enter
- trim
	å»é™¤é¦–å°¾ç©ºæ ¼
- number
	å°†v-modelå€¼è½¬æˆæ•°å­—
		22aa => 22
		aa22 => aa22ï¼ˆæ— æ•ˆï¼‰
- lazy
	æ”¹å˜è¾“å…¥æ¡†çš„å€¼æ—¶valueä¸ä¼šæ”¹å˜ï¼›å½“å…‰æ ‡ç¦»å¼€è¾“å…¥æ¡†æ—¶ï¼Œv-modelç»‘å®šçš„å€¼valueæ‰ä¼šæ”¹å˜
- sync
	é…åˆthis.$emit('update:xxx', data)
- native
	åŠ åœ¨è‡ªå®šä¹‰ç»„ä»¶çš„äº‹ä»¶ä¸Šï¼Œä¿è¯äº‹ä»¶èƒ½æ‰§è¡Œ

## 5ï¸âƒ£ keep-alive

- **ä½œç”¨**ï¼šç¼“å­˜ç»„ä»¶ï¼Œé¿å…é‡å¤æ¸²æŸ“
- **ç¼“å­˜æœºåˆ¶**ï¼š`cache` å¯¹è±¡ + `keys` é˜Ÿåˆ—
- **é’©å­**ï¼š`activated` / `deactivated`
- **åŸç†**ï¼šåŸºäº VNode èŠ‚ç‚¹ç¼“å­˜ç»„ä»¶å®ä¾‹
- **æºç æ ¸å¿ƒç‚¹**ï¼š`pruneCacheEntry` æ¸…ç†ç¼“å­˜ï¼Œç›‘å¬ `include/exclude` åŠ¨æ€è°ƒæ•´ç¼“å­˜
- **æ³¨æ„**ï¼šå¤šå±‚åµŒå¥—è·¯ç”±æ—¶ï¼Œéœ€æ¯å±‚ `router-view` åŒ…è£¹ `keep-alive`

â€‹	**æºç æ ¸å¿ƒ**ï¼š

- é€šè¿‡ key æ ‡è®°ç»„ä»¶å®ä¾‹
- å‘½ä¸­ç¼“å­˜ â†’ å¤ç”¨ vnode.componentInstance
- pruneCache æ¸…ç†ä¸æ»¡è¶³ include/exclude çš„ç¼“å­˜

- #### æºç  src/core/components/keep-alive.js

  ```js
  export default {
    name: 'keep-alive',
    abstract: true,
  
    props: {
      include: [String, RegExp, Array],
      exclude: [String, RegExp, Array],
      max: [String, Number]
    },
  
    created () {
      this.cache = Object.create(null)
      this.keys = []
    },
  
    destroyed () {
      for (const key in this.cache) {
        pruneCacheEntry(this.cache, key, this.keys)
      }
    },
  
    mounted () {
      this.$watch('include', val => {
        pruneCache(this, name => matches(val, name))
      })
      this.$watch('exclude', val => {
        pruneCache(this, name => !matches(val, name))
      })
    },
  
    render() {
      /* è·å–é»˜è®¤æ’æ§½ä¸­çš„ç¬¬ä¸€ä¸ªç»„ä»¶èŠ‚ç‚¹ */
      const slot = this.$slots.default
      const vnode = getFirstComponentChild(slot)
      /* è·å–è¯¥ç»„ä»¶èŠ‚ç‚¹çš„componentOptions */
      const componentOptions = vnode && vnode.componentOptions
  
      if (componentOptions) {
        /* è·å–è¯¥ç»„ä»¶èŠ‚ç‚¹çš„åç§°ï¼Œä¼˜å…ˆè·å–ç»„ä»¶çš„nameå­—æ®µï¼Œå¦‚æœnameä¸å­˜åœ¨åˆ™è·å–ç»„ä»¶çš„tag */
        const name = getComponentName(componentOptions)
  
        const { include, exclude } = this
        /* å¦‚æœnameä¸åœ¨inlcudeä¸­æˆ–è€…å­˜åœ¨äºexludeä¸­åˆ™è¡¨ç¤ºä¸ç¼“å­˜ï¼Œç›´æ¥è¿”å›vnode */
        if (
          (include && (!name || !matches(include, name))) ||
          // excluded
          (exclude && name && matches(exclude, name))
        ) {
          return vnode
        }
  
        const { cache, keys } = this
        /* è·å–ç»„ä»¶çš„keyå€¼ */
        const key = vnode.key == null
          // same constructor may get registered as different local components
          // so cid alone is not enough (#3269)
          ? componentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')
          : vnode.key
       /*  æ‹¿åˆ°keyå€¼åå»this.cacheå¯¹è±¡ä¸­å»å¯»æ‰¾æ˜¯å¦æœ‰è¯¥å€¼ï¼Œå¦‚æœæœ‰åˆ™è¡¨ç¤ºè¯¥ç»„ä»¶æœ‰ç¼“å­˜ï¼Œå³å‘½ä¸­ç¼“å­˜ */
        if (cache[key]) {
          vnode.componentInstance = cache[key].componentInstance
          // make current key freshest
          remove(keys, key)
          keys.push(key)
        }
          /* å¦‚æœæ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œåˆ™å°†å…¶è®¾ç½®è¿›ç¼“å­˜ */
          else {
          cache[key] = vnode
          keys.push(key)
          // prune oldest entry
          /* å¦‚æœé…ç½®äº†maxå¹¶ä¸”ç¼“å­˜çš„é•¿åº¦è¶…è¿‡äº†this.maxï¼Œåˆ™ä»ç¼“å­˜ä¸­åˆ é™¤ç¬¬ä¸€ä¸ª */
          if (this.max && keys.length > parseInt(this.max)) {
            pruneCacheEntry(cache, keys[0], keys, this._vnode)
          }
        }
  
        vnode.data.keepAlive = true
      }
      return vnode || (slot && slot[0])
    }
  }
  ```

- #### æºç è§£æ

  - this.cache

    æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦ç¼“å­˜çš„ç»„ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹

    ```js
    this.cache = {
        'key1':'ç»„ä»¶1',
        'key2':'ç»„ä»¶2',
        // ...
    }
    ```

  - pruneCacheEntry

    åœ¨ç»„ä»¶é”€æ¯çš„æ—¶å€™æ‰§è¡ŒpruneCacheEntryå‡½æ•°

    ```js
    function pruneCacheEntry (cache: VNodeCache, key: string, keys: Array<string>, current?: VNode) {
      const cached = cache[key]
      /* åˆ¤æ–­å½“å‰æ²¡æœ‰å¤„äºè¢«æ¸²æŸ“çŠ¶æ€çš„ç»„ä»¶ï¼Œå°†å…¶é”€æ¯*/
      if (cached && (!current || cached.tag !== current.tag)) {
        cached.componentInstance.$destroy()
      }
      cache[key] = null
      remove(keys, key)
    }
    ```

  - ç›‘å¬include & excludeå˜åŒ–

    ```js
    mounted () {
        this.$watch('include', val => {
            pruneCache(this, name => matches(val, name))
        })
        this.$watch('exclude', val => {
            pruneCache(this, name => !matches(val, name))
        })
    }
    ```

    å¦‚æœincludeæˆ–excludeå‘ç”Ÿå˜åŒ–ï¼Œå³è¡¨ç¤ºå®šä¹‰ï¼ˆä¸ï¼‰éœ€è¦ç¼“å­˜çš„ç»„ä»¶çš„è§„åˆ™å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ‰§è¡ŒpruneCacheå‡½æ•°

    ```js
    function pruneCache (keepAliveInstance, filter) {
      const { cache, keys, _vnode } = keepAliveInstance
      for (const key in cache) {
        const cachedNode = cache[key]
        if (cachedNode) {
          const name = getComponentName(cachedNode.componentOptions)
          if (name && !filter(name)) {
            pruneCacheEntry(cache, key, keys, _vnode)
          }
        }
      }
    }
    ```


### è·¯ç”±vue-router

- **å®ˆå«ç±»å‹**ï¼š
  - å…¨å±€ï¼š`beforeEach`ã€`afterEach`
  - è·¯ç”±ï¼š`beforeEnter`
  - ç»„ä»¶ï¼š`beforeRouteEnter`ã€`beforeRouteUpdate`ã€`beforeRouteLeave`

- **æ¨¡å¼**ï¼š

- hash â†’ ç›‘å¬ `hashchange`
- history â†’ `pushState/replaceState` + `popState`ï¼Œéœ€ Nginx `try_files`
- abstract â†’ Node ç¯å¢ƒ

- **keep-alive é…åˆè·¯ç”±**ï¼š
   å¤šçº§åµŒå¥—éœ€æ¯å±‚ router-view åŒ…è£¹ keep-aliveã€‚

- è·¯ç”±æ‡’åŠ è½½
  ä¸ºä»€ä¹ˆä¼šæ›´å¿« åˆ†åŒ…
- keep-alive
  - ä½œç”¨
    å®ç°ç»„ä»¶ç¼“å­˜ï¼Œä¿å­˜è¿™äº›ç»„ä»¶çš„çŠ¶æ€ï¼Œé¿å…åå¤æ¸²æŸ“ï¼›
  - ç”Ÿå‘½å‘¨æœŸï¼šactivatedï¼Œdeactivated
    é¡µé¢ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œé’©å­çš„è§¦å‘é¡ºåºcreated-> mounted-> activatedï¼›
    é€€å‡ºæ—¶è§¦å‘deactivatedï¼›
    å½“å†æ¬¡è¿›å…¥ï¼ˆå‰è¿›æˆ–è€…åé€€ï¼‰æ—¶ï¼Œåªè§¦å‘activated

  - åŸç†
    vueå†…éƒ¨å°†domèŠ‚ç‚¹æŠ½è±¡æˆä¸€ä¸ªä¸ªVNodeèŠ‚ç‚¹ï¼›keep-aliveç»„ä»¶çš„ç¼“å­˜ä¹Ÿæ˜¯åŸºäºVNodeèŠ‚ç‚¹ï¼›
    å®ƒå°†æ»¡è¶³æ¡ä»¶ï¼ˆpruneCacheï¼‰çš„ç»„ä»¶åœ¨cacheå¯¹è±¡ä¸­ç¼“å­˜èµ·æ¥ï¼›
    åœ¨éœ€è¦é‡æ–°æ¸²æŸ“çš„æ—¶å€™å†å°†VNodeèŠ‚ç‚¹ä»cacheå¯¹è±¡ä¸­å–å‡ºå¹¶æ¸²æŸ“ï¼›
  - è¸©å‘
    - å¤šçº§è·¯ç”±åµŒå¥—ï¼Œåªç¼“å­˜åˆ°äºŒçº§ï¼Œåé¢å‡ å±‚router-viewä¸­çš„ç»„ä»¶ç¼“å­˜ä¼šå‡ºç°é—®é¢˜
      è§£å†³ï¼šæ¯æ¬¡çš„router-viewéƒ½åŒ…è£¹ä¸€å±‚keep-alive
